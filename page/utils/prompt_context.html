<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">Prompt Context</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/fontawesome/css/all.min.css" />
    <style>
      :root {
        --bg-color: #1a1a1a;
        --text-color: #f0f0f0;
        --card-bg-color: #2a2a2a;
        --border-color: #444;
        --accent-color: #0d6efd;
      }

      html[data-theme='light'] {
        --bg-color: #f8f9fa;
        --text-color: #212529;
        --card-bg-color: #fff;
        --border-color: #dee2e6;
        --accent-color: #0d6efd;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
      }

      .container-fluid {
        padding-top: 20px;
        padding-bottom: 20px;
        flex: 1;
      }

      .card {
        background-color: var(--card-bg-color);
        border-color: var(--border-color);
      }

      .card-header {
        border-bottom-color: var(--border-color);
      }

      .navbar-brand,
      .form-label {
        color: var(--text-color);
      }

      .form-control {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .form-control:focus,
      .form-select:focus {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }

      .form-select {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .help-text {
        color: #aaa;
        font-size: 0.9rem;
      }

      textarea.form-control {
        resize: vertical;
      }

      .mono {
        font-family: 'Courier New', Courier, monospace;
      }

      .result-cards-container {
        max-height: 70vh;
        overflow-y: auto;
      }

      .result-card {
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .result-card pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        color: var(--text-color);
        font-size: 0.85rem;
      }

      .result-card .context-badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
      }

      .context-badge-1 {
        background-color: rgba(13, 110, 253, 0.2);
        color: #6ea8fe;
        border: 1px solid rgba(13, 110, 253, 0.4);
      }

      .context-badge-2 {
        background-color: rgba(25, 135, 84, 0.2);
        color: #75b798;
        border: 1px solid rgba(25, 135, 84, 0.4);
      }

      .context-badge-3 {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffda6a;
        border: 1px solid rgba(255, 193, 7, 0.4);
      }

      .copy-time-label {
        font-size: 0.75rem;
        color: #aaa;
      }

      .context-appended {
        border-left: 3px solid var(--accent-color);
        padding-left: 0.5rem;
        margin-top: 0.5rem;
        opacity: 0.85;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg" style="background-color: var(--card-bg-color); border-bottom: 1px solid var(--border-color)">
      <div class="container-fluid">
        <a class="navbar-brand" href="#" data-i18n="title">Prompt Context</a>
        <div class="d-flex ms-auto gap-2 align-items-center">
          <select id="lang-switcher" class="form-select form-select-sm" style="width: auto;">
            <option value="en">English</option>
            <option value="pt">Português</option>
            <option value="ja">日本語</option>
          </select>
          <select id="storage-select" class="form-select form-select-sm" style="background-color: var(--card-bg-color); color: var(--text-color); border-color: var(--border-color); min-width: 150px;">
          </select>
          <button id="copy-all-btn" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="copyAllBtn" title="Copy all results">
            <i class="fas fa-clipboard-list"></i>
          </button>
          <button id="clear-btn" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="clearBtn" title="Clear">
            <i class="fas fa-eraser"></i>
          </button>
          <button id="theme-switcher" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="themeBtn" title="Toggle theme">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-xl-11 col-lg-12">

          <!-- Storage scope label -->
          <div class="help-text mb-3" id="storage-scope"></div>

          <!-- 3 Context Cards -->
          <div class="row g-3 row-cols-1 row-cols-md-3 mb-4">
            <div class="col">
              <div class="card">
                <div class="card-header"><strong data-i18n="context1Label">Context 1</strong></div>
                <div class="card-body">
                  <label class="form-label small" data-i18n="termsLabel">Terms (comma-separated)</label>
                  <input type="text" id="terms1" class="form-control mono mb-2" data-i18n-placeholder="termsPlaceholder" placeholder="react, vue, angular" />
                  <label class="form-label small" data-i18n="contextTextLabel">Context text</label>
                  <textarea id="context1" class="form-control mono" rows="4" data-i18n-placeholder="contextPlaceholder" placeholder="Text to append when a term matches..."></textarea>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-header"><strong data-i18n="context2Label">Context 2</strong></div>
                <div class="card-body">
                  <label class="form-label small" data-i18n="termsLabel">Terms (comma-separated)</label>
                  <input type="text" id="terms2" class="form-control mono mb-2" data-i18n-placeholder="termsPlaceholder" placeholder="react, vue, angular" />
                  <label class="form-label small" data-i18n="contextTextLabel">Context text</label>
                  <textarea id="context2" class="form-control mono" rows="4" data-i18n-placeholder="contextPlaceholder" placeholder="Text to append when a term matches..."></textarea>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-header"><strong data-i18n="context3Label">Context 3</strong></div>
                <div class="card-body">
                  <label class="form-label small" data-i18n="termsLabel">Terms (comma-separated)</label>
                  <input type="text" id="terms3" class="form-control mono mb-2" data-i18n-placeholder="termsPlaceholder" placeholder="react, vue, angular" />
                  <label class="form-label small" data-i18n="contextTextLabel">Context text</label>
                  <textarea id="context3" class="form-control mono" rows="4" data-i18n-placeholder="contextPlaceholder" placeholder="Text to append when a term matches..."></textarea>
                </div>
              </div>
            </div>
          </div>

          <hr class="my-3" />

          <!-- Bottom: Source + Results -->
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" data-i18n="sourceLabel">Source Text</label>
              <div class="help-text mb-1" data-i18n="sourceHelp">Separate sections with --- . Lines starting with # are hidden in results.</div>
              <textarea id="source-text" class="form-control mono" rows="20" data-i18n-placeholder="sourcePlaceholder" placeholder="First section text...&#10;---&#10;Second section text...&#10;# this line is hidden&#10;---&#10;Third section..."></textarea>
            </div>
            <div class="col-md-6">
              <div class="d-flex align-items-center justify-content-between mb-1">
                <label class="form-label mb-0" data-i18n="resultsLabel">Results</label>
                <span class="help-text"><span id="card-count">0</span> <span data-i18n="cardsText">cards</span></span>
              </div>
              <div id="results-container" class="result-cards-container">
                <div class="text-muted text-center py-4" data-i18n="noResults">No results yet</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const i18n = {
        en: {
          title: "Prompt Context",
          context1Label: "Context 1",
          context2Label: "Context 2",
          context3Label: "Context 3",
          termsLabel: "Terms (comma-separated)",
          termsPlaceholder: "react, vue, angular",
          contextTextLabel: "Context text",
          contextPlaceholder: "Text to append when a term matches...",
          sourceLabel: "Source Text",
          sourceHelp: "Separate sections with --- . Lines starting with # are hidden in results.",
          sourcePlaceholder: "First section text...\n---\nSecond section text...\n# this line is hidden\n---\nThird section...",
          resultsLabel: "Results",
          cardsText: "cards",
          noResults: "No results yet",
          copyBtn: "Copy",
          copiedAt: "Copied at",
          clearBtn: "Clear",
          themeBtn: "Toggle theme",
          storageText: "storage",
          matchedContexts: "Matched contexts",
          copyAllBtn: "Copy all results"
        },
        pt: {
          title: "Prompt Contexto",
          context1Label: "Contexto 1",
          context2Label: "Contexto 2",
          context3Label: "Contexto 3",
          termsLabel: "Termos (separados por vírgula)",
          termsPlaceholder: "react, vue, angular",
          contextTextLabel: "Texto do contexto",
          contextPlaceholder: "Texto a adicionar quando um termo combinar...",
          sourceLabel: "Texto Fonte",
          sourceHelp: "Separe seções com --- . Linhas começando com # ficam ocultas nos resultados.",
          sourcePlaceholder: "Texto da primeira seção...\n---\nTexto da segunda seção...\n# esta linha fica oculta\n---\nTerceira seção...",
          resultsLabel: "Resultados",
          cardsText: "cards",
          noResults: "Nenhum resultado ainda",
          copyBtn: "Copiar",
          copiedAt: "Copiado às",
          clearBtn: "Limpar",
          themeBtn: "Alternar tema",
          storageText: "armazenamento",
          matchedContexts: "Contextos combinados",
          copyAllBtn: "Copiar todos os resultados"
        },
        ja: {
          title: "プロンプトコンテキスト",
          context1Label: "コンテキスト 1",
          context2Label: "コンテキスト 2",
          context3Label: "コンテキスト 3",
          termsLabel: "用語（カンマ区切り）",
          termsPlaceholder: "react, vue, angular",
          contextTextLabel: "コンテキストテキスト",
          contextPlaceholder: "用語が一致した時に追加するテキスト...",
          sourceLabel: "ソーステキスト",
          sourceHelp: "--- でセクションを区切ります。# で始まる行は結果に表示されません。",
          sourcePlaceholder: "最初のセクション...\n---\n2番目のセクション...\n# この行は非表示\n---\n3番目のセクション...",
          resultsLabel: "結果",
          cardsText: "カード",
          noResults: "まだ結果がありません",
          copyBtn: "コピー",
          copiedAt: "コピー時刻",
          clearBtn: "クリア",
          themeBtn: "テーマを切り替え",
          storageText: "ストレージ",
          matchedContexts: "一致したコンテキスト",
          copyAllBtn: "全結果をコピー"
        }
      };

      document.addEventListener('DOMContentLoaded', () => {
        // Elements
        const langSwitcher = document.getElementById('lang-switcher');
        const themeSwitcher = document.getElementById('theme-switcher');
        const clearBtn = document.getElementById('clear-btn');
        const copyAllBtn = document.getElementById('copy-all-btn');
        const storageScopeEl = document.getElementById('storage-scope');
        const storageSelectEl = document.getElementById('storage-select');
        const sourceTextEl = document.getElementById('source-text');
        const resultsContainer = document.getElementById('results-container');
        const cardCountEl = document.getElementById('card-count');

        const termsEls = [document.getElementById('terms1'), document.getElementById('terms2'), document.getElementById('terms3')];
        const contextEls = [document.getElementById('context1'), document.getElementById('context2'), document.getElementById('context3')];

        // Language
        let currentLanguage = localStorage.getItem('app_lang') || 'en';
        const applyI18n = () => {
          const lang = i18n[currentLanguage] || i18n.en;
          document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (lang[key]) el.innerText = lang[key];
          });
          document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (lang[key]) el.placeholder = lang[key];
          });
          document.querySelectorAll('[data-i18n-title]').forEach(el => {
            const key = el.getAttribute('data-i18n-title');
            if (lang[key]) el.title = lang[key];
          });
          document.title = lang.title;
        };

        // Theme
        let currentTheme = localStorage.getItem('app_theme') || 'dark';
        const applyTheme = (theme) => {
          document.documentElement.setAttribute('data-theme', theme);
          const icon = themeSwitcher.querySelector('i');
          icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
          localStorage.setItem('app_theme', theme);
        };

        // Storage prefix from hash
        const getPrefix = () => {
          const h = String(location.hash || '').replace(/^#/, '').trim();
          return h ? h : 'default';
        };

        const updateStorageScopeText = () => {
          const prefix = getPrefix();
          const lang = i18n[currentLanguage] || i18n.en;
          storageScopeEl.textContent = `${lang.storageText}: ${prefix}`;
          document.title = `${lang.title} - ${prefix}`;
        };

        // ---- IndexedDB ----
        const DB_NAME = 'prompt_context_db';
        const STORE_NAME = 'data';
        let db = null;

        const openDB = () => {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 2);
            request.onupgradeneeded = (e) => {
              const database = e.target.result;
              if (!database.objectStoreNames.contains(STORE_NAME)) {
                database.createObjectStore(STORE_NAME);
              }
            };
            request.onsuccess = (e) => {
              db = e.target.result;
              resolve(db);
            };
            request.onerror = (e) => reject(e.target.error);
          });
        };

        const dbGet = (key) => {
          return new Promise((resolve, reject) => {
            if (!db) { resolve(null); return; }
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.get(key);
            req.onsuccess = () => resolve(req.result === undefined ? null : req.result);
            req.onerror = () => resolve(null);
          });
        };

        const dbPut = (key, value) => {
          return new Promise((resolve, reject) => {
            if (!db) { resolve(); return; }
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.put(value, key);
            tx.oncomplete = () => resolve();
            tx.onerror = () => resolve();
          });
        };

        const dbGetAllKeys = () => {
          return new Promise((resolve) => {
            if (!db) { resolve([]); return; }
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.getAllKeys();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = () => resolve([]);
          });
        };

        const keyFor = (field) => `${getPrefix()}:${field}`;

        // List all storage prefixes from IndexedDB keys
        const getAllStorages = async () => {
          const keys = await dbGetAllKeys();
          const prefixes = new Set(['default']);
          keys.forEach(k => {
            const parts = String(k).split(':');
            if (parts.length >= 2) {
              prefixes.add(parts[0]);
            }
          });
          return Array.from(prefixes).sort();
        };

        const updateStorageSelect = async () => {
          const storages = await getAllStorages();
          const currentPrefix = getPrefix();
          storageSelectEl.innerHTML = '';
          storages.forEach((storage) => {
            const option = document.createElement('option');
            option.value = storage;
            option.textContent = storage;
            if (storage === currentPrefix) option.selected = true;
            storageSelectEl.appendChild(option);
          });
        };

        // Copy times stored per prefix
        let copyTimes = {};

        const loadCopyTimes = async () => {
          const raw = await dbGet(keyFor('copy_times'));
          try {
            copyTimes = raw ? JSON.parse(raw) : {};
          } catch {
            copyTimes = {};
          }
        };

        const saveCopyTimes = async () => {
          await dbPut(keyFor('copy_times'), JSON.stringify(copyTimes));
        };

        // Collapse states stored per prefix
        let collapseStates = {};

        const loadCollapseStates = async () => {
          const raw = await dbGet(keyFor('collapse_states'));
          try {
            collapseStates = raw ? JSON.parse(raw) : {};
          } catch {
            collapseStates = {};
          }
        };

        const saveCollapseStates = async () => {
          await dbPut(keyFor('collapse_states'), JSON.stringify(collapseStates));
        };

        // Save / Load
        const saveAll = async () => {
          const prefix = getPrefix();
          await Promise.all([
            dbPut(keyFor('terms1'), termsEls[0].value),
            dbPut(keyFor('terms2'), termsEls[1].value),
            dbPut(keyFor('terms3'), termsEls[2].value),
            dbPut(keyFor('context1'), contextEls[0].value),
            dbPut(keyFor('context2'), contextEls[1].value),
            dbPut(keyFor('context3'), contextEls[2].value),
            dbPut(keyFor('source_text'), sourceTextEl.value),
          ]);
        };

        const loadAll = async () => {
          const fields = ['terms1', 'terms2', 'terms3', 'context1', 'context2', 'context3', 'source_text'];
          const values = await Promise.all(fields.map(f => dbGet(keyFor(f))));
          termsEls[0].value = values[0] || '';
          termsEls[1].value = values[1] || '';
          termsEls[2].value = values[2] || '';
          contextEls[0].value = values[3] || '';
          contextEls[1].value = values[4] || '';
          contextEls[2].value = values[5] || '';
          sourceTextEl.value = values[6] || '';
          await loadCopyTimes();
          await loadCollapseStates();
        };

        // Term matching
        const getTerms = (idx) => {
          const raw = String(termsEls[idx].value || '');
          return raw.split(',').map(t => t.trim().toLowerCase()).filter(t => t.length > 0);
        };

        // Collected card texts for copy-all
        let allCardTexts = [];

        const render = () => {
          const lang = i18n[currentLanguage] || i18n.en;
          const sourceText = String(sourceTextEl.value || '');
          allCardTexts = [];

          // Split by ---
          const segments = sourceText.split(/^---$/m);

          if (segments.length === 0 || (segments.length === 1 && segments[0].trim() === '')) {
            resultsContainer.innerHTML = `<div class="text-muted text-center py-4" data-i18n="noResults">${lang.noResults}</div>`;
            cardCountEl.textContent = '0';
            return;
          }

          resultsContainer.innerHTML = '';
          let cardIndex = 0;

          segments.forEach((segment) => {
            const rawLines = segment.split(/\r?\n/);
            // Filter out lines starting with #
            const visibleLines = rawLines.filter(line => !line.trimStart().startsWith('#'));
            const cleanedText = visibleLines.join('\n').trim();

            if (cleanedText === '') return;

            const segmentLower = cleanedText.toLowerCase();

            // Check which contexts match
            const matchedContexts = [];
            for (let i = 0; i < 3; i++) {
              const terms = getTerms(i);
              const contextText = String(contextEls[i].value || '').trim();
              if (terms.length === 0 || contextText === '') continue;
              const hasMatch = terms.some(term => segmentLower.includes(term));
              if (hasMatch) {
                matchedContexts.push({ index: i, text: contextText });
              }
            }

            // Build final text for copying (context first, then segment)
            let copyText = '';
            if (matchedContexts.length > 0) {
              matchedContexts.forEach(mc => {
                copyText += mc.text + '\n';
              });
              copyText += '\n';
            }
            copyText += cleanedText;
            copyText = copyText.trimEnd();

            // Create card
            const card = document.createElement('div');
            card.className = 'result-card';

            const currentCardIndex = cardIndex;
            const isCollapsed = collapseStates[`card_${currentCardIndex}`] === true;

            // Card header: first line preview + toggle + copy + time
            const header = document.createElement('div');
            header.className = 'd-flex align-items-center justify-content-between';

            const headerLeft = document.createElement('div');
            headerLeft.className = 'd-flex align-items-center gap-2 flex-grow-1 overflow-hidden';

            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'btn btn-sm btn-outline-secondary';
            toggleBtn.innerHTML = isCollapsed ? '<i class="fas fa-chevron-right"></i>' : '<i class="fas fa-chevron-down"></i>';
            toggleBtn.style.minWidth = '30px';

            // Preview: first visible line
            const firstLine = cleanedText.split('\n')[0] || '';
            const preview = document.createElement('span');
            preview.className = 'text-truncate mono';
            preview.style.fontSize = '0.85rem';
            preview.textContent = firstLine;
            if (!isCollapsed) preview.style.display = 'none';

            headerLeft.appendChild(toggleBtn);
            headerLeft.appendChild(preview);

            // Badges in header
            if (matchedContexts.length > 0) {
              matchedContexts.forEach(mc => {
                const badge = document.createElement('span');
                badge.className = `context-badge context-badge-${mc.index + 1}`;
                badge.textContent = lang[`context${mc.index + 1}Label`] || `Context ${mc.index + 1}`;
                headerLeft.appendChild(badge);
              });
            }

            const headerRight = document.createElement('div');
            headerRight.className = 'd-flex align-items-center gap-2 flex-shrink-0';

            const timeLabel = document.createElement('span');
            timeLabel.className = 'copy-time-label';
            const savedTime = copyTimes[`card_${currentCardIndex}`];
            if (savedTime) {
              timeLabel.textContent = `${lang.copiedAt} ${savedTime}`;
            }

            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-sm btn-outline-primary';
            copyBtn.innerHTML = `<i class="fas fa-copy"></i>`;

            copyBtn.addEventListener('click', async () => {
              try {
                await navigator.clipboard.writeText(copyText);
              } catch {
                const ta = document.createElement('textarea');
                ta.value = copyText;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
              }
              const now = new Date();
              const pad = (n) => String(n).padStart(2, '0');
              const timeStr = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
              copyTimes[`card_${currentCardIndex}`] = timeStr;
              timeLabel.textContent = `${lang.copiedAt} ${timeStr}`;
              await saveCopyTimes();
            });

            headerRight.appendChild(timeLabel);
            headerRight.appendChild(copyBtn);

            header.appendChild(headerLeft);
            header.appendChild(headerRight);
            card.appendChild(header);

            // Collapsible body
            const body = document.createElement('div');
            body.className = 'mt-2';
            if (isCollapsed) body.style.display = 'none';

            // Context text (above main text)
            if (matchedContexts.length > 0) {
              matchedContexts.forEach(mc => {
                const contextDiv = document.createElement('div');
                contextDiv.className = 'context-appended mb-2';
                const contextPre = document.createElement('pre');
                contextPre.textContent = mc.text;
                contextPre.style.fontSize = '0.8rem';
                contextPre.style.opacity = '0.8';
                contextDiv.appendChild(contextPre);
                body.appendChild(contextDiv);
              });
            }

            // Main text
            const pre = document.createElement('pre');
            pre.textContent = cleanedText;
            body.appendChild(pre);

            card.appendChild(body);

            // Toggle collapse
            toggleBtn.addEventListener('click', async () => {
              const nowCollapsed = body.style.display === 'none';
              if (nowCollapsed) {
                body.style.display = '';
                preview.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                delete collapseStates[`card_${currentCardIndex}`];
              } else {
                body.style.display = 'none';
                preview.style.display = '';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                collapseStates[`card_${currentCardIndex}`] = true;
              }
              await saveCollapseStates();
            });

            resultsContainer.appendChild(card);
            allCardTexts.push(copyText);
            cardIndex++;
          });

          cardCountEl.textContent = String(cardIndex);
        };

        // Debounce
        let timer = null;
        const schedule = () => {
          if (timer) clearTimeout(timer);
          timer = setTimeout(async () => {
            await saveAll();
            render();
          }, 200);
        };

        // Events
        langSwitcher.addEventListener('change', (e) => {
          currentLanguage = e.target.value;
          localStorage.setItem('app_lang', currentLanguage);
          applyI18n();
          updateStorageScopeText();
          render();
        });

        themeSwitcher.addEventListener('click', () => {
          currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
          applyTheme(currentTheme);
        });

        copyAllBtn.addEventListener('click', async () => {
          if (allCardTexts.length === 0) return;
          // Each card's text becomes one line: newlines replaced with "; "
          const allLines = allCardTexts.map(t => t.replace(/\r?\n/g, '; '));
          const text = allLines.join('\n');
          try {
            await navigator.clipboard.writeText(text);
          } catch {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          }
        });

        clearBtn.addEventListener('click', async () => {
          termsEls.forEach(el => (el.value = ''));
          contextEls.forEach(el => (el.value = ''));
          sourceTextEl.value = '';
          copyTimes = {};
          collapseStates = {};
          await saveAll();
          await saveCopyTimes();
          await saveCollapseStates();
          render();
        });

        sourceTextEl.addEventListener('input', schedule);
        termsEls.forEach(el => el.addEventListener('input', schedule));
        contextEls.forEach(el => el.addEventListener('input', schedule));

        storageSelectEl.addEventListener('change', () => {
          const selectedStorage = storageSelectEl.value;
          location.hash = selectedStorage === 'default' ? '' : selectedStorage;
        });

        window.addEventListener('hashchange', async () => {
          updateStorageScopeText();
          await updateStorageSelect();
          await loadAll();
          render();
        });

        // Init
        const init = async () => {
          await openDB();
          langSwitcher.value = currentLanguage;
          applyI18n();
          applyTheme(currentTheme);
          updateStorageScopeText();
          await updateStorageSelect();
          await loadAll();
          render();
        };

        init().catch(console.error);
      });
    </script>
  </body>
</html>
