<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">Test Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/fontawesome/css/all.min.css" />
    <style>
      :root {
        --bg-color: #1a1a1a;
        --text-color: #f0f0f0;
        --card-bg-color: #2a2a2a;
        --border-color: #444;
        --accent-color: #0d6efd;
        --hover-color: #3a3a3a;
        --selected-color: #0d6efd33;
      }

      html[data-theme='light'] {
        --bg-color: #f8f9fa;
        --text-color: #212529;
        --card-bg-color: #fff;
        --border-color: #dee2e6;
        --accent-color: #0d6efd;
        --hover-color: #e9ecef;
        --selected-color: #0d6efd22;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; }
      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      }

      .navbar {
        background-color: var(--card-bg-color);
        border-bottom: 1px solid var(--border-color);
        padding: 0.5rem 1rem;
      }
      .navbar-brand { color: var(--text-color); font-weight: 600; }
      .form-control, .form-select {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--border-color);
      }
      .form-control:focus, .form-select:focus {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }
      .form-control::placeholder { color: var(--text-color); opacity: 0.5; }

      .main-container { flex: 1; display: flex; overflow: hidden; }

      .nav-column {
        display: flex;
        flex-direction: column;
        min-width: 180px;
        max-width: 250px;
        width: 200px;
        background-color: var(--card-bg-color);
        border-right: 1px solid var(--border-color);
        transition: width 0.3s ease, min-width 0.3s ease;
        overflow: hidden;
      }
      .nav-column.collapsed { min-width: 42px; width: 42px; }
      .nav-column.collapsed .column-content,
      .nav-column.collapsed .column-title-text,
      .nav-column.collapsed .add-btn-text { display: none; }
      .nav-column.collapsed .column-header { justify-content: center; padding: 0.5rem; }
      .nav-column.collapsed .collapse-btn { transform: rotate(180deg); }

      .column-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bg-color);
        min-height: 42px;
      }
      .column-title { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; font-size: 0.9rem; }
      .collapse-btn {
        background: none; border: none; color: var(--text-color);
        cursor: pointer; padding: 0.25rem; opacity: 0.7;
        transition: opacity 0.2s, transform 0.3s;
      }
      .collapse-btn:hover { opacity: 1; }
      .column-content { flex: 1; overflow-y: auto; padding: 0.5rem; }

      .item-list { list-style: none; padding: 0; margin: 0; }
      .item-list li {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 2px;
        transition: background-color 0.15s;
      }
      .item-list li:hover { background-color: var(--hover-color); }
      .item-list li.selected { background-color: var(--selected-color); border: 1px solid var(--accent-color); }
      .item-list li .item-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .item-list li .item-actions { display: none; gap: 0.25rem; }
      .item-list li:hover .item-actions { display: flex; }
      .item-actions button {
        background: none; border: none; color: var(--text-color);
        cursor: pointer; padding: 0.15rem 0.3rem; opacity: 0.6; font-size: 0.75rem;
      }
      .item-actions button:hover { opacity: 1; }
      .item-list li .question-id { font-size: 0.75rem; opacity: 0.8; margin-right: 0.25rem; }
      .item-list li .item-name.draft { opacity: 0.7; }
      .item-list li .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-right: 0.35rem; }
      .item-list li .status-dot.ready { background: #28a745; }
      .item-list li .status-dot.draft { background: #ffc107; }
      .item-list li .status-dot.disabled { background: #dc3545; }

      .add-item-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.5rem;
        margin-top: 0.5rem;
        background-color: transparent;
        border: 1px dashed var(--border-color);
        border-radius: 6px;
        color: var(--text-color);
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s, border-color 0.2s;
      }
      .add-item-btn:hover { opacity: 1; border-color: var(--accent-color); }

      .content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
      .content-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--card-bg-color);
        min-height: 50px;
      }
      .content-path { font-size: 0.85rem; color: var(--text-color); opacity: 0.7; }
      .content-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 1rem;
        overflow: auto;
      }

      .no-selection {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-color);
        opacity: 0.5;
        text-align: center;
      }
      .no-selection i { font-size: 3rem; margin-bottom: 1rem; }

      /* Test actions panel */
      .test-actions-panel { max-width: 600px; }
      .test-actions-panel .btn { margin-right: 0.5rem; margin-bottom: 0.5rem; }
      .test-actions-group { margin-bottom: 1.5rem; }
      .test-actions-group h6 { margin-bottom: 0.5rem; opacity: 0.9; }

      /* Question form */
      .question-form { display: flex; flex-direction: column; gap: 1rem; max-width: 800px; }
      .question-form .form-group label { display: block; margin-bottom: 0.25rem; font-size: 0.9rem; }
      .question-form textarea.form-control { min-height: auto; }
      .question-form .question-text { rows: 3; }
      .question-form .option-text { min-height: 4em; }
      .question-form .option-row {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: var(--bg-color);
        border-radius: 6px;
        border: 1px solid var(--border-color);
      }
      .question-form .option-row .option-fields { flex: 1; display: flex; flex-direction: column; gap: 0.25rem; }
      .question-form .option-row .option-correct { margin-top: 0.25rem; }
      .question-form .add-option-btn { align-self: flex-start; }
      .save-status { font-size: 0.75rem; opacity: 0.6; }
      .save-status.saving { color: #ffc107; }
      .save-status.saved { color: #28a745; }

      .modal-content { background-color: var(--card-bg-color); color: var(--text-color); border-color: var(--border-color); }
      .modal-header { border-bottom-color: var(--border-color); }
      .modal-footer { border-top-color: var(--border-color); }
      .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
      html[data-theme='light'] .btn-close { filter: none; }
      .search-result-item {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: background-color 0.15s;
      }
      .search-result-item:hover { background-color: var(--hover-color); }
      .search-result-path { font-size: 0.8rem; color: var(--accent-color); margin-bottom: 0.25rem; }
      .search-result-preview { font-size: 0.85rem; opacity: 0.8; }
      .search-result-preview mark { background-color: #ffc107; color: #000; padding: 0 2px; border-radius: 2px; }
      .empty-state { text-align: center; padding: 2rem; color: var(--text-color); opacity: 0.5; }
      #export-css-textarea, #export-template-textarea { font-family: monospace; font-size: 0.85rem; min-height: 200px; }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="#" data-i18n="title">Test Builder</a>
        <div class="d-flex ms-auto gap-2 align-items-center flex-wrap">
          <div class="input-group input-group-sm" style="width: 200px;">
            <span class="input-group-text" style="background-color: var(--card-bg-color); border-color: var(--border-color); color: var(--text-color);">
              <i class="fas fa-search"></i>
            </span>
            <input type="text" id="search-input" class="form-control form-control-sm" data-i18n-placeholder="searchPlaceholder" placeholder="Search..." />
          </div>
          <select id="search-scope" class="form-select form-select-sm" style="width: auto; max-width: 140px;">
            <option value="test" data-i18n="scopeTest">This test</option>
            <option value="project" data-i18n="scopeProject">This project</option>
            <option value="all" data-i18n="scopeAll">All</option>
          </select>
          <select id="lang-switcher" class="form-select form-select-sm" style="width: auto;">
            <option value="en">English</option>
            <option value="pt">Português</option>
            <option value="ja">日本語</option>
          </select>
          <button id="theme-switcher" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="themeBtn" title="Toggle theme">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </div>
    </nav>

    <div class="main-container">
      <div class="nav-column" id="projects-column">
        <div class="column-header">
          <div class="column-title">
            <i class="fas fa-folder"></i>
            <span class="column-title-text" data-i18n="projects">Projects</span>
          </div>
          <button class="collapse-btn" data-target="projects-column" title="Toggle"><i class="fas fa-chevron-left"></i></button>
        </div>
        <div class="column-content">
          <ul class="item-list" id="projects-list"></ul>
          <button class="add-item-btn" id="add-project-btn">
            <i class="fas fa-plus"></i>
            <span class="add-btn-text" data-i18n="addProject">Add Project</span>
          </button>
        </div>
      </div>

      <div class="nav-column" id="tests-column">
        <div class="column-header">
          <div class="column-title">
            <i class="fas fa-list-alt"></i>
            <span class="column-title-text" data-i18n="tests">Tests</span>
          </div>
          <button class="collapse-btn" data-target="tests-column" title="Toggle"><i class="fas fa-chevron-left"></i></button>
        </div>
        <div class="column-content">
          <ul class="item-list" id="tests-list"></ul>
          <button class="add-item-btn" id="add-test-btn" style="display: none;">
            <i class="fas fa-plus"></i>
            <span class="add-btn-text" data-i18n="addTest">Add Test</span>
          </button>
        </div>
      </div>

      <div class="nav-column" id="sections-column">
        <div class="column-header">
          <div class="column-title">
            <i class="fas fa-layer-group"></i>
            <span class="column-title-text" data-i18n="sections">Sections</span>
          </div>
          <button class="collapse-btn" data-target="sections-column" title="Toggle"><i class="fas fa-chevron-left"></i></button>
        </div>
        <div class="column-content">
          <ul class="item-list" id="sections-list"></ul>
          <button class="add-item-btn" id="add-section-btn" style="display: none;">
            <i class="fas fa-plus"></i>
            <span class="add-btn-text" data-i18n="addSection">Add Section</span>
          </button>
        </div>
      </div>

      <div class="nav-column" id="questions-column">
        <div class="column-header">
          <div class="column-title">
            <i class="fas fa-question-circle"></i>
            <span class="column-title-text" data-i18n="questions">Questions</span>
          </div>
          <button class="collapse-btn" data-target="questions-column" title="Toggle"><i class="fas fa-chevron-left"></i></button>
        </div>
        <div class="column-content">
          <ul class="item-list" id="questions-list"></ul>
          <button class="add-item-btn" id="add-question-btn" style="display: none;">
            <i class="fas fa-plus"></i>
            <span class="add-btn-text" data-i18n="addQuestion">Add Question</span>
          </button>
        </div>
      </div>

      <div class="content-area">
        <div class="content-header">
          <div class="content-path" id="content-path"></div>
          <div class="save-status" id="save-status"></div>
        </div>
        <div class="content-body">
          <div class="no-selection" id="no-selection">
            <i class="fas fa-question-circle"></i>
            <p data-i18n="selectQuestion">Select a project, test, and question</p>
          </div>
          <div id="test-actions-panel" class="test-actions-panel" style="display: none;"></div>
          <div id="question-form-container" class="question-form" style="display: none;"></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="search-modal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" data-i18n="searchResults">Search Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="search-results"></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="export-css-modal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" data-i18n="editExportCss">Edit export CSS</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea id="export-css-textarea" class="form-control"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="close">Close</button>
            <button type="button" class="btn btn-primary" id="export-css-save" data-i18n="save">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="export-template-modal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" data-i18n="editExportTemplate">Edit question HTML template</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="small opacity-75 mb-2" data-i18n="templatePlaceholders">Placeholders: {{questionNumber}}, {{questionId}}, {{questionText}}, {{questionTextSecondary}}, {{optionsHtml}}, {{textAnswerBlock}}, {{externalComment}}</p>
            <textarea id="export-template-textarea" class="form-control"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="close">Close</button>
            <button type="button" class="btn btn-primary" id="export-template-save" data-i18n="save">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ========== i18n ==========
      const i18n = {
        en: {
          title: 'Test Builder',
          projects: 'Projects',
          tests: 'Tests',
          sections: 'Sections',
          questions: 'Questions',
          addProject: 'Add Project',
          addTest: 'Add Test',
          addSection: 'Add Section',
          addQuestion: 'Add Question',
          newSectionName: 'New Section',
          sectionId: 'Section ID (sort)',
          searchPlaceholder: 'Search...',
          scopeTest: 'This test',
          scopeProject: 'This project',
          scopeAll: 'All',
          searchResults: 'Search Results',
          noResults: 'No results found',
          selectQuestion: 'Select a project, test, and question',
          themeBtn: 'Toggle theme',
          confirmDelete: 'Are you sure you want to delete?',
          newProjectName: 'New Project',
          newTestName: 'New Test',
          rename: 'Rename',
          delete: 'Delete',
          enterName: 'Enter name:',
          questionType: 'Question type',
          questionTypeMultipleChoice: 'Multiple choice',
          questionTypeText: 'Text response',
          textAnswerLinesHint: 'Model answer (number of lines = space for student)',
          questionId: 'Question ID',
          questionReady: 'Question ready',
          questionDisabled: 'Disabled',
          questionText: 'Question',
          questionTranslation: 'Translation',
          options: 'Options',
          correct: 'Correct',
          addOption: 'Add option',
          noTranslation: 'No translation',
          singleChoice: 'Single choice',
          internalComment: 'Internal comment (not in export with answers)',
          externalComment: 'External comment (for graders)',
          saving: 'Saving...',
          saved: 'Saved',
          exportJson: 'Export JSON',
          importJson: 'Import JSON',
          exportRendered: 'Export rendered',
          exportWithAnswers: 'Export with answers',
          formatTxt: 'TXT',
          formatHtml: 'HTML',
          langPrimary: 'Primary',
          langSecondary: 'Secondary',
          langBilingual: 'Bilingual',
          langOrder: 'Order',
          langFirst: 'Primary first',
          langSecond: 'Secondary first',
          editExportCss: 'Edit export CSS',
          editExportTemplate: 'Edit question HTML template',
          templatePlaceholders: 'Placeholders: {{questionNumber}}, {{questionId}}, {{questionText}}, {{questionTextSecondary}}, {{optionsHtml}}, {{textAnswerBlock}}, {{externalComment}}',
          close: 'Close',
          save: 'Save',
          testActions: 'Test actions',
          moveToSection: 'Move to section',
          moveQuestion: 'Move',
          moveQuestionConfirm: 'Move this question to this section?'
        },
        pt: {
          title: 'Criador de Teste',
          projects: 'Projetos',
          tests: 'Testes',
          sections: 'Seções',
          questions: 'Perguntas',
          addProject: 'Adicionar Projeto',
          addTest: 'Adicionar Teste',
          addSection: 'Adicionar Seção',
          addQuestion: 'Adicionar Pergunta',
          newSectionName: 'Nova Seção',
          sectionId: 'ID da seção (ordem)',
          searchPlaceholder: 'Buscar...',
          scopeTest: 'Neste teste',
          scopeProject: 'Neste projeto',
          scopeAll: 'Tudo',
          searchResults: 'Resultados da Busca',
          noResults: 'Nenhum resultado',
          selectQuestion: 'Selecione projeto, teste e pergunta',
          themeBtn: 'Alternar tema',
          confirmDelete: 'Tem certeza que deseja excluir?',
          newProjectName: 'Novo Projeto',
          newTestName: 'Novo Teste',
          rename: 'Renomear',
          delete: 'Excluir',
          enterName: 'Digite o nome:',
          questionType: 'Tipo de pergunta',
          questionTypeMultipleChoice: 'Múltipla escolha',
          questionTypeText: 'Resposta em texto',
          textAnswerLinesHint: 'Resposta modelo (a quantidade de linhas = espaço para o aluno)',
          questionId: 'ID da pergunta',
          questionReady: 'Pergunta pronta',
          questionDisabled: 'Desabilitada',
          questionText: 'Pergunta',
          questionTranslation: 'Tradução',
          options: 'Opções',
          correct: 'Correta',
          addOption: 'Adicionar opção',
          noTranslation: 'Sem tradução',
          singleChoice: 'Resposta única',
          internalComment: 'Comentário interno (não sai no export com respostas)',
          externalComment: 'Comentário externo (para correção)',
          saving: 'Salvando...',
          saved: 'Salvo',
          exportJson: 'Exportar JSON',
          importJson: 'Importar JSON',
          exportRendered: 'Exportar renderizado',
          exportWithAnswers: 'Exportar com respostas',
          formatTxt: 'TXT',
          formatHtml: 'HTML',
          langPrimary: 'Primário',
          langSecondary: 'Secundário',
          langBilingual: 'Bilíngue',
          langOrder: 'Ordem',
          langFirst: 'Primário em cima',
          langSecond: 'Secundário em cima',
          editExportCss: 'Editar CSS de exportação',
          editExportTemplate: 'Editar template HTML da pergunta',
          templatePlaceholders: 'Placeholders: {{questionNumber}}, {{questionId}}, {{questionText}}, {{questionTextSecondary}}, {{optionsHtml}}, {{textAnswerBlock}}, {{externalComment}}',
          close: 'Fechar',
          save: 'Salvar',
          testActions: 'Ações do teste',
          moveToSection: 'Mover para seção',
          moveQuestion: 'Mover',
          moveQuestionConfirm: 'Mover esta pergunta para esta seção?'
        },
        ja: {
          title: 'クイズビルダー',
          projects: 'プロジェクト',
          tests: 'テスト',
          sections: 'セクション',
          questions: '質問',
          addProject: 'プロジェクト追加',
          addTest: 'テスト追加',
          addSection: 'セクション追加',
          addQuestion: '質問追加',
          newSectionName: '新規セクション',
          sectionId: 'セクションID（並び）',
          searchPlaceholder: '検索...',
          scopeTest: 'このテスト',
          scopeProject: 'このプロジェクト',
          scopeAll: 'すべて',
          searchResults: '検索結果',
          noResults: '結果なし',
          selectQuestion: 'プロジェクト、テスト、質問を選択',
          themeBtn: 'テーマ切替',
          confirmDelete: '削除しますか？',
          newProjectName: '新規プロジェクト',
          newTestName: '新規テスト',
          rename: '名前変更',
          delete: '削除',
          enterName: '名前を入力:',
          questionType: '質問タイプ',
          questionTypeMultipleChoice: '多肢選択',
          questionTypeText: 'テキスト回答',
          textAnswerLinesHint: '模範解答（行数＝生徒用の解答欄の行数）',
          questionId: '質問ID',
          questionReady: '準備完了',
          questionDisabled: '無効',
          questionText: '質問',
          questionTranslation: '翻訳',
          options: '選択肢',
          correct: '正解',
          addOption: '選択肢を追加',
          noTranslation: '翻訳なし',
          singleChoice: '単一選択',
          internalComment: '内部コメント（回答付き出力に含めない）',
          externalComment: '外部コメント（採点用）',
          saving: '保存中...',
          saved: '保存済み',
          exportJson: 'JSON出力',
          importJson: 'JSON入力',
          exportRendered: 'レンダー出力',
          exportWithAnswers: '回答付き出力',
          formatTxt: 'TXT',
          formatHtml: 'HTML',
          langPrimary: '第一',
          langSecondary: '第二',
          langBilingual: '二言語',
          langOrder: '順序',
          langFirst: '第一を上',
          langSecond: '第二を上',
          editExportCss: '出力CSSを編集',
          editExportTemplate: '質問HTMLテンプレートを編集',
          templatePlaceholders: 'プレースホルダー: {{questionNumber}}, {{questionId}}, {{questionText}}, {{questionTextSecondary}}, {{optionsHtml}}, {{textAnswerBlock}}, {{externalComment}}',
          close: '閉じる',
          save: '保存',
          testActions: 'テスト操作',
          moveToSection: 'セクションへ移動',
          moveQuestion: '移動',
          moveQuestionConfirm: 'この質問をこのセクションに移動しますか？'
        }
      };

      const DEFAULT_EXPORT_QUESTION_TEMPLATE = '<div class="question-block">\n  <div class="question-id-line">ID: {{questionId}}</div>\n  <div class="question-text primary-lang">{{questionNumber}} ) {{questionText}}</div>\n  <div class="question-text secondary-lang">{{questionTextSecondary}}</div>\n  <ul class="options-list">{{optionsHtml}}</ul>\n  <div class="text-answer-block">{{textAnswerBlock}}</div>\n  <div class="external-comment">{{externalComment}}</div>\n</div>';

      const DEFAULT_EXPORT_CSS = `body { font-family: sans-serif; margin: 1rem; line-height: 1.5; }
.quiz-title { font-size: 1.25rem; margin-bottom: 1rem; }
.question-block { margin-bottom: 1.5rem; }
.question-text { font-weight: 600; margin-bottom: 0.5rem; }
.options-list { list-style: none; padding-left: 0; }
.options-list li { margin-bottom: 0.35rem; padding-left: 1rem; }
.primary-lang { font-size: 1rem; font-weight: 500; }
.secondary-lang {     font-size: 0.9rem; opacity: 0.75; margin-top: 0.25rem; color: #838383;font-weight: 100; }
.external-comment { margin-top: 0.5rem; font-size: 0.9rem; font-style: italic; }
.correct-option { font-weight: 600; }
.answer-mark { color: blue; }
.text-answer-block { margin-top: 0.5rem; }
.text-answer-line { min-height: 1.5em; border-bottom: 1px solid #ccc; margin-bottom: 0.25rem; }
.text-answer-line.answer-text { color: blue; }
.code { color: #0066aa; font-family: monospace; font-size: 0.95em; }
`;

      // ========== IndexedDB ==========
      const DB_NAME = 'TestBuilderDB';
      const DB_VERSION = 2;
      let db = null;

      const openDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onerror = () => reject(request.error);
          request.onsuccess = () => { db = request.result; resolve(db); };
          request.onupgradeneeded = (event) => {
            const database = event.target.result;
            if (!database.objectStoreNames.contains('projects')) {
              const s = database.createObjectStore('projects', { keyPath: 'id' });
              s.createIndex('order', 'order', { unique: false });
            }
            if (!database.objectStoreNames.contains('tests')) {
              const s = database.createObjectStore('tests', { keyPath: 'id' });
              s.createIndex('projectId', 'projectId', { unique: false });
              s.createIndex('order', 'order', { unique: false });
            }
            if (!database.objectStoreNames.contains('sections')) {
              const s = database.createObjectStore('sections', { keyPath: 'id' });
              s.createIndex('testId', 'testId', { unique: false });
              s.createIndex('order', 'order', { unique: false });
            }
            if (!database.objectStoreNames.contains('questions')) {
              const s = database.createObjectStore('questions', { keyPath: 'id' });
              s.createIndex('testId', 'testId', { unique: false });
              s.createIndex('sectionId', 'sectionId', { unique: false });
              s.createIndex('order', 'order', { unique: false });
            } else {
              try {
                const qStore = event.target.transaction.objectStore('questions');
                if (!qStore.indexNames.contains('sectionId')) qStore.createIndex('sectionId', 'sectionId', { unique: false });
              } catch (e) {}
            }
          };
        });
      };

      const dbAdd = (storeName, data) => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const request = tx.objectStore(storeName).add(data);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };
      const dbPut = (storeName, data) => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const request = tx.objectStore(storeName).put(data);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };
      const dbDelete = (storeName, id) => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const request = tx.objectStore(storeName).delete(id);
          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      };
      const dbGetAll = (storeName) => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readonly');
          const request = tx.objectStore(storeName).getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };
      const dbGetByIndex = (storeName, indexName, value) => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readonly');
          const index = tx.objectStore(storeName).index(indexName);
          const request = index.getAll(value);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };

      // ========== Helpers ==========
      function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      function generateQuestionId() {
        const d = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
      }

      function escapeHtml(str) {
        if (str == null) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function formatTextWithCode(str) {
        if (str == null) return '';
        const s = String(str);
        const parts = s.split('```');
        return parts.map((p, i) => i % 2 === 1 ? '<span class="code">' + escapeHtml(p) + '</span>' : escapeHtml(p)).join('');
      }

      function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      let currentLanguage = localStorage.getItem('app_lang') || 'en';
      let currentTheme = localStorage.getItem('app_theme') || 'dark';

      function t(key) {
        const lang = i18n[currentLanguage] || i18n.en;
        return lang[key] || key;
      }

      function applyI18n() {
        const lang = i18n[currentLanguage] || i18n.en;
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const k = el.getAttribute('data-i18n');
          if (lang[k]) el.textContent = lang[k];
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          const k = el.getAttribute('data-i18n-placeholder');
          if (lang[k]) el.placeholder = lang[k];
        });
        document.querySelectorAll('[data-i18n-title]').forEach(el => {
          const k = el.getAttribute('data-i18n-title');
          if (lang[k]) el.title = lang[k];
        });
        document.title = lang.title || 'Test Builder';
      }

      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        const icon = document.querySelector('#theme-switcher i');
        if (icon) icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        localStorage.setItem('app_theme', theme);
      }

      // ========== State ==========
      let state = {
        selectedProjectId: null,
        selectedTestId: null,
        selectedSectionId: null,
        selectedQuestionId: null,
        projects: [],
        tests: [],
        sections: [],
        questions: []
      };

      const projectsList = document.getElementById('projects-list');
      const testsList = document.getElementById('tests-list');
      const sectionsList = document.getElementById('sections-list');
      const questionsList = document.getElementById('questions-list');
      const addProjectBtn = document.getElementById('add-project-btn');
      const addTestBtn = document.getElementById('add-test-btn');
      const addSectionBtn = document.getElementById('add-section-btn');
      const addQuestionBtn = document.getElementById('add-question-btn');
      const contentPath = document.getElementById('content-path');
      const noSelection = document.getElementById('no-selection');
      const testActionsPanel = document.getElementById('test-actions-panel');
      const questionFormContainer = document.getElementById('question-form-container');
      const saveStatus = document.getElementById('save-status');
      const searchModal = new bootstrap.Modal(document.getElementById('search-modal'));
      const searchResultsEl = document.getElementById('search-results');
      const exportCssModal = new bootstrap.Modal(document.getElementById('export-css-modal'));
      const exportCssTextarea = document.getElementById('export-css-textarea');
      const exportTemplateModal = new bootstrap.Modal(document.getElementById('export-template-modal'));
      const exportTemplateTextarea = document.getElementById('export-template-textarea');

      // ========== Render ==========
      function renderProjects() {
        projectsList.innerHTML = '';
        const sorted = [...state.projects].sort((a, b) => a.order - b.order);
        sorted.forEach(project => {
          const li = document.createElement('li');
          li.dataset.id = project.id;
          if (project.id === state.selectedProjectId) li.classList.add('selected');
          li.innerHTML = `
            <span class="item-name">${escapeHtml(project.name)}</span>
            <div class="item-actions">
              <button class="rename-btn" title="${t('rename')}"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" title="${t('delete')}"><i class="fas fa-trash"></i></button>
            </div>
          `;
          li.addEventListener('click', (e) => {
            if (!e.target.closest('.item-actions')) selectProject(project.id);
          });
          li.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); renameProject(project.id); });
          li.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteProject(project.id); });
          projectsList.appendChild(li);
        });
      }

      function renderTests() {
        testsList.innerHTML = '';
        const filtered = state.tests.filter(t => t.projectId === state.selectedProjectId);
        const sorted = filtered.sort((a, b) => a.order - b.order);
        addTestBtn.style.display = state.selectedProjectId ? 'flex' : 'none';
        sorted.forEach(test => {
          const li = document.createElement('li');
          li.dataset.id = test.id;
          if (test.id === state.selectedTestId) li.classList.add('selected');
          li.innerHTML = `
            <span class="item-name">${escapeHtml(test.name)}</span>
            <div class="item-actions">
              <button class="rename-btn" title="${t('rename')}"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" title="${t('delete')}"><i class="fas fa-trash"></i></button>
            </div>
          `;
          li.addEventListener('click', (e) => {
            if (!e.target.closest('.item-actions')) selectTest(test.id);
          });
          li.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); renameTest(test.id); });
          li.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteTest(test.id); });
          testsList.appendChild(li);
        });
      }

      function renderSections() {
        sectionsList.innerHTML = '';
        const filtered = state.sections.filter(s => s.testId === state.selectedTestId);
        const sorted = filtered.sort((a, b) => (a.sectionId || '').localeCompare(b.sectionId || '', undefined, { numeric: true }) || (a.order - b.order));
        addSectionBtn.style.display = state.selectedTestId ? 'flex' : 'none';
        sorted.forEach(section => {
          const li = document.createElement('li');
          li.dataset.id = section.id;
          if (section.id === state.selectedSectionId) li.classList.add('selected');
          const count = state.questions.filter(q => q.sectionId === section.id && !q.disabled).length;
          const label = '(' + count + ') ' + (section.sectionId ? section.sectionId + ' — ' : '') + (section.name || '');
          li.innerHTML = `
            <span class="item-name">${escapeHtml(label)}</span>
            <div class="item-actions">
              <button class="rename-btn" title="${t('rename')}"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" title="${t('delete')}"><i class="fas fa-trash"></i></button>
            </div>
          `;
          li.addEventListener('click', (e) => {
            if (!e.target.closest('.item-actions')) selectSection(section.id);
          });
          li.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); renameSection(section.id); });
          li.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteSection(section.id); });
          sectionsList.appendChild(li);
        });
      }

      function renderQuestions() {
        questionsList.innerHTML = '';
        const filtered = state.questions.filter(q => q.testId === state.selectedTestId && q.sectionId === state.selectedSectionId);
        const sorted = filtered.sort((a, b) => (a.questionId || '').localeCompare(b.questionId || ''));
        addQuestionBtn.style.display = state.selectedSectionId ? 'flex' : 'none';
        sorted.forEach(q => {
          const li = document.createElement('li');
          li.dataset.id = q.id;
          if (q.id === state.selectedQuestionId) li.classList.add('selected');
          const ready = q.isReady !== false;
          const disabled = q.disabled === true;
          const displayId = q.questionId || q.id || '?';
          const dotClass = disabled ? 'disabled' : (ready ? 'ready' : 'draft');
          const dotTitle = disabled ? t('questionDisabled') : (ready ? t('questionReady') : 'Draft');
          li.innerHTML = `
            <span class="status-dot ${dotClass}" title="${dotTitle}"></span>
            <span class="item-name ${ready ? '' : 'draft'}">${escapeHtml(displayId)}</span>
            <div class="item-actions">
              <button class="delete-btn" title="${t('delete')}"><i class="fas fa-trash"></i></button>
            </div>
          `;
          li.addEventListener('click', (e) => {
            if (!e.target.closest('.item-actions')) selectQuestion(q.id);
          });
          li.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteQuestion(q.id); });
          questionsList.appendChild(li);
        });
      }

      function renderContentPath() {
        const project = state.projects.find(p => p.id === state.selectedProjectId);
        const test = state.tests.find(t => t.id === state.selectedTestId);
        const section = state.sections.find(s => s.id === state.selectedSectionId);
        const question = state.questions.find(q => q.id === state.selectedQuestionId);
        if (question && section && test && project) {
          contentPath.innerHTML = `<span>${escapeHtml(project.name)}</span> / <span>${escapeHtml(test.name)}</span> / <span>${escapeHtml(section.name || section.sectionId)}</span> / <strong>${escapeHtml(question.questionId || question.id)}</strong>`;
        } else if (section && test && project) {
          contentPath.innerHTML = `<span>${escapeHtml(project.name)}</span> / <span>${escapeHtml(test.name)}</span> / <strong>${escapeHtml(section.name || section.sectionId)}</strong>`;
        } else if (test && project) {
          contentPath.innerHTML = `<span>${escapeHtml(project.name)}</span> / <strong>${escapeHtml(test.name)}</strong>`;
        } else {
          contentPath.innerHTML = '';
        }
      }

      function renderContent() {
        renderContentPath();
        const question = state.questions.find(q => q.id === state.selectedQuestionId);
        const section = state.sections.find(s => s.id === state.selectedSectionId);
        const test = state.tests.find(t => t.id === state.selectedTestId);

        if (question) {
          noSelection.style.display = 'none';
          testActionsPanel.style.display = 'none';
          questionFormContainer.style.display = 'flex';
          renderQuestionForm(question);
        } else if (section && test) {
          noSelection.style.display = 'flex';
          testActionsPanel.style.display = 'none';
          questionFormContainer.style.display = 'none';
          document.querySelector('#no-selection p').setAttribute('data-i18n', 'selectQuestion');
        } else if (test) {
          noSelection.style.display = 'none';
          questionFormContainer.style.display = 'none';
          testActionsPanel.style.display = 'block';
          renderTestActions(test);
        } else {
          testActionsPanel.style.display = 'none';
          questionFormContainer.style.display = 'none';
          noSelection.style.display = 'flex';
        }
      }

      function renderTestActions(test) {
        const primaryFirst = true;
        testActionsPanel.innerHTML = `
          <h6>${escapeHtml(t('testActions'))}</h6>
          <div class="test-actions-group">
            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-export-json"><i class="fas fa-download"></i> ${t('exportJson')}</button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-import-json"><i class="fas fa-upload"></i> ${t('importJson')}</button>
          </div>
          <div class="test-actions-group">
            <span>${t('exportRendered')}:</span>
            <button type="button" class="btn btn-sm btn-outline-secondary export-rendered-btn" data-format="txt" data-with-answers="false"><i class="fas fa-file-alt"></i> ${t('formatTxt')}</button>
            <button type="button" class="btn btn-sm btn-outline-secondary export-rendered-btn" data-format="html" data-with-answers="false"><i class="fas fa-file-code"></i> ${t('formatHtml')}</button>
          </div>
          <div class="test-actions-group">
            <span>${t('exportWithAnswers')}:</span>
            <button type="button" class="btn btn-sm btn-outline-secondary export-rendered-btn" data-format="txt" data-with-answers="true"><i class="fas fa-file-alt"></i> ${t('formatTxt')}</button>
            <button type="button" class="btn btn-sm btn-outline-secondary export-rendered-btn" data-format="html" data-with-answers="true"><i class="fas fa-file-code"></i> ${t('formatHtml')}</button>
          </div>
          <p class="small opacity-75">${t('langPrimary')} / ${t('langSecondary')} / ${t('langBilingual')}: <select id="export-lang" class="form-select form-select-sm d-inline-block" style="width: auto;">
            <option value="primary">${t('langPrimary')}</option>
            <option value="secondary">${t('langSecondary')}</option>
            <option value="bilingual-primary">${t('langBilingual')} (${t('langFirst')})</option>
            <option value="bilingual-secondary">${t('langBilingual')} (${t('langSecond')})</option>
          </select></p>
          <div class="test-actions-group">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-edit-export-css"><i class="fas fa-palette"></i> ${t('editExportCss')}</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-edit-export-template"><i class="fas fa-code"></i> ${t('editExportTemplate')}</button>
          </div>
        `;
        document.getElementById('btn-export-json').addEventListener('click', () => exportTestJson(test));
        document.getElementById('btn-import-json').addEventListener('click', () => importTestJson(test));
        document.querySelectorAll('.export-rendered-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const format = btn.dataset.format;
            const withAnswers = btn.dataset.withAnswers === 'true';
            const langOpt = document.getElementById('export-lang').value;
            exportRendered(test, format, withAnswers, langOpt);
          });
        });
        document.getElementById('btn-edit-export-css').addEventListener('click', () => {
          exportCssTextarea.value = test.exportCss != null ? test.exportCss : DEFAULT_EXPORT_CSS;
          exportCssModal.show();
          exportCssModal._currentTest = test;
        });
        document.getElementById('btn-edit-export-template').addEventListener('click', () => {
          exportTemplateTextarea.value = (test.exportQuestionHtml != null && test.exportQuestionHtml.trim() !== '') ? test.exportQuestionHtml : DEFAULT_EXPORT_QUESTION_TEMPLATE;
          exportTemplateModal.show();
          exportTemplateModal._currentTest = test;
        });
      }

      document.getElementById('export-template-save').addEventListener('click', () => {
        const test = exportTemplateModal._currentTest;
        if (test) {
          test.exportQuestionHtml = exportTemplateTextarea.value;
          dbPut('tests', test).then(() => {
            const idx = state.tests.findIndex(t => t.id === test.id);
            if (idx >= 0) state.tests[idx] = test;
            exportTemplateModal.hide();
          });
        }
      });

      document.getElementById('export-css-save').addEventListener('click', () => {
        const test = exportCssModal._currentTest;
        if (test) {
          test.exportCss = exportCssTextarea.value;
          dbPut('tests', test).then(() => {
            const idx = state.tests.findIndex(t => t.id === test.id);
            if (idx >= 0) state.tests[idx] = test;
            exportCssModal.hide();
          });
        }
      });

      function renderQuestionForm(question) {
        const qType = question.questionType === 'text' ? 'text' : 'multiple_choice';
        const opts = question.options && question.options.length >= 2 ? question.options : [
          { text: '', translation: '', correct: false, noTranslation: false },
          { text: '', translation: '', correct: false, noTranslation: false }
        ];
        questionFormContainer.innerHTML = `
          <div class="form-group">
            <label>${t('questionType')}</label>
            <select class="form-select" id="q-type">
              <option value="multiple_choice" ${qType === 'multiple_choice' ? 'selected' : ''}>${t('questionTypeMultipleChoice')}</option>
              <option value="text" ${qType === 'text' ? 'selected' : ''}>${t('questionTypeText')}</option>
            </select>
          </div>
          <div class="form-group">
            <label>${t('questionId')}</label>
            <input type="text" class="form-control" id="q-id" value="${escapeHtml(question.questionId || '')}" placeholder="YYYYMMDD-HHmmss" />
          </div>
          <div class="form-group d-flex gap-3 flex-wrap align-items-center">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="q-ready" ${question.isReady !== false ? 'checked' : ''} />
              <label class="form-check-label" for="q-ready">${t('questionReady')}</label>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="q-disabled" ${question.disabled ? 'checked' : ''} />
              <label class="form-check-label" for="q-disabled">${t('questionDisabled')}</label>
            </div>
          </div>
          <div class="form-group">
            <label>${t('questionText')}</label>
            <textarea class="form-control question-text" id="q-text" rows="3">${escapeHtml(question.questionText || '')}</textarea>
          </div>
          <div class="form-group">
            <label>${t('questionTranslation')}</label>
            <textarea class="form-control question-text" id="q-text-trans" rows="3">${escapeHtml(question.questionTranslation || '')}</textarea>
          </div>
          <div id="question-type-multiple" class="form-group" style="display:${qType === 'multiple_choice' ? 'block' : 'none'}">
            <label>${t('options')}</label>
            <div id="options-container"></div>
            <button type="button" class="btn btn-sm btn-outline-secondary add-option-btn">${t('addOption')}</button>
          </div>
          <div id="question-type-single-check" class="form-group form-check" style="display:${qType === 'multiple_choice' ? 'block' : 'none'}">
            <input type="checkbox" class="form-check-input" id="q-single" ${question.singleChoice !== false ? 'checked' : ''} />
            <label class="form-check-label" for="q-single">${t('singleChoice')}</label>
          </div>
          <div id="question-type-text" class="form-group" style="display:${qType === 'text' ? 'block' : 'none'}">
            <label>${t('textAnswerLinesHint')}</label>
            <textarea class="form-control" id="q-text-answer" rows="4" placeholder="">${escapeHtml(question.textAnswerContent || '')}</textarea>
          </div>
          <div class="form-group">
            <label>${t('internalComment')}</label>
            <textarea class="form-control" id="q-internal" rows="2">${escapeHtml(question.internalComment || '')}</textarea>
          </div>
          <div class="form-group">
            <label>${t('externalComment')}</label>
            <textarea class="form-control" id="q-external" rows="2">${escapeHtml(question.externalComment || '')}</textarea>
          </div>
          <div class="form-group border-top pt-3 mt-3">
            <label>${t('moveToSection')}</label>
            <div class="d-flex gap-2 align-items-end flex-wrap">
              <select class="form-select" id="q-move-section" style="max-width: 20rem;">
                <option value="">—</option>
              </select>
              <button type="button" class="btn btn-outline-primary" id="q-move-btn">${t('moveQuestion')}</button>
            </div>
          </div>
        `;
        const moveSectionSelect = document.getElementById('q-move-section');
        const sectionsInTest = state.sections.filter(s => s.testId === state.selectedTestId).sort((a, b) => (a.sectionId || '').localeCompare(b.sectionId || '', undefined, { numeric: true }) || (a.order - b.order));
        sectionsInTest.forEach(sec => {
          const opt = document.createElement('option');
          opt.value = sec.id;
          opt.textContent = (sec.sectionId ? sec.sectionId + ' — ' : '') + (sec.name || t('sections'));
          moveSectionSelect.appendChild(opt);
        });
        document.getElementById('q-move-btn').addEventListener('click', () => {
          const targetSectionId = moveSectionSelect.value;
          if (!targetSectionId) return;
          const targetSection = state.sections.find(s => s.id === targetSectionId);
          const targetName = targetSection ? (targetSection.sectionId ? targetSection.sectionId + ' — ' : '') + (targetSection.name || '') : targetSectionId;
          if (!confirm(t('moveQuestionConfirm') + '\n\n' + targetName)) return;
          const questionId = state.selectedQuestionId;
          const question = state.questions.find(q => q.id === questionId);
          if (!question) return;
          question.sectionId = targetSectionId;
          saveStatus.textContent = t('saving');
          saveStatus.className = 'save-status saving';
          dbPut('questions', question).then(() => {
            const idx = state.questions.findIndex(q => q.id === question.id);
            if (idx >= 0) state.questions[idx] = question;
            state.selectedSectionId = targetSectionId;
            renderSections();
            renderQuestions();
            renderContent();
            saveState();
            saveStatus.textContent = t('saved');
            saveStatus.className = 'save-status saved';
            setTimeout(() => { saveStatus.textContent = ''; }, 2000);
          });
        });
        const container = document.getElementById('options-container');
        opts.forEach((opt, i) => {
          container.appendChild(createOptionRow(i, opt));
        });
        questionFormContainer.querySelector('.add-option-btn').addEventListener('click', () => {
          const newOpt = { text: '', translation: '', correct: false, noTranslation: false };
          container.appendChild(createOptionRow(container.children.length, newOpt));
        });

        const typeSelect = document.getElementById('q-type');
        const multipleBlock = document.getElementById('question-type-multiple');
        const singleCheckBlock = document.getElementById('question-type-single-check');
        const textBlock = document.getElementById('question-type-text');
        function toggleTypeVisibility() {
          const isText = typeSelect.value === 'text';
          multipleBlock.style.display = isText ? 'none' : 'block';
          singleCheckBlock.style.display = isText ? 'none' : 'block';
          textBlock.style.display = isText ? 'block' : 'none';
        }
        typeSelect.addEventListener('change', () => { toggleTypeVisibility(); scheduleSave(); });

        let saveTimeout;
        const scheduleSave = () => {
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(saveQuestion, 500);
        };
        ['input', 'change'].forEach(ev => {
          questionFormContainer.addEventListener(ev, scheduleSave);
        });
      }

      function createOptionRow(index, opt) {
        const noTrans = opt.noTranslation === true;
        const row = document.createElement('div');
        row.className = 'option-row';
        row.innerHTML = `
          <div class="option-fields">
            <textarea class="form-control option-text" rows="3" data-opt-index="${index}" data-opt-field="text" placeholder="">${escapeHtml(opt.text || '')}</textarea>
            <div class="option-translation-wrap" style="display:${noTrans ? 'none' : 'block'}">
              <textarea class="form-control option-text" rows="3" data-opt-index="${index}" data-opt-field="translation" placeholder="${t('questionTranslation')}">${escapeHtml(opt.translation || '')}</textarea>
            </div>
          </div>
          <div class="option-correct">
            <label class="form-check-label small">${t('correct')}</label>
            <input type="checkbox" class="form-check-input" data-opt-field="correct" data-opt-index="${index}" ${opt.correct ? 'checked' : ''} />
            <label class="form-check-label small">${t('noTranslation')}</label>
            <input type="checkbox" class="form-check-input" data-opt-field="noTranslation" data-opt-index="${index}" ${noTrans ? 'checked' : ''} />
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger remove-option-btn" data-opt-index="${index}" title="${t('delete')}"><i class="fas fa-times"></i></button>
        `;
        const noTranslationEl = row.querySelector('[data-opt-field="noTranslation"]');
        const translationWrap = row.querySelector('.option-translation-wrap');
        noTranslationEl.addEventListener('change', () => {
          translationWrap.style.display = noTranslationEl.checked ? 'none' : 'block';
        });
        const removeBtn = row.querySelector('.remove-option-btn');
        removeBtn.addEventListener('click', () => {
          const container = document.getElementById('options-container');
          if (container && container.children.length > 2 && confirm(t('confirmDelete'))) {
            row.remove();
          }
        });
        return row;
      }

      function getQuestionFormData() {
        const questionType = document.getElementById('q-type')?.value === 'text' ? 'text' : 'multiple_choice';
        const opts = [];
        document.querySelectorAll('#options-container .option-row').forEach(row => {
          const textEl = row.querySelector('[data-opt-field="text"]');
          const transEl = row.querySelector('[data-opt-field="translation"]');
          const correctEl = row.querySelector('[data-opt-field="correct"]');
          const noTranslationEl = row.querySelector('[data-opt-field="noTranslation"]');
          opts.push({
            text: textEl ? textEl.value : '',
            translation: transEl ? transEl.value : '',
            correct: correctEl ? correctEl.checked : false,
            noTranslation: noTranslationEl ? noTranslationEl.checked : false
          });
        });
        return {
          questionType,
          questionId: document.getElementById('q-id')?.value?.trim() || '',
          isReady: document.getElementById('q-ready')?.checked !== false,
          disabled: document.getElementById('q-disabled')?.checked === true,
          questionText: document.getElementById('q-text')?.value ?? '',
          questionTranslation: document.getElementById('q-text-trans')?.value ?? '',
          options: opts.length >= 2 ? opts : [{ text: '', translation: '', correct: false, noTranslation: false }, { text: '', translation: '', correct: false, noTranslation: false }],
          singleChoice: document.getElementById('q-single')?.checked !== false,
          textAnswerContent: document.getElementById('q-text-answer')?.value ?? '',
          internalComment: document.getElementById('q-internal')?.value ?? '',
          externalComment: document.getElementById('q-external')?.value ?? ''
        };
      }

      function saveQuestion() {
        const questionId = state.selectedQuestionId;
        if (!questionId) return;
        const question = state.questions.find(q => q.id === questionId);
        if (!question) return;
        const data = getQuestionFormData();
        Object.assign(question, data);
        saveStatus.textContent = t('saving');
        saveStatus.className = 'save-status saving';
        dbPut('questions', question).then(() => {
          const idx = state.questions.findIndex(q => q.id === question.id);
          if (idx >= 0) state.questions[idx] = question;
          saveStatus.textContent = t('saved');
          saveStatus.className = 'save-status saved';
          renderQuestions();
          renderSections();
          setTimeout(() => { saveStatus.textContent = ''; }, 2000);
        });
      }

      // ========== Selection ==========
      function selectProject(projectId) {
        state.selectedProjectId = projectId;
        state.selectedTestId = null;
        state.selectedSectionId = null;
        state.selectedQuestionId = null;
        renderProjects();
        renderTests();
        renderSections();
        renderQuestions();
        renderContent();
        saveState();
      }

      function selectTest(testId) {
        state.selectedTestId = testId;
        state.selectedSectionId = null;
        state.selectedQuestionId = null;
        renderTests();
        renderSections();
        renderQuestions();
        renderContent();
        saveState();
      }

      function selectSection(sectionId) {
        state.selectedSectionId = sectionId;
        state.selectedQuestionId = null;
        renderSections();
        renderQuestions();
        renderContent();
        saveState();
      }

      function selectQuestion(questionId) {
        state.selectedQuestionId = questionId;
        renderQuestions();
        renderContent();
        saveState();
      }

      // ========== CRUD ==========
      async function addProject() {
        const name = prompt(t('enterName'), t('newProjectName'));
        if (!name || !name.trim()) return;
        const project = { id: generateId(), name: name.trim(), order: state.projects.length, createdAt: Date.now() };
        await dbAdd('projects', project);
        state.projects.push(project);
        renderProjects();
        selectProject(project.id);
      }

      async function renameProject(projectId) {
        const project = state.projects.find(p => p.id === projectId);
        if (!project) return;
        const name = prompt(t('enterName'), project.name);
        if (!name || !name.trim()) return;
        project.name = name.trim();
        await dbPut('projects', project);
        renderProjects();
        renderContentPath();
      }

      async function deleteProject(projectId) {
        if (!confirm(t('confirmDelete'))) return;
        const testsToDelete = state.tests.filter(t => t.projectId === projectId);
        for (const test of testsToDelete) {
          const sectionsToDelete = state.sections.filter(s => s.testId === test.id);
          for (const s of sectionsToDelete) {
            const qs = state.questions.filter(q => q.sectionId === s.id);
            for (const q of qs) await dbDelete('questions', q.id);
            await dbDelete('sections', s.id);
          }
          const questionsToDelete = state.questions.filter(q => q.testId === test.id);
          for (const q of questionsToDelete) await dbDelete('questions', q.id);
          await dbDelete('tests', test.id);
        }
        await dbDelete('projects', projectId);
        state.questions = state.questions.filter(q => !testsToDelete.some(t => t.id === q.testId));
        state.sections = state.sections.filter(s => !testsToDelete.some(t => t.id === s.testId));
        state.tests = state.tests.filter(t => t.projectId !== projectId);
        state.projects = state.projects.filter(p => p.id !== projectId);
        if (state.selectedProjectId === projectId) {
          state.selectedProjectId = null;
          state.selectedTestId = null;
          state.selectedSectionId = null;
          state.selectedQuestionId = null;
        }
        renderProjects();
        renderTests();
        renderSections();
        renderQuestions();
        renderContent();
      }

      async function addTest() {
        if (!state.selectedProjectId) return;
        const name = prompt(t('enterName'), t('newTestName'));
        if (!name || !name.trim()) return;
        const testsInProject = state.tests.filter(t => t.projectId === state.selectedProjectId);
        const test = { id: generateId(), projectId: state.selectedProjectId, name: name.trim(), order: testsInProject.length, createdAt: Date.now() };
        await dbAdd('tests', test);
        state.tests.push(test);
        renderTests();
        selectTest(test.id);
      }

      async function renameTest(testId) {
        const test = state.tests.find(t => t.id === testId);
        if (!test) return;
        const name = prompt(t('enterName'), test.name);
        if (!name || !name.trim()) return;
        test.name = name.trim();
        await dbPut('tests', test);
        renderTests();
        renderContentPath();
      }

      async function deleteTest(testId) {
        if (!confirm(t('confirmDelete'))) return;
        const sectionsToDelete = state.sections.filter(s => s.testId === testId);
        for (const s of sectionsToDelete) {
          const qs = state.questions.filter(q => q.sectionId === s.id);
          for (const q of qs) await dbDelete('questions', q.id);
          await dbDelete('sections', s.id);
        }
        const questionsToDelete = state.questions.filter(q => q.testId === testId);
        for (const q of questionsToDelete) await dbDelete('questions', q.id);
        await dbDelete('tests', testId);
        state.questions = state.questions.filter(q => q.testId !== testId);
        state.sections = state.sections.filter(s => s.testId !== testId);
        state.tests = state.tests.filter(t => t.id !== testId);
        if (state.selectedTestId === testId) {
          state.selectedTestId = null;
          state.selectedSectionId = null;
          state.selectedQuestionId = null;
        }
        renderTests();
        renderSections();
        renderQuestions();
        renderContent();
      }

      async function addSection() {
        if (!state.selectedTestId) return;
        const sectionId = prompt(t('sectionId') + ' (e.g. 01, 02)', '01');
        const name = prompt(t('enterName'), t('newSectionName'));
        if (!name || !name.trim()) return;
        const sectionsInTest = state.sections.filter(s => s.testId === state.selectedTestId);
        const section = {
          id: generateId(),
          testId: state.selectedTestId,
          sectionId: (sectionId || '').trim() || String(sectionsInTest.length + 1).padStart(2, '0'),
          name: name.trim(),
          order: sectionsInTest.length,
          createdAt: Date.now()
        };
        await dbAdd('sections', section);
        state.sections.push(section);
        renderSections();
        selectSection(section.id);
      }

      async function renameSection(sectionId) {
        const section = state.sections.find(s => s.id === sectionId);
        if (!section) return;
        const name = prompt(t('enterName'), section.name);
        if (!name || !name.trim()) return;
        const sectionIdSort = prompt(t('sectionId'), section.sectionId || '');
        section.name = name.trim();
        if (sectionIdSort != null) section.sectionId = (sectionIdSort || '').trim() || section.sectionId;
        await dbPut('sections', section);
        renderSections();
        renderContentPath();
      }

      async function deleteSection(sectionId) {
        if (!confirm(t('confirmDelete'))) return;
        const questionsInSection = state.questions.filter(q => q.sectionId === sectionId);
        for (const q of questionsInSection) await dbDelete('questions', q.id);
        await dbDelete('sections', sectionId);
        state.questions = state.questions.filter(q => q.sectionId !== sectionId);
        state.sections = state.sections.filter(s => s.id !== sectionId);
        if (state.selectedSectionId === sectionId) {
          state.selectedSectionId = null;
          state.selectedQuestionId = null;
        }
        renderSections();
        renderQuestions();
        renderContent();
      }

      async function addQuestion() {
        if (!state.selectedTestId || !state.selectedSectionId) return;
        const questionsInSection = state.questions.filter(q => q.sectionId === state.selectedSectionId);
        const question = {
          id: generateId(),
          testId: state.selectedTestId,
          sectionId: state.selectedSectionId,
          questionId: generateQuestionId(),
          questionType: 'multiple_choice',
          questionText: '',
          questionTranslation: '',
          options: [{ text: '', translation: '', correct: false, noTranslation: false }, { text: '', translation: '', correct: false, noTranslation: false }],
          singleChoice: true,
          textAnswerContent: '',
          internalComment: '',
          externalComment: '',
          isReady: false,
          disabled: false,
          order: questionsInSection.length,
          createdAt: Date.now(),
          updatedAt: Date.now()
        };
        await dbAdd('questions', question);
        state.questions.push(question);
        renderQuestions();
        selectQuestion(question.id);
      }

      async function deleteQuestion(questionId) {
        if (!confirm(t('confirmDelete'))) return;
        await dbDelete('questions', questionId);
        state.questions = state.questions.filter(q => q.id !== questionId);
        if (state.selectedQuestionId === questionId) state.selectedQuestionId = null;
        renderQuestions();
        renderContent();
      }

      // ========== Search ==========
      function getQuestionsForSearch() {
        const scope = document.getElementById('search-scope').value;
        if (scope === 'test' && state.selectedTestId) {
          return state.questions.filter(q => q.testId === state.selectedTestId);
        }
        if (scope === 'project' && state.selectedProjectId) {
          const testIds = state.tests.filter(t => t.projectId === state.selectedProjectId).map(t => t.id);
          return state.questions.filter(q => testIds.includes(q.testId));
        }
        return state.questions;
      }

      function questionMatchesQuery(q, queryLower) {
        const str = (s) => (s || '').toLowerCase();
        if (str(q.questionText).includes(queryLower)) return true;
        if (str(q.questionTranslation).includes(queryLower)) return true;
        if (str(q.internalComment).includes(queryLower)) return true;
        if (str(q.externalComment).includes(queryLower)) return true;
        if (q.options && q.options.some(o => str(o.text).includes(queryLower) || str(o.translation).includes(queryLower))) return true;
        return false;
      }

      function getSearchPreview(question, query) {
        const queryLower = query.toLowerCase();
        const fields = [
          question.questionText,
          question.questionTranslation,
          question.internalComment,
          question.externalComment,
          ...(question.options || []).flatMap(o => [o.text, o.translation])
        ].filter(Boolean).join(' ');
        const idx = fields.toLowerCase().indexOf(queryLower);
        if (idx === -1) return fields.slice(0, 80) + (fields.length > 80 ? '…' : '');
        const start = Math.max(0, idx - 25);
        const end = Math.min(fields.length, idx + query.length + 55);
        let preview = fields.slice(start, end);
        if (start > 0) preview = '…' + preview;
        if (end < fields.length) preview += '…';
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return escapeHtml(preview).replace(regex, '<mark>$1</mark>');
      }

      function performSearch() {
        const query = document.getElementById('search-input').value.trim();
        if (!query) return;
        const queryLower = query.toLowerCase();
        const candidates = getQuestionsForSearch();
        const results = candidates.filter(q => questionMatchesQuery(q, queryLower));
        const project = state.projects.find(p => p.id === state.selectedProjectId);
        const test = state.tests.find(t => t.id === state.selectedTestId);

        if (results.length === 0) {
          searchResultsEl.innerHTML = `<div class="empty-state">${t('noResults')}</div>`;
        } else {
          searchResultsEl.innerHTML = results.map(q => {
            const tObj = state.tests.find(t => t.id === q.testId);
            const sObj = state.sections.find(s => s.id === q.sectionId);
            const pObj = state.projects.find(p => p.id === tObj?.projectId);
            return `
              <div class="search-result-item" data-project-id="${pObj?.id || ''}" data-test-id="${tObj?.id || ''}" data-section-id="${sObj?.id || ''}" data-question-id="${q.id}">
                <div class="search-result-path">${escapeHtml(pObj?.name || '')} / ${escapeHtml(tObj?.name || '')} / ${escapeHtml(sObj?.name || sObj?.sectionId || '')} / ${escapeHtml(q.questionId || q.id)}</div>
                <div class="search-result-preview">${getSearchPreview(q, query)}</div>
              </div>
            `;
          }).join('');
          searchResultsEl.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', () => {
              state.selectedProjectId = item.dataset.projectId || null;
              state.selectedTestId = item.dataset.testId || null;
              state.selectedSectionId = item.dataset.sectionId || null;
              state.selectedQuestionId = item.dataset.questionId || null;
              renderProjects();
              renderTests();
              renderSections();
              renderQuestions();
              renderContent();
              saveState();
              searchModal.hide();
            });
          });
        }
        searchModal.show();
      }

      // ========== Export / Import ==========
      function exportTestJson(test) {
        const sections = state.sections.filter(s => s.testId === test.id).sort((a, b) => (a.sectionId || '').localeCompare(b.sectionId || '', undefined, { numeric: true }));
        const questions = state.questions.filter(q => q.testId === test.id).sort((a, b) => (a.questionId || '').localeCompare(b.questionId || ''));
        const payload = { version: 2, test: { ...test }, sections, questions };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (test.name || 'test').replace(/[^a-zA-Z0-9-_]/g, '_') + '.json';
        a.click();
        URL.revokeObjectURL(a.href);
      }

      function importTestJson(test) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json,.json';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            const text = await file.text();
            const data = JSON.parse(text);
            const importedTest = data.test;
            const importedSections = Array.isArray(data.sections) ? data.sections : [];
            const importedQuestions = Array.isArray(data.questions) ? data.questions : [];
            if (!importedTest || !importedTest.id) return;
            importedTest.id = generateId();
            importedTest.projectId = state.selectedProjectId;
            importedTest.order = state.tests.filter(t => t.projectId === state.selectedProjectId).length;
            await dbAdd('tests', importedTest);
            state.tests.push(importedTest);
            const oldToNewSectionId = {};
            for (const sec of importedSections) {
              const oldId = sec.id;
              sec.id = generateId();
              sec.testId = importedTest.id;
              sec.order = state.sections.filter(s => s.testId === importedTest.id).length;
              await dbAdd('sections', sec);
              state.sections.push(sec);
              oldToNewSectionId[oldId] = sec.id;
            }
            for (const q of importedQuestions) {
              const newQ = { ...q, id: generateId(), testId: importedTest.id };
              if (q.sectionId && oldToNewSectionId[q.sectionId]) newQ.sectionId = oldToNewSectionId[q.sectionId];
              else newQ.sectionId = null;
              newQ.order = state.questions.filter(x => x.testId === importedTest.id).length;
              await dbAdd('questions', newQ);
              state.questions.push(newQ);
            }
            renderTests();
            renderSections();
            renderQuestions();
            selectTest(importedTest.id);
          } catch (err) {
            console.error(err);
            alert('Invalid JSON');
          }
        };
        input.click();
      }

      function getTestSectionsWithQuestions(test) {
        const sections = state.sections.filter(s => s.testId === test.id).sort((a, b) => (a.sectionId || '').localeCompare(b.sectionId || '', undefined, { numeric: true }) || (a.order - b.order));
        const sectionIds = new Set(sections.map(s => s.id));
        const allTestQuestions = state.questions.filter(q => q.testId === test.id && !q.disabled);
        const result = sections.map(sec => ({
          section: sec,
          questions: allTestQuestions.filter(q => q.sectionId === sec.id).sort((a, b) => (a.questionId || '').localeCompare(b.questionId || ''))
        }));
        const orphanQuestions = allTestQuestions.filter(q => !q.sectionId || !sectionIds.has(q.sectionId)).sort((a, b) => (a.questionId || '').localeCompare(b.questionId || ''));
        if (orphanQuestions.length > 0) {
          result.push({ section: { id: null, sectionId: '', name: 'Other' }, questions: orphanQuestions });
        }
        return result;
      }

      function exportRendered(test, format, withAnswers, langOpt) {
        const sectionsWithQuestions = getTestSectionsWithQuestions(test);
        const langPrimary = langOpt === 'primary' || langOpt === 'bilingual-primary' || langOpt === 'bilingual-secondary';
        const langSecondary = langOpt === 'secondary' || langOpt === 'bilingual-primary' || langOpt === 'bilingual-secondary';
        const bilingual = langOpt.startsWith('bilingual');
        const primaryFirst = langOpt === 'bilingual-primary';
        function checkBox(withAnswers, correct, forHtml) {
          if (forHtml) {
            return (withAnswers && correct) ? '<span class="answer-mark">[&nbsp;x&nbsp;]</span>&nbsp;' : '[&nbsp;&nbsp;&nbsp;]&nbsp;';
          }
          return (withAnswers && correct) ? '[ x ] ' : '[  ] ';
        }

        function formatQuestionLine(num, text, qId) {
          const idPart = (qId || '').trim();
          if (!idPart) return num + '. ' + text;
          const padding = Math.max(1, 50 - (num + '. ' + text).length);
          return num + '. ' + text + ' '.repeat(padding) + idPart;
        }

        const lines = [];
        const title = test.name || 'Quiz';
        lines.push(title);
        lines.push('');
        let globalNum = 0;
        sectionsWithQuestions.forEach(({ section, questions }) => {
          lines.push('--- ' + (section.name || section.sectionId || '') + ' ---');
          lines.push('');
          questions.forEach((qu) => {
            globalNum += 1;
            const n = globalNum;
            const qId = qu.questionId || '';
            if (bilingual) {
              const top = primaryFirst ? (qu.questionText || '') : (qu.questionTranslation || '');
              const bottom = primaryFirst ? (qu.questionTranslation || '') : (qu.questionText || '');
              const topLines = top.split('\n');
              lines.push(formatQuestionLine(n, topLines[0] || '', qId));
              for (let i = 1; i < topLines.length; i++) lines.push('   ' + topLines[i]);
              if (bottom) {
                const bottomLines = bottom.split('\n');
                for (let i = 0; i < bottomLines.length; i++) lines.push('   ' + bottomLines[i]);
              }
            } else if (langOpt === 'primary') {
              const qLines = (qu.questionText || '').split('\n');
              lines.push(formatQuestionLine(n, qLines[0] || '', qId));
              for (let i = 1; i < qLines.length; i++) lines.push('   ' + qLines[i]);
            } else {
              const qLines = (qu.questionTranslation || '').split('\n');
              lines.push(formatQuestionLine(n, qLines[0] || '', qId));
              for (let i = 1; i < qLines.length; i++) lines.push('   ' + qLines[i]);
            }
            const isTextQuestion = qu.questionType === 'text';
            if (isTextQuestion) {
              const modelLines = (qu.textAnswerContent || '').split('\n');
              const numLines = Math.max(1, modelLines.length);
              lines.push('   Answer:');
              if (withAnswers) {
                modelLines.forEach(line => lines.push('   ' + line));
              } else {
                for (let i = 0; i < numLines; i++) lines.push('   ');
              }
            } else {
              (qu.options || []).forEach((o, j) => {
                const letter = String.fromCharCode(65 + j);
                const cb = checkBox(withAnswers, o.correct, false);
                if (bilingual) {
                  const top = o.noTranslation ? (o.text || '') : (primaryFirst ? (o.text || '') : (o.translation || ''));
                  const bottom = o.noTranslation ? '' : (primaryFirst ? (o.translation || '') : (o.text || ''));
                  const topLines = top.split('\n');
                  lines.push('   ' + cb + letter + ') ' + (topLines[0] || ''));
                  for (let i = 1; i < topLines.length; i++) lines.push('      ' + topLines[i]);
                  const bottomLines = bottom.split('\n');
                  if (bottomLines[0]) lines.push('      ' + bottomLines[0]);
                  for (let i = 1; i < bottomLines.length; i++) lines.push('         ' + bottomLines[i]);
                } else if (langOpt === 'primary') {
                  const optText = o.noTranslation ? (o.text || '') : (o.text || '');
                  const optLines = optText.split('\n');
                  lines.push('   ' + cb + letter + ') ' + (optLines[0] || ''));
                  for (let i = 1; i < optLines.length; i++) lines.push('      ' + optLines[i]);
                } else {
                  const optText = o.noTranslation ? (o.text || '') : (o.translation || '');
                  const optLines = optText.split('\n');
                  lines.push('   ' + cb + letter + ') ' + (optLines[0] || ''));
                  for (let i = 1; i < optLines.length; i++) lines.push('      ' + optLines[i]);
                }
              });
            }
            if (withAnswers && qu.externalComment) lines.push('   Comment: ' + qu.externalComment);
            lines.push('');
          });
        });

        let content;
        if (format === 'txt') {
          content = lines.join('\n');
        } else {
          const css = (test.exportCss != null && test.exportCss.trim() !== '') ? test.exportCss : DEFAULT_EXPORT_CSS;
          const template = (test.exportQuestionHtml != null && test.exportQuestionHtml.trim() !== '') ? test.exportQuestionHtml : DEFAULT_EXPORT_QUESTION_TEMPLATE;
          const bodyParts = [];
          bodyParts.push('<h1 class="quiz-title">' + escapeHtml(title) + '</h1>');
          globalNum = 0;
          sectionsWithQuestions.forEach(({ section, questions }) => {
            bodyParts.push('<h2 class="section-title">' + escapeHtml(section.name || section.sectionId || '') + '</h2>');
            questions.forEach((qu) => {
              globalNum += 1;
              const n = globalNum;
              const qId = qu.questionId || qu.id || '';
              let questionText = '';
              let questionTextSecondary = '';
              if (bilingual) {
                questionText = primaryFirst ? (qu.questionText || '') : (qu.questionTranslation || '');
                questionTextSecondary = primaryFirst ? (qu.questionTranslation || '') : (qu.questionText || '');
              } else if (langOpt === 'primary') {
                questionText = qu.questionText || '';
              } else {
                questionText = qu.questionTranslation || '';
              }
              let optionsHtml = '';
              let textAnswerBlock = '';
              const isTextQuestion = qu.questionType === 'text';
              if (isTextQuestion) {
                const modelLines = (qu.textAnswerContent || '').split('\n');
                const numLines = Math.max(1, modelLines.length);
                if (withAnswers) {
                  textAnswerBlock = modelLines.map(l => '<div class="text-answer-line answer-text">' + formatTextWithCode(l) + '</div>').join('');
                } else {
                  textAnswerBlock = Array(numLines).fill('<div class="text-answer-line">&nbsp;</div>').join('');
                }
              } else {
                const optionHtmlWithBreaks = (s) => formatTextWithCode(s).replace(/\n/g, '<br>');
                (qu.options || []).forEach((o, j) => {
                  const letter = String.fromCharCode(65 + j);
                  const cb = checkBox(withAnswers, o.correct, true);
                  if (bilingual) {
                    const top = o.noTranslation ? (o.text || '') : (primaryFirst ? (o.text || '') : (o.translation || ''));
                    const bottom = o.noTranslation ? '' : (primaryFirst ? (o.translation || '') : (o.text || ''));
                    const correctClass = withAnswers && o.correct ? ' correct-option' : '';
                    optionsHtml += '<li class="primary-lang' + correctClass + '">' + cb + letter + ') ' + optionHtmlWithBreaks(top) + '</li>';
                    if (bottom) optionsHtml += '<li class="secondary-lang">' + optionHtmlWithBreaks(bottom) + '</li>';
                  } else {
                    const text = o.noTranslation ? (o.text || '') : (langOpt === 'primary' ? (o.text || '') : (o.translation || ''));
                    const correctClass = withAnswers && o.correct ? ' correct-option' : '';
                    optionsHtml += '<li class="' + correctClass + '">' + cb + letter + ') ' + optionHtmlWithBreaks(text) + '</li>';
                  }
                });
              }
              const questionHtmlWithBreaks = (s) => formatTextWithCode(s).replace(/\n/g, '<br>');
              const externalComment = (withAnswers && qu.externalComment) ? formatTextWithCode(qu.externalComment) : '';
              const qBlock = template
                .replace(/\{\{questionNumber\}\}/g, String(n))
                .replace(/\{\{questionId\}\}/g, escapeHtml(qId))
                .replace(/\{\{questionText\}\}/g, questionHtmlWithBreaks(questionText))
                .replace(/\{\{questionTextSecondary\}\}/g, questionHtmlWithBreaks(questionTextSecondary))
                .replace(/\{\{optionsHtml\}\}/g, optionsHtml)
                .replace(/\{\{textAnswerBlock\}\}/g, textAnswerBlock)
                .replace(/\{\{externalComment\}\}/g, externalComment);
              bodyParts.push(qBlock);
            });
          });
          var et = '<' + '/';
          content = '<!DOCTYPE html><html><head><meta charset="UTF-8"/><title>' + escapeHtml(title) + et + 'title><style>\n' + css + '\n.question-id-line{color:#999;font-size:0.85em;text-align:right;margin-bottom:0.2em;line-height:1.2;}\n.question-text.primary-lang{margin-top:0;}\n.section-title{font-size:1.1rem;margin:1rem 0 0.5rem 0;}\n' + et + 'style>' + et + 'head><body>\n' + bodyParts.join('\n') + '\n' + et + 'body>' + et + 'html>';
        }

        const blob = new Blob([content], { type: format === 'html' ? 'text/html' : 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (test.name || 'quiz').replace(/[^a-zA-Z0-9-_]/g, '_') + (withAnswers ? '_with_answers' : '') + (format === 'html' ? '.html' : '.txt');
        a.click();
        URL.revokeObjectURL(a.href);
      }

      // ========== State persistence & collapse ==========
      function saveState() {
        localStorage.setItem('test_builder_state', JSON.stringify({
          selectedProjectId: state.selectedProjectId,
          selectedTestId: state.selectedTestId,
          selectedSectionId: state.selectedSectionId,
          selectedQuestionId: state.selectedQuestionId
        }));
      }

      function loadState() {
        try {
          const saved = localStorage.getItem('test_builder_state');
          if (saved) {
            const parsed = JSON.parse(saved);
            state.selectedProjectId = parsed.selectedProjectId;
            state.selectedTestId = parsed.selectedTestId;
            state.selectedSectionId = parsed.selectedSectionId;
            state.selectedQuestionId = parsed.selectedQuestionId;
          }
        } catch (e) {}
      }

      function setupCollapseButtons() {
        document.querySelectorAll('.collapse-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const targetId = btn.dataset.target;
            const col = document.getElementById(targetId);
            if (col) col.classList.toggle('collapsed');
            const collapseState = {};
            document.querySelectorAll('.nav-column').forEach(c => {
              collapseState[c.id] = c.classList.contains('collapsed');
            });
            localStorage.setItem('test_builder_collapse', JSON.stringify(collapseState));
          });
        });
        try {
          const saved = localStorage.getItem('test_builder_collapse');
          if (saved) {
            const st = JSON.parse(saved);
            Object.entries(st).forEach(([id, collapsed]) => {
              const col = document.getElementById(id);
              if (col && collapsed) col.classList.add('collapsed');
            });
          }
        } catch (e) {}
      }

      // ========== Init ==========
      async function init() {
        await openDB();
        state.projects = await dbGetAll('projects');
        state.tests = await dbGetAll('tests');
        state.sections = await dbGetAll('sections');
        state.questions = await dbGetAll('questions');
        if (state.sections.length === 0 && state.questions.some(q => !q.sectionId)) {
          for (const test of state.tests) {
            const questionsWithoutSection = state.questions.filter(q => q.testId === test.id && !q.sectionId);
            if (questionsWithoutSection.length > 0) {
              const defaultSection = { id: generateId(), testId: test.id, sectionId: '01', name: 'Default', order: 0, createdAt: Date.now() };
              await dbAdd('sections', defaultSection);
              state.sections.push(defaultSection);
              for (const q of questionsWithoutSection) {
                q.sectionId = defaultSection.id;
                await dbPut('questions', q);
              }
            }
          }
        }
        loadState();
        if (state.selectedProjectId && !state.projects.find(p => p.id === state.selectedProjectId)) state.selectedProjectId = null;
        if (state.selectedTestId && !state.tests.find(t => t.id === state.selectedTestId)) state.selectedTestId = null;
        if (state.selectedSectionId && !state.sections.find(s => s.id === state.selectedSectionId)) state.selectedSectionId = null;
        if (state.selectedQuestionId && !state.questions.find(q => q.id === state.selectedQuestionId)) state.selectedQuestionId = null;

        document.getElementById('lang-switcher').value = currentLanguage;
        applyI18n();
        applyTheme(currentTheme);

        renderProjects();
        renderTests();
        renderSections();
        renderQuestions();
        renderContent();
        setupCollapseButtons();

        document.getElementById('lang-switcher').addEventListener('change', (e) => {
          currentLanguage = e.target.value;
          localStorage.setItem('app_lang', currentLanguage);
          applyI18n();
          renderProjects();
          renderTests();
          renderSections();
          renderQuestions();
          renderContent();
        });
        document.getElementById('theme-switcher').addEventListener('click', () => {
          currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
          applyTheme(currentTheme);
        });
        document.getElementById('search-input').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') performSearch();
        });
        addProjectBtn.addEventListener('click', addProject);
        addTestBtn.addEventListener('click', addTest);
        addSectionBtn.addEventListener('click', addSection);
        addQuestionBtn.addEventListener('click', addQuestion);
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
