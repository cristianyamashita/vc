<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">Bitwise Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/fontawesome/css/all.min.css" />
    <style>
      :root {
        --bg-color: #1a1a1a;
        --text-color: #f0f0f0;
        --card-bg-color: #2a2a2a;
        --border-color: #444;
        --accent-color: #0d6efd;
      }

      html[data-theme='light'] {
        --bg-color: #f8f9fa;
        --text-color: #212529;
        --card-bg-color: #fff;
        --border-color: #dee2e6;
        --accent-color: #0d6efd;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
      }

      .container-fluid {
        padding-top: 20px;
        padding-bottom: 20px;
        flex: 1;
      }

      .card {
        background-color: var(--card-bg-color);
        border-color: var(--border-color);
      }

      .card-header {
        border-bottom-color: var(--border-color);
      }

      .navbar-brand,
      .form-label {
        color: var(--text-color);
      }

      .form-control,
      .form-select {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .form-control:focus,
      .form-select:focus {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }

      .binary-output {
        font-family: 'Courier New', Courier, monospace;
        font-size: 1.25rem;
        background-color: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 0.25rem;
        padding: 0.75rem 1rem;
        user-select: all;
      }

      .help-text {
        color: #aaa;
        font-size: 0.9rem;
      }

      .badge-bit {
        background: #6c757d;
      }

      .form-check-label small {
        color: #aaa;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg" style="background-color: var(--card-bg-color); border-bottom: 1px solid var(--border-color)">
      <div class="container-fluid">
        <a class="navbar-brand" href="#" data-i18n="title">Bitwise Converter</a>
        <div class="d-flex ms-auto">
          <select id="lang-switcher" class="form-select form-select-sm me-2" style="width: auto">
            <option value="en">English</option>
            <option value="pt">Português</option>
            <option value="ja">日本語</option>
          </select>
          <button id="theme-switcher" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
          <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h4 class="mb-0" data-i18n="title">Bitwise Converter</h4>
            </div>
            <div class="card-body">
              <div class="row g-3 align-items-center mb-3">
                <div class="col-sm-4">
                  <label for="decimal-input" class="form-label" data-i18n="decimal_label">Decimal Value</label>
                  <div class="input-group">
                    <button id="dec-decrement" class="btn btn-outline-secondary" type="button" aria-label="Decrement"><i class="fas fa-minus"></i></button>
                    <input id="decimal-input" type="text" inputmode="numeric" pattern="[0-9]*" class="form-control text-end" placeholder="0" />
                    <button id="dec-increment" class="btn btn-outline-secondary" type="button" aria-label="Increment"><i class="fas fa-plus"></i></button>
                  </div>
                  <div id="range-hint" class="help-text" data-i18n="range_hint_prefix">Range: 0 to</div>
                </div>
                <div class="col-sm-3">
                  <label for="bits-select" class="form-label" data-i18n="bits_label">Bits</label>
                  <select id="bits-select" class="form-select">
                    <option value="8">8</option>
                    <option value="16">16</option>
                    <option value="32" selected>32</option>
                    <option value="64">64</option>
                  </select>
                  <div id="range-hint" class="help-text" data-i18n="select_bits_range">Select bits range</div>
                </div>
                <div class="col-sm-5 d-flex gap-2">
                  <button id="clear-btn" class="btn btn-outline-secondary flex-fill"><i class="fas fa-eraser me-1"></i><span data-i18n="clear">Clear</span></button>
                  <button id="select-all-btn" class="btn btn-outline-secondary flex-fill"><i class="fas fa-check-double me-1"></i><span data-i18n="select_all">Select All</span></button>
                  <button id="invert-btn" class="btn btn-outline-secondary flex-fill"><i class="fas fa-retweet me-1"></i><span data-i18n="invert">Invert</span></button>
                </div>
              </div>

              <div class="mb-3">
                <label id="binary-label" class="form-label" data-i18n="binary_label">Binary (32 bits)</label>
                <div id="binary-output" class="binary-output">0000 0000 0000 0000 0000 0000 0000 0000</div>
              </div>

              <div class="mb-3">
                <label class="form-label" data-i18n="active_values">Active values</label>
                <div id="active-values" class="form-control" style="height: auto; min-height: 42px"></div>
              </div>

              <hr />

              <div class="mb-2">
                <span id="checkbox-hint" class="help-text" data-i18n="checkbox_hint_prefix">Toggle the checkboxes to set bits (1, 2, 4, 8, ...</span>
              </div>
              <div id="checkboxes-container" class="row g-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        let MAX_BITS = 32;
        let MAX_VALUE = (1n << BigInt(MAX_BITS)) - 1n; // BigInt
        

        // i18n
        const i18n = {
          en: {
            title: 'Bitwise Converter',
            decimal_label: 'Decimal Value',
            binary_label: 'Binary ({{bits}} bits)',
            active_values: 'Active values',
            range_hint_prefix: 'Range: 0 to',
            bits_label: 'Bits',
            clear: 'Clear',
            select_all: 'Select All',
            invert: 'Invert',
            checkbox_hint_prefix: 'Toggle the checkboxes to set bits (1, 2, 4, 8, ...',
            none: 'None',
            select_bits_range: 'Select bits range',
          },
          pt: {
            title: 'Conversor Bitwise',
            decimal_label: 'Valor Decimal',
            binary_label: 'Binário ({{bits}} bits)',
            active_values: 'Valores ativos',
            range_hint_prefix: 'Intervalo: 0 até',
            bits_label: 'Bits',
            clear: 'Limpar',
            select_all: 'Selecionar tudo',
            invert: 'Inverter',
            checkbox_hint_prefix: 'Use as caixas para marcar os bits (1, 2, 4, 8, ...',
            none: 'Nenhum',
            select_bits_range: 'Selecionar intervalo de bits',
          },
          ja: {
            title: 'ビット演算コンバーター',
            decimal_label: '10進数',
            binary_label: '2進数 ({{bits}}ビット)',
            active_values: '有効な値',
            range_hint_prefix: '範囲: 0 〜',
            bits_label: 'ビット数',
            clear: 'クリア',
            select_all: '全選択',
            invert: '反転',
            checkbox_hint_prefix: 'チェックでビットを設定 (1, 2, 4, 8, ...',
            none: 'なし',
            select_bits_range: 'ビット範囲を選択',
          },
        };

        // Elements
        const langSwitcher = document.getElementById('lang-switcher');
        const themeSwitcher = document.getElementById('theme-switcher');

        const decimalInput = document.getElementById('decimal-input');
        const binaryOutput = document.getElementById('binary-output');
        const activeValuesEl = document.getElementById('active-values');
        const checkboxesContainer = document.getElementById('checkboxes-container');
        const clearBtn = document.getElementById('clear-btn');
        const selectAllBtn = document.getElementById('select-all-btn');
        const invertBtn = document.getElementById('invert-btn');
        const decIncBtn = document.getElementById('dec-increment');
        const decDecBtn = document.getElementById('dec-decrement');

        // State
        let currentLanguage = localStorage.getItem('app_lang') || 'pt';
        let currentTheme = localStorage.getItem('app_theme') || 'dark';

        // Helpers
        const applyI18n = () => {
          const lang = i18n[currentLanguage] || i18n.en;
          document.querySelectorAll('[data-i18n]').forEach((el) => {
            const key = el.getAttribute('data-i18n');
            if (lang[key]) el.innerText = lang[key];
          });
          document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (lang[key]) el.placeholder = lang[key];
          });
          document.title = lang.title;
        };

        const applyTheme = (theme) => {
          document.documentElement.setAttribute('data-theme', theme);
          const icon = themeSwitcher.querySelector('i');
          icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
          localStorage.setItem('app_theme', theme);
        };

        const toBigInt = (x) => {
          if (typeof x === 'bigint') return x;
          const s = String(x).trim();
          if (s === '') return 0n;
          if (!/^[0-9]+$/.test(s)) return 0n;
          try { return BigInt(s); } catch { return 0n; }
        };

        const clampBigInt = (v, min, max) => (v < min ? min : (v > max ? max : v));

        const formatBinary = (valueBig) => {
          const v = toBigInt(valueBig);
          let raw = v.toString(2);
          raw = raw.padStart(MAX_BITS, '0');
          return raw.replace(/(.{4})/g, '$1 ').trim();
        };

        const pow2 = (i) => (1n << BigInt(i));

        const maxValueForBits = (bits) => (1n << BigInt(bits)) - 1n;

        const updateDynamicTexts = () => {
          const lang = i18n[currentLanguage] || i18n.en;
          const binaryLabel = document.getElementById('binary-label');
          const rangeHint = document.getElementById('range-hint');
          const checkboxHint = document.getElementById('checkbox-hint');
          if (binaryLabel) binaryLabel.innerText = (lang.binary_label || '').replace('{{bits}}', String(MAX_BITS));
          if (rangeHint) rangeHint.innerText = `${lang.range_hint_prefix} ${maxValueForBits(MAX_BITS).toString()}`;
          if (checkboxHint) checkboxHint.innerText = `${lang.checkbox_hint_prefix} ${pow2(MAX_BITS - 1).toString()})`;
        };

        const setDecimalValue = (value) => {
          const clamped = clampBigInt(toBigInt(value), 0n, MAX_VALUE);
          if (decimalInput.value !== clamped.toString()) decimalInput.value = clamped.toString();
          // Update checkboxes according to value
          for (let i = 0; i < MAX_BITS; i++) {
            const cb = document.getElementById('bit-' + i);
            if (!cb) continue;
            const bitVal = pow2(i);
            const isOn = (clamped & bitVal) !== 0n;
            cb.checked = isOn;
          }
          // Update binary text
          binaryOutput.innerText = formatBinary(clamped);
          // Update active values list
          const lang = i18n[currentLanguage] || i18n.en;
          const actives = [];
          for (let i = 0; i < MAX_BITS; i++) {
            const bitVal = pow2(i);
            if ((clamped & bitVal) !== 0n) actives.push(bitVal);
          }
          activeValuesEl.innerText = actives.length ? actives.map((v) => v.toString()).join(', ') : lang.none;
        };

        const valueFromCheckboxes = () => {
          let value = 0n;
          for (let i = 0; i < MAX_BITS; i++) {
            const cb = document.getElementById('bit-' + i);
            if (cb && cb.checked) value += pow2(i);
          }
          return clampBigInt(value, 0n, MAX_VALUE);
        };

        const renderCheckboxes = () => {
          // Ascending order: 2^0, 2^1, ...
          const row = document.createDocumentFragment();
          for (let i = 0; i < MAX_BITS; i++) {
            const col = document.createElement('div');
            col.className = 'col-6 col-sm-4 col-md-3 col-lg-2';

            const wrapper = document.createElement('div');
            wrapper.className = 'form-check';

            const input = document.createElement('input');
            input.className = 'form-check-input bit-checkbox';
            input.type = 'checkbox';
            input.id = 'bit-' + i;
            input.dataset.value = pow2(i).toString();

            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = input.id;
            const valueSpan = document.createElement('span');
            valueSpan.className = 'badge badge-bit me-2';
            valueSpan.textContent = pow2(i).toString();
            const small = document.createElement('small');
            small.textContent = '2^' + i;
            label.appendChild(valueSpan);
            label.appendChild(small);

            wrapper.appendChild(input);
            wrapper.appendChild(label);
            col.appendChild(wrapper);
            row.appendChild(col);
          }
          checkboxesContainer.appendChild(row);

          // Add listeners
          checkboxesContainer.querySelectorAll('.bit-checkbox').forEach((cb) => {
            cb.addEventListener('change', () => {
              const v = valueFromCheckboxes();
              setDecimalValue(v);
            });
          });
        };

        // Events
        langSwitcher.addEventListener('change', (e) => {
          currentLanguage = e.target.value;
          localStorage.setItem('app_lang', currentLanguage);
          applyI18n();
          updateDynamicTexts();
        });

        themeSwitcher.addEventListener('click', () => {
          currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
          applyTheme(currentTheme);
        });

        decimalInput.addEventListener('input', () => {
          const raw = decimalInput.value.replace(/\D+/g, '');
          decimalInput.value = raw;
          const n = raw === '' ? 0n : toBigInt(raw);
          setDecimalValue(clampBigInt(n, 0n, MAX_VALUE));
        });

        clearBtn.addEventListener('click', () => setDecimalValue(0n));
        selectAllBtn.addEventListener('click', () => setDecimalValue(MAX_VALUE));
        invertBtn.addEventListener('click', () => setDecimalValue(MAX_VALUE - valueFromCheckboxes()));

        const stepDecimal = (delta) => {
          const current = clampBigInt(toBigInt(decimalInput.value), 0n, MAX_VALUE);
          const next = clampBigInt(current + BigInt(delta), 0n, MAX_VALUE);
          setDecimalValue(next);
        };

        decIncBtn.addEventListener('click', () => stepDecimal(1));
        decDecBtn.addEventListener('click', () => stepDecimal(-1));

        const bitsSelect = document.getElementById('bits-select');
        bitsSelect.addEventListener('change', () => {
          const newBits = parseInt(bitsSelect.value, 10);
          if (![8, 16, 32, 64].includes(newBits)) return;
          MAX_BITS = newBits;
          MAX_VALUE = maxValueForBits(MAX_BITS);
          // Re-render checkboxes
          checkboxesContainer.innerHTML = '';
          renderCheckboxes();
          updateDynamicTexts();
          // Clamp current value to new range
          const currentVal = clampBigInt(toBigInt(decimalInput.value), 0n, MAX_VALUE);
          setDecimalValue(currentVal);
        });

        // Init
        langSwitcher.value = currentLanguage;
        applyI18n();
        updateDynamicTexts();
        applyTheme(currentTheme);
        renderCheckboxes();
        setDecimalValue(0n);
      });
    </script>
  </body>
  </html>


