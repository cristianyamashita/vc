<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">Notebook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/fontawesome/css/all.min.css" />
    <style>
      :root {
        --bg-color: #1a1a1a;
        --text-color: #f0f0f0;
        --card-bg-color: #2a2a2a;
        --border-color: #444;
        --accent-color: #0d6efd;
        --hover-color: #3a3a3a;
        --selected-color: #0d6efd33;
      }

      html[data-theme='light'] {
        --bg-color: #f8f9fa;
        --text-color: #212529;
        --card-bg-color: #fff;
        --border-color: #dee2e6;
        --accent-color: #0d6efd;
        --hover-color: #e9ecef;
        --selected-color: #0d6efd22;
      }

      * {
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        margin: 0;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      }

      /* Navbar */
      .navbar {
        background-color: var(--card-bg-color);
        border-bottom: 1px solid var(--border-color);
        padding: 0.5rem 1rem;
      }

      .navbar-brand {
        color: var(--text-color);
        font-weight: 600;
      }

      .form-control, .form-select {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .form-control:focus, .form-select:focus {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }

      .form-control::placeholder {
        color: var(--text-color);
        opacity: 0.5;
      }

      /* Main container */
      .main-container {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      /* Columns */
      .nav-column {
        display: flex;
        flex-direction: column;
        min-width: 180px;
        max-width: 250px;
        width: 200px;
        background-color: var(--card-bg-color);
        border-right: 1px solid var(--border-color);
        transition: width 0.3s ease, min-width 0.3s ease;
        overflow: hidden;
      }

      .nav-column.collapsed {
        min-width: 42px;
        width: 42px;
      }

      .nav-column.collapsed .column-content,
      .nav-column.collapsed .column-title-text,
      .nav-column.collapsed .add-btn-text {
        display: none;
      }

      .nav-column.collapsed .column-header {
        justify-content: center;
        padding: 0.5rem;
      }

      .nav-column.collapsed .collapse-btn {
        transform: rotate(180deg);
      }

      .column-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bg-color);
        min-height: 42px;
      }

      .column-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .collapse-btn {
        background: none;
        border: none;
        color: var(--text-color);
        cursor: pointer;
        padding: 0.25rem;
        opacity: 0.7;
        transition: opacity 0.2s, transform 0.3s;
      }

      .collapse-btn:hover {
        opacity: 1;
      }

      .column-content {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
      }

      .item-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .item-list li {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 2px;
        transition: background-color 0.15s;
      }

      .item-list li:hover {
        background-color: var(--hover-color);
      }

      .item-list li.selected {
        background-color: var(--selected-color);
        border: 1px solid var(--accent-color);
      }

      .item-list li .item-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .item-list li .item-actions {
        display: none;
        gap: 0.25rem;
      }

      .item-list li:hover .item-actions {
        display: flex;
      }

      .item-actions button {
        background: none;
        border: none;
        color: var(--text-color);
        cursor: pointer;
        padding: 0.15rem 0.3rem;
        opacity: 0.6;
        font-size: 0.75rem;
      }

      .item-actions button:hover {
        opacity: 1;
      }

      .add-item-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.5rem;
        margin-top: 0.5rem;
        background-color: transparent;
        border: 1px dashed var(--border-color);
        border-radius: 6px;
        color: var(--text-color);
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s, border-color 0.2s;
      }

      .add-item-btn:hover {
        opacity: 1;
        border-color: var(--accent-color);
      }

      /* Content area */
      .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .content-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--card-bg-color);
        min-height: 50px;
      }

      .content-path {
        font-size: 0.85rem;
        color: var(--text-color);
        opacity: 0.7;
      }

      .content-path span {
        opacity: 0.5;
      }

      .content-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 1rem;
        overflow: hidden;
      }

      .content-editor {
        flex: 1;
        width: 100%;
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        resize: none;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
        font-size: 0.95rem;
        line-height: 1.6;
      }

      .content-editor:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
      }

      .no-selection {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-color);
        opacity: 0.5;
        text-align: center;
      }

      .no-selection i {
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      /* Search modal */
      .modal-content {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .modal-header {
        border-bottom-color: var(--border-color);
      }

      .modal-footer {
        border-top-color: var(--border-color);
      }

      .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
      }

      html[data-theme='light'] .btn-close {
        filter: none;
      }

      .search-result-item {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: background-color 0.15s;
      }

      .search-result-item:hover {
        background-color: var(--hover-color);
      }

      .search-result-path {
        font-size: 0.8rem;
        color: var(--accent-color);
        margin-bottom: 0.25rem;
      }

      .search-result-preview {
        font-size: 0.85rem;
        opacity: 0.8;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .search-result-preview mark {
        background-color: #ffc107;
        color: #000;
        padding: 0 2px;
        border-radius: 2px;
      }

      .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-color);
        opacity: 0.5;
      }

      /* Status indicator */
      .save-status {
        font-size: 0.75rem;
        opacity: 0.6;
      }

      .save-status.saving {
        color: #ffc107;
      }

      .save-status.saved {
        color: #28a745;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="#" data-i18n="title">Notebook</a>
        <div class="d-flex ms-auto gap-2 align-items-center">
          <div class="input-group input-group-sm" style="width: 250px;">
            <span class="input-group-text" style="background-color: var(--card-bg-color); border-color: var(--border-color); color: var(--text-color);">
              <i class="fas fa-search"></i>
            </span>
            <input type="text" id="search-input" class="form-control form-control-sm" data-i18n-placeholder="searchPlaceholder" placeholder="Search content..." />
          </div>
          <select id="lang-switcher" class="form-select form-select-sm" style="width: auto;">
            <option value="en">English</option>
            <option value="pt">Português</option>
            <option value="ja">日本語</option>
          </select>
          <button id="theme-switcher" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="themeBtn" title="Toggle theme">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- Main container -->
    <div class="main-container">
      <!-- Projects column -->
      <div class="nav-column" id="projects-column">
        <div class="column-header">
          <div class="column-title">
            <i class="fas fa-folder"></i>
            <span class="column-title-text" data-i18n="projects">Projects</span>
          </div>
          <button class="collapse-btn" data-target="projects-column" title="Toggle">
            <i class="fas fa-chevron-left"></i>
          </button>
        </div>
        <div class="column-content">
          <ul class="item-list" id="projects-list"></ul>
          <button class="add-item-btn" id="add-project-btn">
            <i class="fas fa-plus"></i>
            <span class="add-btn-text" data-i18n="addProject">Add Project</span>
          </button>
        </div>
      </div>

      <!-- Books column -->
      <div class="nav-column" id="books-column">
        <div class="column-header">
          <div class="column-title">
            <i class="fas fa-book"></i>
            <span class="column-title-text" data-i18n="books">Books</span>
          </div>
          <button class="collapse-btn" data-target="books-column" title="Toggle">
            <i class="fas fa-chevron-left"></i>
          </button>
        </div>
        <div class="column-content">
          <ul class="item-list" id="books-list"></ul>
          <button class="add-item-btn" id="add-book-btn" style="display: none;">
            <i class="fas fa-plus"></i>
            <span class="add-btn-text" data-i18n="addBook">Add Book</span>
          </button>
        </div>
      </div>

      <!-- Sheets column -->
      <div class="nav-column" id="sheets-column">
        <div class="column-header">
          <div class="column-title">
            <i class="fas fa-file-alt"></i>
            <span class="column-title-text" data-i18n="sheets">Sheets</span>
          </div>
          <button class="collapse-btn" data-target="sheets-column" title="Toggle">
            <i class="fas fa-chevron-left"></i>
          </button>
        </div>
        <div class="column-content">
          <ul class="item-list" id="sheets-list"></ul>
          <button class="add-item-btn" id="add-sheet-btn" style="display: none;">
            <i class="fas fa-plus"></i>
            <span class="add-btn-text" data-i18n="addSheet">Add Sheet</span>
          </button>
        </div>
      </div>

      <!-- Content area -->
      <div class="content-area">
        <div class="content-header">
          <div class="content-path" id="content-path"></div>
          <div class="save-status" id="save-status"></div>
        </div>
        <div class="content-body">
          <div class="no-selection" id="no-selection">
            <i class="fas fa-file-alt"></i>
            <p data-i18n="selectSheet">Select a sheet to view content</p>
          </div>
          <textarea class="content-editor" id="content-editor" style="display: none;" data-i18n-placeholder="contentPlaceholder" placeholder="Start writing..."></textarea>
        </div>
      </div>
    </div>

    <!-- Search Results Modal -->
    <div class="modal fade" id="search-modal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" data-i18n="searchResults">Search Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="search-results"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ============================================
      // i18n Translations
      // ============================================
      const i18n = {
        en: {
          title: 'Notebook',
          projects: 'Projects',
          books: 'Books',
          sheets: 'Sheets',
          addProject: 'Add Project',
          addBook: 'Add Book',
          addSheet: 'Add Sheet',
          searchPlaceholder: 'Search content...',
          searchResults: 'Search Results',
          noResults: 'No results found',
          selectSheet: 'Select a sheet to view content',
          contentPlaceholder: 'Start writing...',
          themeBtn: 'Toggle theme',
          confirmDelete: 'Are you sure you want to delete this item?',
          newProjectName: 'New Project',
          newBookName: 'New Book',
          newSheetName: 'New Sheet',
          rename: 'Rename',
          delete: 'Delete',
          saving: 'Saving...',
          saved: 'Saved',
          enterName: 'Enter name:'
        },
        pt: {
          title: 'Caderno',
          projects: 'Projetos',
          books: 'Livros',
          sheets: 'Folhas',
          addProject: 'Adicionar Projeto',
          addBook: 'Adicionar Livro',
          addSheet: 'Adicionar Folha',
          searchPlaceholder: 'Buscar conteúdo...',
          searchResults: 'Resultados da Busca',
          noResults: 'Nenhum resultado encontrado',
          selectSheet: 'Selecione uma folha para ver o conteúdo',
          contentPlaceholder: 'Comece a escrever...',
          themeBtn: 'Alternar tema',
          confirmDelete: 'Tem certeza que deseja excluir este item?',
          newProjectName: 'Novo Projeto',
          newBookName: 'Novo Livro',
          newSheetName: 'Nova Folha',
          rename: 'Renomear',
          delete: 'Excluir',
          saving: 'Salvando...',
          saved: 'Salvo',
          enterName: 'Digite o nome:'
        },
        ja: {
          title: 'ノートブック',
          projects: 'プロジェクト',
          books: 'ブック',
          sheets: 'シート',
          addProject: 'プロジェクト追加',
          addBook: 'ブック追加',
          addSheet: 'シート追加',
          searchPlaceholder: 'コンテンツを検索...',
          searchResults: '検索結果',
          noResults: '結果が見つかりません',
          selectSheet: 'シートを選択してコンテンツを表示',
          contentPlaceholder: '入力を開始...',
          themeBtn: 'テーマを切り替え',
          confirmDelete: 'このアイテムを削除してもよろしいですか？',
          newProjectName: '新規プロジェクト',
          newBookName: '新規ブック',
          newSheetName: '新規シート',
          rename: '名前変更',
          delete: '削除',
          saving: '保存中...',
          saved: '保存済み',
          enterName: '名前を入力:'
        }
      };

      // ============================================
      // IndexedDB Helper
      // ============================================
      const DB_NAME = 'NotebookDB';
      const DB_VERSION = 1;
      let db = null;

      const openDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            db = request.result;
            resolve(db);
          };

          request.onupgradeneeded = (event) => {
            const database = event.target.result;

            // Projects store
            if (!database.objectStoreNames.contains('projects')) {
              const projectStore = database.createObjectStore('projects', { keyPath: 'id' });
              projectStore.createIndex('order', 'order', { unique: false });
            }

            // Books store
            if (!database.objectStoreNames.contains('books')) {
              const bookStore = database.createObjectStore('books', { keyPath: 'id' });
              bookStore.createIndex('projectId', 'projectId', { unique: false });
              bookStore.createIndex('order', 'order', { unique: false });
            }

            // Sheets store
            if (!database.objectStoreNames.contains('sheets')) {
              const sheetStore = database.createObjectStore('sheets', { keyPath: 'id' });
              sheetStore.createIndex('bookId', 'bookId', { unique: false });
              sheetStore.createIndex('order', 'order', { unique: false });
            }
          };
        });
      };

      const dbAdd = (storeName, data) => {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(storeName, 'readwrite');
          const store = transaction.objectStore(storeName);
          const request = store.add(data);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };

      const dbPut = (storeName, data) => {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(storeName, 'readwrite');
          const store = transaction.objectStore(storeName);
          const request = store.put(data);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };

      const dbDelete = (storeName, id) => {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(storeName, 'readwrite');
          const store = transaction.objectStore(storeName);
          const request = store.delete(id);
          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      };

      const dbGetAll = (storeName) => {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(storeName, 'readonly');
          const store = transaction.objectStore(storeName);
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };

      const dbGet = (storeName, id) => {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(storeName, 'readonly');
          const store = transaction.objectStore(storeName);
          const request = store.get(id);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };

      const dbGetByIndex = (storeName, indexName, value) => {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(storeName, 'readonly');
          const store = transaction.objectStore(storeName);
          const index = store.index(indexName);
          const request = index.getAll(value);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };

      // ============================================
      // App State
      // ============================================
      let currentLanguage = localStorage.getItem('app_lang') || 'en';
      let currentTheme = localStorage.getItem('app_theme') || 'dark';

      let state = {
        selectedProjectId: null,
        selectedBookId: null,
        selectedSheetId: null,
        projects: [],
        books: [],
        sheets: []
      };

      // ============================================
      // DOM Elements
      // ============================================
      const langSwitcher = document.getElementById('lang-switcher');
      const themeSwitcher = document.getElementById('theme-switcher');
      const searchInput = document.getElementById('search-input');
      const searchModal = new bootstrap.Modal(document.getElementById('search-modal'));
      const searchResultsEl = document.getElementById('search-results');

      const projectsList = document.getElementById('projects-list');
      const booksList = document.getElementById('books-list');
      const sheetsList = document.getElementById('sheets-list');

      const addProjectBtn = document.getElementById('add-project-btn');
      const addBookBtn = document.getElementById('add-book-btn');
      const addSheetBtn = document.getElementById('add-sheet-btn');

      const contentPath = document.getElementById('content-path');
      const contentEditor = document.getElementById('content-editor');
      const noSelection = document.getElementById('no-selection');
      const saveStatus = document.getElementById('save-status');

      // ============================================
      // i18n Functions
      // ============================================
      const applyI18n = () => {
        const lang = i18n[currentLanguage] || i18n.en;
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (lang[key]) el.textContent = lang[key];
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          const key = el.getAttribute('data-i18n-placeholder');
          if (lang[key]) el.placeholder = lang[key];
        });
        document.querySelectorAll('[data-i18n-title]').forEach(el => {
          const key = el.getAttribute('data-i18n-title');
          if (lang[key]) el.title = lang[key];
        });
        document.title = lang.title;
      };

      const t = (key) => {
        const lang = i18n[currentLanguage] || i18n.en;
        return lang[key] || key;
      };

      // ============================================
      // Theme Functions
      // ============================================
      const applyTheme = (theme) => {
        document.documentElement.setAttribute('data-theme', theme);
        const icon = themeSwitcher.querySelector('i');
        icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        localStorage.setItem('app_theme', theme);
      };

      // ============================================
      // Generate ID
      // ============================================
      const generateId = () => {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
      };

      // ============================================
      // Render Functions
      // ============================================
      const renderProjects = () => {
        projectsList.innerHTML = '';
        const sortedProjects = [...state.projects].sort((a, b) => a.order - b.order);

        sortedProjects.forEach(project => {
          const li = document.createElement('li');
          li.dataset.id = project.id;
          if (project.id === state.selectedProjectId) {
            li.classList.add('selected');
          }
          li.innerHTML = `
            <span class="item-name">${escapeHtml(project.name)}</span>
            <div class="item-actions">
              <button class="rename-btn" title="${t('rename')}"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" title="${t('delete')}"><i class="fas fa-trash"></i></button>
            </div>
          `;
          li.addEventListener('click', (e) => {
            if (!e.target.closest('.item-actions')) {
              selectProject(project.id);
            }
          });
          li.querySelector('.rename-btn').addEventListener('click', () => renameProject(project.id));
          li.querySelector('.delete-btn').addEventListener('click', () => deleteProject(project.id));
          projectsList.appendChild(li);
        });
      };

      const renderBooks = () => {
        booksList.innerHTML = '';
        const filteredBooks = state.books.filter(b => b.projectId === state.selectedProjectId);
        const sortedBooks = filteredBooks.sort((a, b) => a.order - b.order);

        addBookBtn.style.display = state.selectedProjectId ? 'flex' : 'none';

        sortedBooks.forEach(book => {
          const li = document.createElement('li');
          li.dataset.id = book.id;
          if (book.id === state.selectedBookId) {
            li.classList.add('selected');
          }
          li.innerHTML = `
            <span class="item-name">${escapeHtml(book.name)}</span>
            <div class="item-actions">
              <button class="rename-btn" title="${t('rename')}"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" title="${t('delete')}"><i class="fas fa-trash"></i></button>
            </div>
          `;
          li.addEventListener('click', (e) => {
            if (!e.target.closest('.item-actions')) {
              selectBook(book.id);
            }
          });
          li.querySelector('.rename-btn').addEventListener('click', () => renameBook(book.id));
          li.querySelector('.delete-btn').addEventListener('click', () => deleteBook(book.id));
          booksList.appendChild(li);
        });
      };

      const renderSheets = () => {
        sheetsList.innerHTML = '';
        const filteredSheets = state.sheets.filter(s => s.bookId === state.selectedBookId);
        const sortedSheets = filteredSheets.sort((a, b) => a.order - b.order);

        addSheetBtn.style.display = state.selectedBookId ? 'flex' : 'none';

        sortedSheets.forEach(sheet => {
          const li = document.createElement('li');
          li.dataset.id = sheet.id;
          if (sheet.id === state.selectedSheetId) {
            li.classList.add('selected');
          }
          li.innerHTML = `
            <span class="item-name">${escapeHtml(sheet.name)}</span>
            <div class="item-actions">
              <button class="rename-btn" title="${t('rename')}"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" title="${t('delete')}"><i class="fas fa-trash"></i></button>
            </div>
          `;
          li.addEventListener('click', (e) => {
            if (!e.target.closest('.item-actions')) {
              selectSheet(sheet.id);
            }
          });
          li.querySelector('.rename-btn').addEventListener('click', () => renameSheet(sheet.id));
          li.querySelector('.delete-btn').addEventListener('click', () => deleteSheet(sheet.id));
          sheetsList.appendChild(li);
        });
      };

      const renderContentPath = () => {
        const project = state.projects.find(p => p.id === state.selectedProjectId);
        const book = state.books.find(b => b.id === state.selectedBookId);
        const sheet = state.sheets.find(s => s.id === state.selectedSheetId);

        if (sheet) {
          contentPath.innerHTML = `
            <span>${escapeHtml(project?.name || '')}</span> / 
            <span>${escapeHtml(book?.name || '')}</span> / 
            <strong>${escapeHtml(sheet.name)}</strong>
          `;
        } else {
          contentPath.innerHTML = '';
        }
      };

      const renderContent = () => {
        const sheet = state.sheets.find(s => s.id === state.selectedSheetId);
        renderContentPath();

        if (sheet) {
          noSelection.style.display = 'none';
          contentEditor.style.display = 'block';
          contentEditor.value = sheet.content || '';
        } else {
          noSelection.style.display = 'flex';
          contentEditor.style.display = 'none';
        }
      };

      // ============================================
      // Selection Functions
      // ============================================
      const selectProject = async (projectId) => {
        state.selectedProjectId = projectId;
        state.selectedBookId = null;
        state.selectedSheetId = null;
        renderProjects();
        renderBooks();
        renderSheets();
        renderContent();
        saveState();
      };

      const selectBook = async (bookId) => {
        state.selectedBookId = bookId;
        state.selectedSheetId = null;
        renderBooks();
        renderSheets();
        renderContent();
        saveState();
      };

      const selectSheet = async (sheetId) => {
        state.selectedSheetId = sheetId;
        renderSheets();
        renderContent();
        saveState();
      };

      // ============================================
      // CRUD Operations
      // ============================================
      const addProject = async () => {
        const name = prompt(t('enterName'), t('newProjectName'));
        if (!name || !name.trim()) return;

        const project = {
          id: generateId(),
          name: name.trim(),
          order: state.projects.length,
          createdAt: Date.now()
        };

        await dbAdd('projects', project);
        state.projects.push(project);
        renderProjects();
        selectProject(project.id);
      };

      const renameProject = async (projectId) => {
        const project = state.projects.find(p => p.id === projectId);
        if (!project) return;

        const name = prompt(t('enterName'), project.name);
        if (!name || !name.trim()) return;

        project.name = name.trim();
        await dbPut('projects', project);
        renderProjects();
        renderContentPath();
      };

      const deleteProject = async (projectId) => {
        if (!confirm(t('confirmDelete'))) return;

        // Delete all books and sheets in this project
        const booksToDelete = state.books.filter(b => b.projectId === projectId);
        for (const book of booksToDelete) {
          const sheetsToDelete = state.sheets.filter(s => s.bookId === book.id);
          for (const sheet of sheetsToDelete) {
            await dbDelete('sheets', sheet.id);
          }
          await dbDelete('books', book.id);
        }
        await dbDelete('projects', projectId);

        state.sheets = state.sheets.filter(s => !booksToDelete.find(b => b.id === s.bookId));
        state.books = state.books.filter(b => b.projectId !== projectId);
        state.projects = state.projects.filter(p => p.id !== projectId);

        if (state.selectedProjectId === projectId) {
          state.selectedProjectId = null;
          state.selectedBookId = null;
          state.selectedSheetId = null;
        }

        renderProjects();
        renderBooks();
        renderSheets();
        renderContent();
      };

      const addBook = async () => {
        if (!state.selectedProjectId) return;

        const name = prompt(t('enterName'), t('newBookName'));
        if (!name || !name.trim()) return;

        const booksInProject = state.books.filter(b => b.projectId === state.selectedProjectId);
        const book = {
          id: generateId(),
          projectId: state.selectedProjectId,
          name: name.trim(),
          order: booksInProject.length,
          createdAt: Date.now()
        };

        await dbAdd('books', book);
        state.books.push(book);
        renderBooks();
        selectBook(book.id);
      };

      const renameBook = async (bookId) => {
        const book = state.books.find(b => b.id === bookId);
        if (!book) return;

        const name = prompt(t('enterName'), book.name);
        if (!name || !name.trim()) return;

        book.name = name.trim();
        await dbPut('books', book);
        renderBooks();
        renderContentPath();
      };

      const deleteBook = async (bookId) => {
        if (!confirm(t('confirmDelete'))) return;

        // Delete all sheets in this book
        const sheetsToDelete = state.sheets.filter(s => s.bookId === bookId);
        for (const sheet of sheetsToDelete) {
          await dbDelete('sheets', sheet.id);
        }
        await dbDelete('books', bookId);

        state.sheets = state.sheets.filter(s => s.bookId !== bookId);
        state.books = state.books.filter(b => b.id !== bookId);

        if (state.selectedBookId === bookId) {
          state.selectedBookId = null;
          state.selectedSheetId = null;
        }

        renderBooks();
        renderSheets();
        renderContent();
      };

      const addSheet = async () => {
        if (!state.selectedBookId) return;

        const name = prompt(t('enterName'), t('newSheetName'));
        if (!name || !name.trim()) return;

        const sheetsInBook = state.sheets.filter(s => s.bookId === state.selectedBookId);
        const sheet = {
          id: generateId(),
          bookId: state.selectedBookId,
          name: name.trim(),
          content: '',
          order: sheetsInBook.length,
          createdAt: Date.now(),
          updatedAt: Date.now()
        };

        await dbAdd('sheets', sheet);
        state.sheets.push(sheet);
        renderSheets();
        selectSheet(sheet.id);
      };

      const renameSheet = async (sheetId) => {
        const sheet = state.sheets.find(s => s.id === sheetId);
        if (!sheet) return;

        const name = prompt(t('enterName'), sheet.name);
        if (!name || !name.trim()) return;

        sheet.name = name.trim();
        await dbPut('sheets', sheet);
        renderSheets();
        renderContentPath();
      };

      const deleteSheet = async (sheetId) => {
        if (!confirm(t('confirmDelete'))) return;

        await dbDelete('sheets', sheetId);
        state.sheets = state.sheets.filter(s => s.id !== sheetId);

        if (state.selectedSheetId === sheetId) {
          state.selectedSheetId = null;
        }

        renderSheets();
        renderContent();
      };

      // ============================================
      // Content Saving
      // ============================================
      let saveTimeout = null;

      const saveContent = async () => {
        const sheet = state.sheets.find(s => s.id === state.selectedSheetId);
        if (!sheet) return;

        saveStatus.textContent = t('saving');
        saveStatus.className = 'save-status saving';

        sheet.content = contentEditor.value;
        sheet.updatedAt = Date.now();
        await dbPut('sheets', sheet);

        saveStatus.textContent = t('saved');
        saveStatus.className = 'save-status saved';

        setTimeout(() => {
          saveStatus.textContent = '';
        }, 2000);
      };

      const scheduleContentSave = () => {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveContent, 500);
      };

      // ============================================
      // Search Functions
      // ============================================
      const performSearch = (query) => {
        if (!query.trim()) return;

        const queryLower = query.toLowerCase();
        const results = [];

        state.sheets.forEach(sheet => {
          if (sheet.content && sheet.content.toLowerCase().includes(queryLower)) {
            const book = state.books.find(b => b.id === sheet.bookId);
            const project = state.projects.find(p => p.id === book?.projectId);

            results.push({
              sheet,
              book,
              project,
              preview: getSearchPreview(sheet.content, query)
            });
          }
        });

        renderSearchResults(results, query);
        searchModal.show();
      };

      const getSearchPreview = (content, query) => {
        const queryLower = query.toLowerCase();
        const contentLower = content.toLowerCase();
        const index = contentLower.indexOf(queryLower);

        if (index === -1) return content.slice(0, 100);

        const start = Math.max(0, index - 30);
        const end = Math.min(content.length, index + query.length + 70);
        let preview = content.slice(start, end);

        if (start > 0) preview = '...' + preview;
        if (end < content.length) preview = preview + '...';

        // Highlight the match
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        preview = escapeHtml(preview).replace(regex, '<mark>$1</mark>');

        return preview;
      };

      const renderSearchResults = (results, query) => {
        if (results.length === 0) {
          searchResultsEl.innerHTML = `<div class="empty-state">${t('noResults')}</div>`;
          return;
        }

        searchResultsEl.innerHTML = results.map(result => `
          <div class="search-result-item" data-project-id="${result.project?.id}" data-book-id="${result.book?.id}" data-sheet-id="${result.sheet.id}">
            <div class="search-result-path">
              ${escapeHtml(result.project?.name || '')} / ${escapeHtml(result.book?.name || '')} / ${escapeHtml(result.sheet.name)}
            </div>
            <div class="search-result-preview">${result.preview}</div>
          </div>
        `).join('');

        searchResultsEl.querySelectorAll('.search-result-item').forEach(item => {
          item.addEventListener('click', () => {
            const projectId = item.dataset.projectId;
            const bookId = item.dataset.bookId;
            const sheetId = item.dataset.sheetId;

            state.selectedProjectId = projectId;
            state.selectedBookId = bookId;
            state.selectedSheetId = sheetId;

            renderProjects();
            renderBooks();
            renderSheets();
            renderContent();
            saveState();

            searchModal.hide();
          });
        });
      };

      // ============================================
      // State Persistence
      // ============================================
      const saveState = () => {
        localStorage.setItem('notebook_state', JSON.stringify({
          selectedProjectId: state.selectedProjectId,
          selectedBookId: state.selectedBookId,
          selectedSheetId: state.selectedSheetId
        }));
      };

      const loadState = () => {
        try {
          const saved = localStorage.getItem('notebook_state');
          if (saved) {
            const parsed = JSON.parse(saved);
            state.selectedProjectId = parsed.selectedProjectId;
            state.selectedBookId = parsed.selectedBookId;
            state.selectedSheetId = parsed.selectedSheetId;
          }
        } catch (e) {
          // ignore
        }
      };

      // ============================================
      // Column Collapse
      // ============================================
      const setupCollapseButtons = () => {
        document.querySelectorAll('.collapse-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const targetId = btn.dataset.target;
            const column = document.getElementById(targetId);
            column.classList.toggle('collapsed');

            // Save collapse state
            const collapseState = {};
            document.querySelectorAll('.nav-column').forEach(col => {
              collapseState[col.id] = col.classList.contains('collapsed');
            });
            localStorage.setItem('notebook_collapse', JSON.stringify(collapseState));
          });
        });

        // Restore collapse state
        try {
          const saved = localStorage.getItem('notebook_collapse');
          if (saved) {
            const collapseState = JSON.parse(saved);
            Object.entries(collapseState).forEach(([id, collapsed]) => {
              const column = document.getElementById(id);
              if (column && collapsed) {
                column.classList.add('collapsed');
              }
            });
          }
        } catch (e) {
          // ignore
        }
      };

      // ============================================
      // Utility Functions
      // ============================================
      const escapeHtml = (str) => {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      };

      const escapeRegex = (str) => {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      };

      // ============================================
      // Event Listeners
      // ============================================
      const setupEventListeners = () => {
        // Language switcher
        langSwitcher.addEventListener('change', (e) => {
          currentLanguage = e.target.value;
          localStorage.setItem('app_lang', currentLanguage);
          applyI18n();
          renderProjects();
          renderBooks();
          renderSheets();
        });

        // Theme switcher
        themeSwitcher.addEventListener('click', () => {
          currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
          applyTheme(currentTheme);
        });

        // Search
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            performSearch(searchInput.value);
          }
        });

        // Add buttons
        addProjectBtn.addEventListener('click', addProject);
        addBookBtn.addEventListener('click', addBook);
        addSheetBtn.addEventListener('click', addSheet);

        // Content editor
        contentEditor.addEventListener('input', scheduleContentSave);

        // Collapse buttons
        setupCollapseButtons();
      };

      // ============================================
      // Initialization
      // ============================================
      const init = async () => {
        // Open database
        await openDB();

        // Load data from IndexedDB
        state.projects = await dbGetAll('projects');
        state.books = await dbGetAll('books');
        state.sheets = await dbGetAll('sheets');

        // Load UI state
        loadState();

        // Validate state (ensure selected items still exist)
        if (state.selectedProjectId && !state.projects.find(p => p.id === state.selectedProjectId)) {
          state.selectedProjectId = null;
        }
        if (state.selectedBookId && !state.books.find(b => b.id === state.selectedBookId)) {
          state.selectedBookId = null;
        }
        if (state.selectedSheetId && !state.sheets.find(s => s.id === state.selectedSheetId)) {
          state.selectedSheetId = null;
        }

        // Setup UI
        langSwitcher.value = currentLanguage;
        applyI18n();
        applyTheme(currentTheme);

        // Render
        renderProjects();
        renderBooks();
        renderSheets();
        renderContent();

        // Setup events
        setupEventListeners();
      };

      // Start the app
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
