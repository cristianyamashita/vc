<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forex Times</title>
  <style>
    /* Color tokens */
    :root{
      --bg:#0b0e14; --fg:#e6e6e6; --muted:#9aa4b2; --card:#101521; --border:#1e2636;
      --accent:#2c5894; --accent-2: color-mix(in oklch, var(--accent), white 15%);
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --ring: color-mix(in oklch, var(--accent), white 35%);
      --shadow: 0 10px 25px -12px rgba(0,0,0,.35);
      --radius:.8rem;
      --surface-1: color-mix(in oklch, var(--card), black 6%);
      --surface-2: color-mix(in oklch, var(--card), black 12%);
    }
    [data-theme="light"]{
      --bg:#f7fafc; --fg:#0f172a; --muted:#475569; --card:#ffffff; --border:#e5e7eb;
      --accent:#418ffd; --accent-2: color-mix(in oklch, var(--accent), black 5%);
      --ok:#16a34a; --warn:#d97706; --err:#dc2626;
      --ring: color-mix(in oklch, var(--accent), white 30%);
      --shadow: 0 10px 25px -14px rgba(2,6,23,.25);
      --surface-1: color-mix(in oklch, var(--card), black 2%);
      --surface-2: color-mix(in oklch, var(--card), black 6%);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      transition: background .25s ease, color .25s ease;
    }

    /* Header - translucent bar */
    header{
      position:sticky; top:0; z-index:5;
      background: color-mix(in oklch, var(--card), transparent 20%);
      -webkit-backdrop-filter: saturate(160%) blur(8px);
      backdrop-filter: saturate(160%) blur(8px);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:.75rem; padding:.6rem 1rem;
    }
    header h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.1px}
    .spacer{flex:1}

    /* Buttons */
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--surface-1); color:var(--fg);
      padding:.5rem .8rem; border-radius:calc(var(--radius) - .2rem); cursor:pointer;
      transition: border-color .2s ease, background .2s ease, transform .05s ease, box-shadow .2s ease;
      display:inline-flex; align-items:center; gap:.45rem; font-weight:600;
    }
    .btn:hover{border-color: color-mix(in oklch, var(--border), var(--fg) 20%); background:var(--surface-2)}
    .btn:active{transform: translateY(1px)}
    .btn:focus-visible{outline:2px solid var(--ring); outline-offset:2px}
    .btn.primary{
      background: linear-gradient(180deg, var(--accent-2), var(--accent));
      border-color: color-mix(in oklch, var(--accent), black 10%);
      color:#fff; box-shadow: var(--shadow);
    }
    .btn.primary:hover{filter:saturate(1.05) brightness(1.02)}
    .btn.ghost{border-color:transparent; background:transparent}

    main{max-width:1100px;margin:1rem auto;padding:0 1rem}

    /* Time display */
    .time-display {
      text-align: center;
      margin: 2rem 0;
      padding: 2rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    
    .local-time {
      font-size: 3rem;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 1rem;
      font-family: 'Courier New', monospace;
    }
    
    .local-date {
      font-size: 1.2rem;
      color: var(--muted);
      margin-bottom: 1rem;
    }
    
    .server-time-label {
      font-size: 1rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    
    .forex-servers {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--warn);
      margin-bottom: 2rem;
      font-family: 'Courier New', monospace;
    }
    
    .market-times {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }
    
    .market-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }
    
    .market-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .market-flag {
      width: 40px;
      height: 30px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: bold;
    }
    
    .market-name {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--fg);
    }
    
    .market-time {
      font-size: 2rem;
      font-weight: bold;
      color: var(--accent);
      font-family: 'Courier New', monospace;
      margin: 1rem 0;
    }
    
    .market-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .status-label {
      font-size: 0.9rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-value {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--ok);
      font-family: 'Courier New', monospace;
    }
    
    .status-value.closing {
      color: var(--warn);
    }
    
    .status-value.closed {
      color: var(--err);
    }
    
    .refresh-info {
      text-align: center;
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 2rem;
    }
    
    .error {
      color: var(--err);
      background: color-mix(in oklch, var(--err), transparent 90%);
      padding: 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--err);
      margin: 1rem 0;
    }
    
    .loading {
      color: var(--muted);
      text-align: center;
      padding: 2rem;
    }
    
    @media (prefers-reduced-motion: reduce){
      *{transition:none!important}
    }
  </style>
</head>
<body>
  <header>
    <h1 id="appTitle">Forex Times</h1>
    <div class="spacer"></div>
    <select id="langSelect" style="border:1px solid var(--border);background:transparent;color:var(--fg);padding:.15rem .3rem;font-size:.92em;border-radius:.4rem;cursor:pointer;min-width:unset;max-width:90px">
      <option value="en">English</option>
      <option value="pt">PortuguÃªs</option>
      <option value="ja">æ—¥æœ¬èªž</option>
    </select>
    <button class="btn ghost" id="themeToggle" title="Toggle theme">Theme</button>
  </header>

  <main>
    <div class="time-display">
      <div class="local-time" id="localTime">--:--:--</div>
      <div class="local-date" id="localDate">--</div>
      <div class="server-time-label" id="serverTimeLabel">Server time</div>
      <div class="forex-servers" id="forexServers">--:--:--</div>
    </div>

    <div class="market-times">
      <div class="market-card">
        <div class="market-header">
          <div class="market-flag" style="background: #ff6b6b; color: white;">ðŸ‡¯ðŸ‡µ</div>
          <div class="market-name" id="tokyoName">Tokyo</div>
        </div>
        <div class="market-time" id="tokyoTime">--:--:--</div>
        <div class="market-status">
          <span class="status-label" id="tokyoStatusLabel">Status</span>
          <span class="status-value" id="tokyoStatus">--</span>
        </div>
      </div>

      <div class="market-card">
        <div class="market-header">
          <div class="market-flag" style="background: #4ecdc4; color: white;">ðŸ‡¬ðŸ‡§</div>
          <div class="market-name" id="londonName">London</div>
        </div>
        <div class="market-time" id="londonTime">--:--:--</div>
        <div class="market-status">
          <span class="status-label" id="londonStatusLabel">Status</span>
          <span class="status-value" id="londonStatus">--</span>
        </div>
      </div>

      <div class="market-card">
        <div class="market-header">
          <div class="market-flag" style="background: #45b7d1; color: white;">ðŸ‡ºðŸ‡¸</div>
          <div class="market-name" id="newyorkName">New York</div>
        </div>
        <div class="market-time" id="newyorkTime">--:--:--</div>
        <div class="market-status">
          <span class="status-label" id="newyorkStatusLabel">Status</span>
          <span class="status-value" id="newyorkStatus">--</span>
        </div>
      </div>
    </div>

    <div class="refresh-info" id="refreshInfo">Refreshing every second</div>
  </main>

<script>
(() => {
  // --- State and utilities ---
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
  const LKEY = 'forex_lang';

  const state = {
    theme: localStorage.getItem('app_theme') || 'dark',
    lang: localStorage.getItem(LKEY) || 'en',
  };
  document.body.dataset.theme = state.theme;

  const setTheme = t => { state.theme = t; document.body.dataset.theme = t; localStorage.setItem('app_theme', t); };

  // --- i18n ---
  const I18N = {
    en: {
      appTitle: 'Forex Times',
      docTitle: 'Forex Times â€” Market Hours and Server Time',
      themeBtn: 'Theme',
      refreshInfo: 'Refreshing every second',
      serverTime: 'Server time',
      tokyoName: 'Tokyo',
      londonName: 'London',
      newyorkName: 'New York',
      hoursToOpen: 'Hours to open',
      hoursToClose: 'Hours to close',
      marketClosed: 'Market closed',
      marketOpen: 'Market open',
      loading: 'Loading...',
      error: 'Error loading data',
      status: 'Status'
    },
    pt: {
      appTitle: 'HorÃ¡rios Forex',
      docTitle: 'HorÃ¡rios Forex â€” Horas de Mercado e Hora do Servidor',
      themeBtn: 'Tema',
      refreshInfo: 'Atualizando a cada segundo',
      serverTime: 'Hora do servidor',
      tokyoName: 'TÃ³quio',
      londonName: 'Londres',
      newyorkName: 'Nova York',
      hoursToOpen: 'Horas para abrir',
      hoursToClose: 'Horas para fechar',
      marketClosed: 'Mercado fechado',
      marketOpen: 'Mercado aberto',
      loading: 'Carregando...',
      error: 'Erro ao carregar dados',
      status: 'Status'
    },
    ja: {
      appTitle: 'ãƒ•ã‚©ãƒ¬ãƒƒã‚¯ã‚¹æ™‚é–“',
      docTitle: 'ãƒ•ã‚©ãƒ¬ãƒƒã‚¯ã‚¹æ™‚é–“ â€” å¸‚å ´æ™‚é–“ã¨ã‚µãƒ¼ãƒãƒ¼æ™‚é–“',
      themeBtn: 'ãƒ†ãƒ¼ãƒž',
      refreshInfo: '1ç§’ã”ã¨ã«æ›´æ–°',
      serverTime: 'ã‚µãƒ¼ãƒãƒ¼æ™‚é–“',
      tokyoName: 'æ±äº¬',
      londonName: 'ãƒ­ãƒ³ãƒ‰ãƒ³',
      newyorkName: 'ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯',
      hoursToOpen: 'ã‚ªãƒ¼ãƒ—ãƒ³ã¾ã§',
      hoursToClose: 'ã‚¯ãƒ­ãƒ¼ã‚ºã¾ã§',
      marketClosed: 'å¸‚å ´é–‰éŽ–',
      marketOpen: 'å¸‚å ´ã‚ªãƒ¼ãƒ—ãƒ³',
      loading: 'èª­ã¿è¾¼ã¿ä¸­...',
      error: 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼',
      status: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
    }
  };

  function t(key){
    return (I18N[state.lang] && I18N[state.lang][key]) || I18N.en[key] || key;
  }

  function translatePage(){
    document.getElementById('appTitle').textContent = t('appTitle');
    document.getElementById('themeToggle').textContent = t('themeBtn');
    document.getElementById('refreshInfo').textContent = t('refreshInfo');
    document.getElementById('serverTimeLabel').textContent = t('serverTime');
    document.getElementById('tokyoName').textContent = t('tokyoName');
    document.getElementById('londonName').textContent = t('londonName');
    document.getElementById('newyorkName').textContent = t('newyorkName');
    document.getElementById('tokyoStatusLabel').textContent = t('status');
    document.getElementById('londonStatusLabel').textContent = t('status');
    document.getElementById('newyorkStatusLabel').textContent = t('status');
    document.title = t('docTitle');
    document.documentElement.lang = state.lang === 'pt' ? 'pt-BR' : (state.lang === 'ja' ? 'ja' : 'en');
  }

  // --- Time utilities ---
  function formatTime(date) {
    return date.toLocaleTimeString('en-US', { 
      hour12: false, 
      hour: '2-digit', 
      minute: '2-digit'
      // , 
      // second: '2-digit' 
    });
  }

  function formatDate(date) {
    return date.toLocaleDateString(state.lang === 'pt' ? 'pt-BR' : (state.lang === 'ja' ? 'ja-JP' : 'en-US'), {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  function getNextMonday(date) {
    const nextMonday = new Date(date);
    nextMonday.setDate(date.getDate() + (8 - date.getDay()) % 7);
    nextMonday.setHours(9, 0, 0, 0);
    return nextMonday;
  }

  function getNextDay9AM(date) {
    const nextDay = new Date(date);
    nextDay.setDate(date.getDate() + 1);
    nextDay.setHours(9, 0, 0, 0);
    return nextDay;
  }

  function getNextDay8AM(date) {
    const nextDay = new Date(date);
    nextDay.setDate(date.getDate() + 1);
    nextDay.setHours(8, 0, 0, 0);
    return nextDay;
  }

  function getNextDay6PM(date) {
    const nextDay = new Date(date);
    nextDay.setDate(date.getDate() + 1);
    nextDay.setHours(18, 0, 0, 0);
    return nextDay;
  }

  function getNextDay5PM(date) {
    const nextDay = new Date(date);
    nextDay.setDate(date.getDate() + 1);
    nextDay.setHours(17, 0, 0, 0);
    return nextDay;
  }

  function calculateHoursTo(targetTime) {
    const now = new Date();
    const diff = targetTime - now;
    const hours = Math.ceil(diff / (1000 * 60 * 60));
    return hours > 0 ? hours : 0;
  }

  function calculateHoursToFromDate(fromDate, targetTime) {
    const diff = targetTime - fromDate;
    const hours = Math.ceil(diff / (1000 * 60 * 60));
    return hours > 0 ? hours : 0;
  }

  function formatTimeRemaining(fromDate, targetTime) {
    const diff = targetTime - fromDate;
    if (diff <= 0) return '00:00';
    
    const totalMinutes = Math.ceil(diff / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
  }

  function isWeekend(date) {
    const day = date.getDay();
    return day === 0 || day === 6; // Sunday = 0, Saturday = 6
  }

  // --- Market status calculations ---
  function calculateTokyoStatus(tokyoTime) {
    const hour = tokyoTime.getHours();
    const isWeekendDay = isWeekend(tokyoTime);
    
    if (hour >= 18) {
      // After 6 PM - market closed, next opening is tomorrow 9 AM
      if (isWeekendDay) {
        const nextMonday = getNextMonday(tokyoTime);
        const hours = calculateHoursToFromDate(tokyoTime, nextMonday);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(tokyoTime, nextMonday), label: t('hoursToOpen') };
      } else {
        const nextDay9AM = getNextDay9AM(tokyoTime);
        const hours = calculateHoursToFromDate(tokyoTime, nextDay9AM);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(tokyoTime, nextDay9AM), label: t('hoursToOpen') };
      }
    } else if (hour < 9) {
      // Before 9 AM - market closed, next opening is today 9 AM
      if (isWeekendDay) {
        const nextMonday = getNextMonday(tokyoTime);
        const hours = calculateHoursToFromDate(tokyoTime, nextMonday);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(tokyoTime, nextMonday), label: t('hoursToOpen') };
      } else {
        const today9AM = new Date(tokyoTime);
        today9AM.setHours(9, 0, 0, 0);
        const hours = calculateHoursToFromDate(tokyoTime, today9AM);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(tokyoTime, today9AM), label: t('hoursToOpen') };
      }
    } else {
      // Between 9 AM and 6 PM - market open, next closing is 6 PM
      if (isWeekendDay) {
        const nextMonday = getNextMonday(tokyoTime);
        const hours = calculateHoursToFromDate(tokyoTime, nextMonday);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(tokyoTime, nextMonday), label: t('hoursToOpen') };
      } else {
        const today6PM = new Date(tokyoTime);
        today6PM.setHours(18, 0, 0, 0);
        const hours = calculateHoursToFromDate(tokyoTime, today6PM);
        return { type: 'closing', hours: hours, timeRemaining: formatTimeRemaining(tokyoTime, today6PM), label: t('hoursToClose') };
      }
    }
  }

  function calculateLondonStatus(londonTime) {
    const hour = londonTime.getHours();
    const isWeekendDay = isWeekend(londonTime);
    
    if (hour >= 17) {
      // After 5 PM - market closed, next opening is tomorrow 8 AM
      if (isWeekendDay) {
        const nextMonday = getNextMonday(londonTime);
        const hours = calculateHoursToFromDate(londonTime, nextMonday);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(londonTime, nextMonday), label: t('hoursToOpen') };
      } else {
        const nextDay8AM = getNextDay8AM(londonTime);
        const hours = calculateHoursToFromDate(londonTime, nextDay8AM);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(londonTime, nextDay8AM), label: t('hoursToOpen') };
      }
    } else if (hour < 8) {
      // Before 8 AM - market closed, next opening is today 8 AM
      if (isWeekendDay) {
        const nextMonday = getNextMonday(londonTime);
        const hours = calculateHoursToFromDate(londonTime, nextMonday);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(londonTime, nextMonday), label: t('hoursToOpen') };
      } else {
        const today8AM = new Date(londonTime);
        today8AM.setHours(8, 0, 0, 0);
        const hours = calculateHoursToFromDate(londonTime, today8AM);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(londonTime, today8AM), label: t('hoursToOpen') };
      }
    } else {
      // Between 8 AM and 5 PM - market open, next closing is 5 PM
      if (isWeekendDay) {
        const nextMonday = getNextMonday(londonTime);
        const hours = calculateHoursToFromDate(londonTime, nextMonday);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(londonTime, nextMonday), label: t('hoursToOpen') };
      } else {
        const today5PM = new Date(londonTime);
        today5PM.setHours(17, 0, 0, 0);
        const hours = calculateHoursToFromDate(londonTime, today5PM);
        return { type: 'closing', hours: hours, timeRemaining: formatTimeRemaining(londonTime, today5PM), label: t('hoursToClose') };
      }
    }
  }

  function calculateNewYorkStatus(newyorkTime) {
    const hour = newyorkTime.getHours();
    const isWeekendDay = isWeekend(newyorkTime);
    
    if (hour >= 17) {
      // After 5 PM - market closed, next opening is tomorrow 8 AM
      if (isWeekendDay) {
        const nextMonday = getNextMonday(newyorkTime);
        const hours = calculateHoursToFromDate(newyorkTime, nextMonday);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(newyorkTime, nextMonday), label: t('hoursToOpen') };
      } else {
        const nextDay8AM = getNextDay8AM(newyorkTime);
        const hours = calculateHoursToFromDate(newyorkTime, nextDay8AM);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(newyorkTime, nextDay8AM), label: t('hoursToOpen') };
      }
    } else if (hour < 8) {
      // Before 8 AM - market closed, next opening is today 8 AM
      if (isWeekendDay) {
        const nextMonday = getNextMonday(newyorkTime);
        const hours = calculateHoursToFromDate(newyorkTime, nextMonday);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(newyorkTime, nextMonday), label: t('hoursToOpen') };
      } else {
        const today8AM = new Date(newyorkTime);
        today8AM.setHours(8, 0, 0, 0);
        const hours = calculateHoursToFromDate(newyorkTime, today8AM);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(newyorkTime, today8AM), label: t('hoursToOpen') };
      }
    } else {
      // Between 8 AM and 5 PM - market open, next closing is 5 PM
      if (isWeekendDay) {
        const nextMonday = getNextMonday(newyorkTime);
        const hours = calculateHoursToFromDate(newyorkTime, nextMonday);
        return { type: 'opening', hours: hours, timeRemaining: formatTimeRemaining(newyorkTime, nextMonday), label: t('hoursToOpen') };
      } else {
        const today5PM = new Date(newyorkTime);
        today5PM.setHours(17, 0, 0, 0);
        const hours = calculateHoursToFromDate(newyorkTime, today5PM);
        return { type: 'closing', hours: hours, timeRemaining: formatTimeRemaining(newyorkTime, today5PM), label: t('hoursToClose') };
      }
    }
  }

  // --- API calls ---
  async function fetchTimeZone(timezone) {
    try {
      // For now, let's force fallback to test the timezone calculations
      console.log(`Forcing fallback for ${timezone} to test timezone calculations`);
      return getFallbackTime(timezone);
      
      // Original API code commented out for testing
      /*
      // Try to use a CORS proxy if direct fetch fails
      const urls = [
        `https://worldtimeapi.org/api/timezone/${timezone}`,
        `https://cors-anywhere.herokuapp.com/https://worldtimeapi.org/api/timezone/${timezone}`,
        `https://api.allorigins.win/raw?url=https://worldtimeapi.org/api/timezone/${timezone}`
      ];
      
      for (const url of urls) {
        try {
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'User-Agent': 'Mozilla/5.0 (compatible; ForexTimes/1.0)'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.datetime) {
              return new Date(data.datetime);
            }
          }
        } catch (e) {
          console.warn(`Failed to fetch from ${url}:`, e);
          continue;
        }
      }
      
      // Fallback: simulate timezone based on current time
      console.warn(`Using fallback for ${timezone}`);
      return getFallbackTime(timezone);
      */
      
    } catch (error) {
      console.error(`Error fetching ${timezone}:`, error);
      return getFallbackTime(timezone);
    }
  }

  function getFallbackTime(timezone) {
    const now = new Date();
    
    // Get current UTC time
    const utc = new Date(now.getTime() + (now.getTimezoneOffset() * 60000));
    
    let offset = 0;
    switch (timezone) {
      case 'Asia/Tokyo':
        offset = 9 * 60; // UTC+9
        break;
      case 'Europe/London':
        // August is in DST (British Summer Time)
        offset = 1 * 60; // UTC+1 (BST)
        break;
      case 'America/New_York':
        // August is in DST (Eastern Daylight Time)
        offset = -4 * 60; // UTC-4 (EDT)
        break;
      default:
        offset = 0;
    }
    
    // Create time in the target timezone
    const fallbackTime = new Date(utc.getTime() + (offset * 60000));
    
    // console.log(`Fallback time for ${timezone}:`, {
    //   localTime: now.toISOString(),
    //   utcTime: utc.toISOString(),
    //   targetTime: fallbackTime.toISOString(),
    //   offset: `${offset} minutes`,
    //   formatted: formatTime(fallbackTime)
    // });
    
    return fallbackTime;
  }

  // --- Update functions ---
  function updateLocalTime() {
    const now = new Date();
    document.getElementById('localTime').textContent = formatTime(now);
    document.getElementById('localDate').textContent = formatDate(now);
    
    // Also update market times every second to keep them current
    updateMarketTimesRealTime();
  }

  function updateForexServers() {
    const now = new Date();
    // Forex servers consider 18:00 NY time as 00:00
    const nyTime = new Date(now.getTime() + (now.getTimezoneOffset() - 4 * 60) * 60000); // EST offset
    const forexTime = new Date(nyTime);
    forexTime.setHours(nyTime.getHours() - 18);
    if (forexTime.getHours() < 0) {
      forexTime.setDate(forexTime.getDate() - 1);
      forexTime.setHours(forexTime.getHours() + 24);
    }
    
    // Add 1 hour to correct the time
    forexTime.setHours(forexTime.getHours() + 1);
    
    const hours = forexTime.getHours().toString().padStart(2, '0');
    const minutes = forexTime.getMinutes().toString().padStart(2, '0');
    const seconds = forexTime.getSeconds().toString().padStart(2, '0');
    
    document.getElementById('forexServers').textContent = `${hours}:${minutes}:${seconds}`;
  }

  async function updateMarketTimes() {
    try {
      console.log('Updating market times...');
      
      // Fetch all timezone data
      const [tokyoData, londonData, newyorkData] = await Promise.all([
        fetchTimeZone('Asia/Tokyo'),
        fetchTimeZone('Europe/London'),
        fetchTimeZone('America/New_York')
      ]);

      console.log('Fetched data:', { tokyoData, londonData, newyorkData });

      // Update Tokyo
      if (tokyoData) {
        document.getElementById('tokyoTime').textContent = formatTime(tokyoData);
        const status = calculateTokyoStatus(tokyoData);
        console.log('Tokyo status:', status);
        document.getElementById('tokyoStatus').textContent = status.timeRemaining || `${status.hours}h`;
        document.getElementById('tokyoStatus').className = `status-value ${status.type}`;
        document.getElementById('tokyoStatusLabel').textContent = status.label;
      } else {
        console.error('Failed to get Tokyo data');
        document.getElementById('tokyoTime').textContent = '--:--:--';
        document.getElementById('tokyoStatus').textContent = '--';
      }

      // Update London
      if (londonData) {
        console.log('London time data:', londonData, 'formatted:', formatTime(londonData));
        document.getElementById('londonTime').textContent = formatTime(londonData);
        const status = calculateLondonStatus(londonData);
        console.log('London status calculation:', status);
        document.getElementById('londonStatus').textContent = status.timeRemaining || `${status.hours}h`;
        document.getElementById('londonStatus').className = `status-value ${status.type}`;
        document.getElementById('londonStatusLabel').textContent = status.label;
      } else {
        console.error('Failed to get London data');
        document.getElementById('londonTime').textContent = '--:--:--';
        document.getElementById('londonStatus').textContent = '--';
      }

      // Update New York
      if (newyorkData) {
        console.log('New York time data:', newyorkData, 'formatted:', formatTime(newyorkData));
        document.getElementById('newyorkTime').textContent = formatTime(newyorkData);
        const status = calculateNewYorkStatus(newyorkData);
        console.log('New York status calculation:', status);
        document.getElementById('newyorkStatus').textContent = status.timeRemaining || `${status.hours}h`;
        document.getElementById('newyorkStatus').className = `status-value ${status.type}`;
        document.getElementById('newyorkStatusLabel').textContent = status.label;
      } else {
        console.error('Failed to get New York data');
        document.getElementById('newyorkTime').textContent = '--:--:--';
        document.getElementById('newyorkStatus').textContent = '--';
      }

    } catch (error) {
      console.error('Error updating market times:', error);
    }
  }

  function updateMarketTimesRealTime() {
    try {
      // Get current times for each timezone using fallback
      const tokyoTime = getFallbackTime('Asia/Tokyo');
      const londonTime = getFallbackTime('Europe/London');
      const newyorkTime = getFallbackTime('America/New_York');

      // Update Tokyo
      document.getElementById('tokyoTime').textContent = formatTime(tokyoTime);
      const tokyoStatus = calculateTokyoStatus(tokyoTime);
      document.getElementById('tokyoStatus').textContent = tokyoStatus.timeRemaining || `${tokyoStatus.hours}h`;
      document.getElementById('tokyoStatus').className = `status-value ${tokyoStatus.type}`;
      document.getElementById('tokyoStatusLabel').textContent = tokyoStatus.label;

      // Update London
      document.getElementById('londonTime').textContent = formatTime(londonTime);
      const londonStatus = calculateLondonStatus(londonTime);
      document.getElementById('londonStatus').textContent = londonStatus.timeRemaining || `${londonStatus.hours}h`;
      document.getElementById('londonStatus').className = `status-value ${londonStatus.type}`;
      document.getElementById('londonStatusLabel').textContent = londonStatus.label;

      // Update New York
      document.getElementById('newyorkTime').textContent = formatTime(newyorkTime);
      const newyorkStatus = calculateNewYorkStatus(newyorkTime);
      document.getElementById('newyorkStatus').textContent = newyorkStatus.timeRemaining || `${newyorkStatus.hours}h`;
      document.getElementById('newyorkStatus').className = `status-value ${newyorkStatus.type}`;
      document.getElementById('newyorkStatusLabel').textContent = newyorkStatus.label;

    } catch (error) {
      console.error('Error updating market times real-time:', error);
    }
  }

  // --- Event handlers ---
  function handleThemeToggle() {
    const newTheme = state.theme === 'dark' ? 'light' : 'dark';
    setTheme(newTheme);
  }

  function handleLanguageChange(e) {
    state.lang = e.target.value;
    localStorage.setItem(LKEY, state.lang);
    translatePage();
  }

  // --- Initialization ---
  function init() {
    // Set up event listeners
    document.getElementById('themeToggle').addEventListener('click', handleThemeToggle);
    document.getElementById('langSelect').addEventListener('change', handleLanguageChange);
    
    // Set initial language
    document.getElementById('langSelect').value = state.lang;
    
    // Translate page
    translatePage();
    
    // Initial update
    updateLocalTime();
    updateForexServers();
    
    // Test API connectivity first
    testAPIConnectivity().then(() => {
      updateMarketTimes();
      // Set up intervals
      setInterval(updateLocalTime, 1000);
      setInterval(updateForexServers, 1000);
      setInterval(updateMarketTimes, 30000); // Update market times every 30 seconds
    });
  }

  async function testAPIConnectivity() {
    console.log('Testing API connectivity...');
    try {
      const testResponse = await fetch('https://worldtimeapi.org/api/timezone/UTC');
      if (testResponse.ok) {
        console.log('Direct API access working');
        return true;
      }
    } catch (e) {
      console.log('Direct API access failed, will use fallback');
    }
    
    // If direct access fails, we'll use fallback times
    console.log('Using fallback time calculations');
    return false;
  }

  // Start the app
  init();
  
  // Debug: Test status calculations manually
  setTimeout(() => {
    console.log('=== DEBUG: Testing status calculations ===');
    const testTime = new Date();
    console.log('Current time:', testTime);
    
    // Test fallback times
    console.log('=== Testing Fallback Times ===');
    const tokyoFallback = getFallbackTime('Asia/Tokyo');
    const londonFallback = getFallbackTime('Europe/London');
    const newyorkFallback = getFallbackTime('America/New_York');
    
    console.log('Tokyo fallback:', formatTime(tokyoFallback));
    console.log('London fallback:', formatTime(londonFallback));
    console.log('New York fallback:', formatTime(newyorkFallback));
    
    // Test status calculations
    console.log('=== Testing Status Calculations ===');
    const tokyoTest = calculateTokyoStatus(tokyoFallback);
    const londonTest = calculateLondonStatus(londonFallback);
    const newyorkTest = calculateNewYorkStatus(newyorkFallback);
    
    console.log('Tokyo test status:', tokyoTest);
    console.log('London test status:', londonTest);
    console.log('New York test status:', newyorkTest);
    
    console.log('=== END DEBUG ===');
  }, 2000);
})();
</script>
</body>
</html>
