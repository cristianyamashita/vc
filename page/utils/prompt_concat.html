<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">Prompt Concat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/fontawesome/css/all.min.css" />
    <style>
      :root {
        --bg-color: #1a1a1a;
        --text-color: #f0f0f0;
        --card-bg-color: #2a2a2a;
        --border-color: #444;
        --accent-color: #0d6efd;
      }

      html[data-theme='light'] {
        --bg-color: #f8f9fa;
        --text-color: #212529;
        --card-bg-color: #fff;
        --border-color: #dee2e6;
        --accent-color: #0d6efd;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
      }

      .container-fluid {
        padding-top: 20px;
        padding-bottom: 20px;
        flex: 1;
      }

      .card {
        background-color: var(--card-bg-color);
        border-color: var(--border-color);
      }

      .card-header {
        border-bottom-color: var(--border-color);
      }

      .navbar-brand,
      .form-label {
        color: var(--text-color);
      }

      .form-control {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .form-control:focus,
      .form-select:focus {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }

      .form-select {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .help-text {
        color: #aaa;
        font-size: 0.9rem;
      }

      textarea.form-control {
        resize: vertical;
      }

      .mono {
        font-family: 'Courier New', Courier, monospace;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg" style="background-color: var(--card-bg-color); border-bottom: 1px solid var(--border-color)">
      <div class="container-fluid">
        <a class="navbar-brand" href="#" data-i18n="title">Prompt Concat</a>
        <div class="d-flex ms-auto gap-2 align-items-center">
          <select id="lang-switcher" class="form-select form-select-sm" style="width: auto;">
            <option value="en">English</option>
            <option value="pt">Português</option>
            <option value="ja">日本語</option>
          </select>
          <select id="storage-select" class="form-select form-select-sm" style="background-color: var(--card-bg-color); color: var(--text-color); border-color: var(--border-color); min-width: 150px;">
          </select>
          <button id="copy-result-btn" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="copyResultBtn" title="Copy result">
            <i class="fas fa-copy"></i>
          </button>
          <button id="history-btn" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="historyBtn" title="History">
            <i class="fas fa-history"></i>
          </button>
          <button id="clear-btn" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="clearBtn" title="Clear">
            <i class="fas fa-eraser"></i>
          </button>
          <button id="theme-switcher" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="themeBtn" title="Toggle theme">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11">
          <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h4 class="mb-0" data-i18n="title">Prompt Concat</h4>
              <div class="help-text" id="storage-scope"></div>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="input-template" class="form-label" data-i18n="inputLabel">Input</label>
                <textarea id="input-template" class="form-control mono" rows="4" data-i18n-placeholder="inputPlaceholder" placeholder="The {V1} is {V2} and has size {V3}, color {V4}, this is my {V1}"></textarea>
                <div class="help-text mt-1" data-i18n="placeholderHelp">Use placeholders: {V1}, {V2}, {V3}, {V4}, {V5}</div>
              </div>

              <div class="row g-3 row-cols-1 row-cols-md-2 row-cols-lg-5">
                <div class="col">
                  <label for="v1" class="form-label">V1</label>
                  <textarea id="v1" class="form-control mono" rows="5" data-i18n-placeholder="v1Placeholder" placeholder="car&#10;bicycle&#10;boat"></textarea>
                  <div class="btn-group mt-1 w-100" role="group">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-shuffle="v1" data-i18n-title="shuffleBtn" title="Shuffle lines">
                      <i class="fas fa-random"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-sort-asc="v1" data-i18n-title="sortAscBtn" title="Sort A-Z">
                      <i class="fas fa-sort-alpha-down"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-sort-desc="v1" data-i18n-title="sortDescBtn" title="Sort Z-A">
                      <i class="fas fa-sort-alpha-down-alt"></i>
                    </button>
                  </div>
                </div>
                <div class="col">
                  <label for="v2" class="form-label">V2</label>
                  <textarea id="v2" class="form-control mono" rows="5" data-i18n-placeholder="v2Placeholder" placeholder="modern&#10;old&#10;vintage"></textarea>
                  <div class="btn-group mt-1 w-100" role="group">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-shuffle="v2" data-i18n-title="shuffleBtn" title="Shuffle lines">
                      <i class="fas fa-random"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-sort-asc="v2" data-i18n-title="sortAscBtn" title="Sort A-Z">
                      <i class="fas fa-sort-alpha-down"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-sort-desc="v2" data-i18n-title="sortDescBtn" title="Sort Z-A">
                      <i class="fas fa-sort-alpha-down-alt"></i>
                    </button>
                  </div>
                </div>
                <div class="col">
                  <label for="v3" class="form-label">V3</label>
                  <textarea id="v3" class="form-control mono" rows="5" data-i18n-placeholder="v3Placeholder" placeholder="large&#10;small"></textarea>
                  <div class="btn-group mt-1 w-100" role="group">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-shuffle="v3" data-i18n-title="shuffleBtn" title="Shuffle lines">
                      <i class="fas fa-random"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-sort-asc="v3" data-i18n-title="sortAscBtn" title="Sort A-Z">
                      <i class="fas fa-sort-alpha-down"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-sort-desc="v3" data-i18n-title="sortDescBtn" title="Sort Z-A">
                      <i class="fas fa-sort-alpha-down-alt"></i>
                    </button>
                  </div>
                </div>
                <div class="col">
                  <label for="v4" class="form-label">V4</label>
                  <textarea id="v4" class="form-control mono" rows="5" data-i18n-placeholder="v4Placeholder" placeholder="yellow&#10;red"></textarea>
                  <div class="btn-group mt-1 w-100" role="group">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-shuffle="v4" data-i18n-title="shuffleBtn" title="Shuffle lines">
                      <i class="fas fa-random"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-sort-asc="v4" data-i18n-title="sortAscBtn" title="Sort A-Z">
                      <i class="fas fa-sort-alpha-down"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-sort-desc="v4" data-i18n-title="sortDescBtn" title="Sort Z-A">
                      <i class="fas fa-sort-alpha-down-alt"></i>
                    </button>
                  </div>
                </div>
                <div class="col">
                  <label for="v5" class="form-label">V5</label>
                  <textarea id="v5" class="form-control mono" rows="5" placeholder=""></textarea>
                  <div class="btn-group mt-1 w-100" role="group">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-shuffle="v5" data-i18n-title="shuffleBtn" title="Shuffle lines">
                      <i class="fas fa-random"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-sort-asc="v5" data-i18n-title="sortAscBtn" title="Sort A-Z">
                      <i class="fas fa-sort-alpha-down"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-sort-desc="v5" data-i18n-title="sortDescBtn" title="Sort Z-A">
                      <i class="fas fa-sort-alpha-down-alt"></i>
                    </button>
                  </div>
                </div>
              </div>

              <hr class="my-4" />

              <div class="mb-2 d-flex align-items-center justify-content-between gap-2">
                <label for="result" class="form-label mb-0" data-i18n="resultLabel">Result</label>
                <div class="help-text">
                  <span id="result-count">0</span> <span data-i18n="linesText">lines</span>
                </div>
              </div>
              <textarea id="result" class="form-control mono" rows="10" readonly></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="history-modal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--card-bg-color); color: var(--text-color); border-color: var(--border-color);">
          <div class="modal-header" style="border-bottom-color: var(--border-color);">
            <h5 class="modal-title" data-i18n="historyTitle">History</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="history-list"></div>
            <div id="history-empty" class="text-muted text-center py-3" data-i18n="historyEmpty">No history entries</div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const i18n = {
        en: {
          title: "Prompt Concat",
          inputLabel: "Input",
          inputPlaceholder: "The {V1} is {V2} and has size {V3}, color {V4}, this is my {V1}",
          placeholderHelp: "Use placeholders: {V1}, {V2}, {V3}, {V4}, {V5}",
          v1Placeholder: "car\nbicycle\nboat",
          v2Placeholder: "modern\nold\nvintage",
          v3Placeholder: "large\nsmall",
          v4Placeholder: "yellow\nred",
          shuffleBtn: "Shuffle",
          sortAscBtn: "Sort A-Z",
          sortDescBtn: "Sort Z-A",
          resultLabel: "Result",
          linesText: "lines",
          copyResultBtn: "Copy result",
          clearBtn: "Clear",
          themeBtn: "Toggle theme",
          storageText: "storage",
          historyBtn: "Manage",
          historyTitle: "Manage Storages",
          historyEmpty: "No entries to manage",
          loadBtn: "Load",
          renameBtn: "Rename",
          deleteBtn: "Delete",
          renamePrompt: "Enter new name:",
          deleteConfirm: "Delete this history entry?"
        },
        pt: {
          title: "Prompt Concat",
          inputLabel: "Entrada",
          inputPlaceholder: "O {V1} é {V2} e tem o tamanho {V3}, da cor {V4}, esse é o meu {V1}",
          placeholderHelp: "Use placeholders: {V1}, {V2}, {V3}, {V4}, {V5}",
          v1Placeholder: "carro\nbicicleta\nbarco",
          v2Placeholder: "moderno\nvelho\nvintage",
          v3Placeholder: "grande\npequeno",
          v4Placeholder: "amarelo\nvermelho",
          shuffleBtn: "Embaralhar",
          sortAscBtn: "Ordenar A-Z",
          sortDescBtn: "Ordenar Z-A",
          resultLabel: "Resultado",
          linesText: "linhas",
          copyResultBtn: "Copiar resultado",
          clearBtn: "Limpar",
          themeBtn: "Alternar tema",
          storageText: "armazenamento",
          historyBtn: "Gerenciar",
          historyTitle: "Gerenciar Storages",
          historyEmpty: "Nenhuma entrada para gerenciar",
          loadBtn: "Carregar",
          renameBtn: "Renomear",
          deleteBtn: "Excluir",
          renamePrompt: "Digite o novo nome:",
          deleteConfirm: "Excluir este histórico?"
        },
        ja: {
          title: "プロンプト連結",
          inputLabel: "入力",
          inputPlaceholder: "{V1}は{V2}で、サイズは{V3}、色は{V4}です。これが私の{V1}です",
          placeholderHelp: "プレースホルダーを使用: {V1}, {V2}, {V3}, {V4}, {V5}",
          v1Placeholder: "車\n自転車\nボート",
          v2Placeholder: "モダン\n古い\nヴィンテージ",
          v3Placeholder: "大きい\n小さい",
          v4Placeholder: "黄色\n赤",
          shuffleBtn: "シャッフル",
          sortAscBtn: "昇順ソート",
          sortDescBtn: "降順ソート",
          resultLabel: "結果",
          linesText: "行",
          copyResultBtn: "結果をコピー",
          clearBtn: "クリア",
          themeBtn: "テーマを切り替え",
          storageText: "ストレージ",
          historyBtn: "管理",
          historyTitle: "ストレージ管理",
          historyEmpty: "管理する項目がありません",
          loadBtn: "読み込む",
          renameBtn: "名前変更",
          deleteBtn: "削除",
          renamePrompt: "新しい名前を入力:",
          deleteConfirm: "この履歴を削除しますか？"
        }
      };

      document.addEventListener('DOMContentLoaded', () => {
        // Elements
        const langSwitcher = document.getElementById('lang-switcher');
        const themeSwitcher = document.getElementById('theme-switcher');
        const clearBtn = document.getElementById('clear-btn');
        const copyResultBtn = document.getElementById('copy-result-btn');
        const storageScopeEl = document.getElementById('storage-scope');
        const storageSelectEl = document.getElementById('storage-select');

        const inputTemplateEl = document.getElementById('input-template');
        const vEls = [document.getElementById('v1'), document.getElementById('v2'), document.getElementById('v3'), document.getElementById('v4'), document.getElementById('v5')];
        const resultEl = document.getElementById('result');
        const resultCountEl = document.getElementById('result-count');

        const historyBtn = document.getElementById('history-btn');
        const historyListEl = document.getElementById('history-list');
        const historyEmptyEl = document.getElementById('history-empty');
        const historyModal = new bootstrap.Modal(document.getElementById('history-modal'));

        // Language
        let currentLanguage = localStorage.getItem('app_lang') || 'en';
        const applyI18n = () => {
          const lang = i18n[currentLanguage] || i18n.en;
          document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (lang[key]) {
              el.innerText = lang[key];
            }
          });
          document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (lang[key]) {
              el.placeholder = lang[key];
            }
          });
          document.querySelectorAll('[data-i18n-title]').forEach(el => {
            const key = el.getAttribute('data-i18n-title');
            if (lang[key]) {
              el.title = lang[key];
            }
          });
          document.title = lang.title;
        };

        // Theme
        let currentTheme = localStorage.getItem('app_theme') || 'dark';
        const applyTheme = (theme) => {
          document.documentElement.setAttribute('data-theme', theme);
          const icon = themeSwitcher.querySelector('i');
          icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
          localStorage.setItem('app_theme', theme);
        };

        // History helpers
        const formatTimestamp = () => {
          const now = new Date();
          const pad = (n) => String(n).padStart(2, '0');
          const date = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}`;
          const time = `${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
          return `${date}_${time}`;
        };

        const parseHistoryDate = (prefix) => {
          // prefix format: history_YYYYMMDD_HHMMSS
          const match = prefix.match(/^history_(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})$/);
          if (!match) return null;
          return new Date(match[1], parseInt(match[2]) - 1, match[3], match[4], match[5], match[6]);
        };

        const formatHistoryDateForDisplay = (prefix) => {
          const date = parseHistoryDate(prefix);
          if (!date) return prefix;
          const pad = (n) => String(n).padStart(2, '0');
          return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
        };

        const isHistoryPrefix = (prefix) => /^history_\d{8}_\d{6}$/.test(prefix);

        // Storage (hash prefix)
        const getPrefix = () => {
          const h = String(location.hash || '').replace(/^#/, '').trim();
          return h ? h : 'default';
        };
        const keyFor = (field) => `prompt_concat:${getPrefix()}:${field}`;
        const updateStorageScopeText = () => {
          const prefix = getPrefix();
          const lang = i18n[currentLanguage] || i18n.en;
          storageScopeEl.textContent = `${lang.storageText}: ${prefix}`;
          document.title = `${lang.title} - ${prefix}`;
        };

        // List all existing storages
        const getAllStorages = () => {
          const storages = new Set(['default']);
          try {
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('prompt_concat:')) {
                const parts = key.split(':');
                if (parts.length >= 2) {
                  storages.add(parts[1]);
                }
              }
            }
          } catch {
            // ignore
          }
          return Array.from(storages).sort();
        };

        // Update storage select dropdown
        const updateStorageSelect = () => {
          const storages = getAllStorages();
          const currentPrefix = getPrefix();
          storageSelectEl.innerHTML = '';

          // Separate normal storages from history
          const normalStorages = storages.filter(s => !isHistoryPrefix(s));
          const historyStorages = storages.filter(s => isHistoryPrefix(s)).sort().reverse(); // newest first

          // Add normal storages
          normalStorages.forEach((storage) => {
            const option = document.createElement('option');
            option.value = storage;
            option.textContent = storage;
            if (storage === currentPrefix) {
              option.selected = true;
            }
            storageSelectEl.appendChild(option);
          });

          // Add history storages in optgroup
          if (historyStorages.length > 0) {
            const lang = i18n[currentLanguage] || i18n.en;
            const optgroup = document.createElement('optgroup');
            optgroup.label = lang.historyTitle || 'History';
            historyStorages.forEach((storage) => {
              const option = document.createElement('option');
              option.value = storage;
              option.textContent = formatHistoryDateForDisplay(storage);
              if (storage === currentPrefix) {
                option.selected = true;
              }
              optgroup.appendChild(option);
            });
            storageSelectEl.appendChild(optgroup);
          }
        };

        const readField = (field, fallback = '') => {
          try {
            const v = localStorage.getItem(keyFor(field));
            return v == null ? fallback : v;
          } catch {
            return fallback;
          }
        };
        const writeField = (field, value) => {
          try {
            localStorage.setItem(keyFor(field), String(value));
          } catch {
            // ignore
          }
        };

        const writeFieldToPrefix = (prefix, field, value) => {
          try {
            localStorage.setItem(`prompt_concat:${prefix}:${field}`, String(value));
          } catch {
            // ignore
          }
        };

        const saveHistory = () => {
          const historyPrefix = `history_${formatTimestamp()}`;
          writeFieldToPrefix(historyPrefix, 'input', inputTemplateEl.value);
          vEls.forEach((el, idx) => writeFieldToPrefix(historyPrefix, `v${idx + 1}`, el.value));
          cleanOldHistory();
          updateStorageSelect();
        };

        const cleanOldHistory = () => {
          const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
          const keysToRemove = [];
          const prefixesToRemove = new Set();

          try {
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('prompt_concat:history_')) {
                const parts = key.split(':');
                if (parts.length >= 2) {
                  const prefix = parts[1]; // history_YYYYMMDD_HHMMSS
                  const date = parseHistoryDate(prefix);
                  if (date && date < threeDaysAgo) {
                    prefixesToRemove.add(prefix);
                  }
                }
              }
            }

            // Collect all keys for old prefixes
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key) {
                for (const prefix of prefixesToRemove) {
                  if (key.startsWith(`prompt_concat:${prefix}:`)) {
                    keysToRemove.push(key);
                  }
                }
              }
            }

            keysToRemove.forEach(key => localStorage.removeItem(key));
          } catch {
            // ignore
          }
        };

        const getAllEditablePrefixes = () => {
          const prefixes = new Set();
          try {
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('prompt_concat:')) {
                const parts = key.split(':');
                if (parts.length >= 2 && parts[1] !== 'default') {
                  prefixes.add(parts[1]);
                }
              }
            }
          } catch {
            // ignore
          }
          // Sort: history entries first (newest first), then other names alphabetically
          const arr = Array.from(prefixes);
          const historyPrefixes = arr.filter(p => isHistoryPrefix(p)).sort().reverse();
          const otherPrefixes = arr.filter(p => !isHistoryPrefix(p)).sort();
          return [...historyPrefixes, ...otherPrefixes];
        };

        const deleteHistoryPrefix = (prefix) => {
          const keysToRemove = [];
          try {
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith(`prompt_concat:${prefix}:`)) {
                keysToRemove.push(key);
              }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
          } catch {
            // ignore
          }
        };

        const renameHistoryPrefix = (oldPrefix, newPrefix) => {
          const fields = ['input', 'v1', 'v2', 'v3', 'v4', 'v5'];
          try {
            // Copy data to new prefix
            fields.forEach(field => {
              const oldKey = `prompt_concat:${oldPrefix}:${field}`;
              const newKey = `prompt_concat:${newPrefix}:${field}`;
              const value = localStorage.getItem(oldKey);
              if (value !== null) {
                localStorage.setItem(newKey, value);
              }
            });
            // Delete old prefix
            deleteHistoryPrefix(oldPrefix);
          } catch {
            // ignore
          }
        };

        const renderHistoryModal = () => {
          const prefixes = getAllEditablePrefixes();
          const lang = i18n[currentLanguage] || i18n.en;
          historyListEl.innerHTML = '';

          if (prefixes.length === 0) {
            historyEmptyEl.style.display = 'block';
            return;
          }
          historyEmptyEl.style.display = 'none';

          prefixes.forEach(prefix => {
            const item = document.createElement('div');
            item.className = 'd-flex align-items-center justify-content-between p-2 mb-2 rounded';
            item.style.cssText = 'background-color: var(--bg-color); border: 1px solid var(--border-color);';
            
            const label = document.createElement('span');
            // Show formatted date for history entries, plain name for others
            label.textContent = isHistoryPrefix(prefix) ? formatHistoryDateForDisplay(prefix) : prefix;
            label.style.flex = '1';
            label.style.cursor = 'pointer';
            label.title = lang.loadBtn || 'Load';
            label.addEventListener('click', () => {
              location.hash = prefix;
              historyModal.hide();
            });

            const btnGroup = document.createElement('div');
            btnGroup.className = 'd-flex gap-1';

            const loadBtn = document.createElement('button');
            loadBtn.className = 'btn btn-sm btn-outline-primary';
            loadBtn.innerHTML = '<i class="fas fa-folder-open"></i>';
            loadBtn.title = lang.loadBtn || 'Load';
            loadBtn.addEventListener('click', () => {
              location.hash = prefix;
              historyModal.hide();
            });

            const renameBtn = document.createElement('button');
            renameBtn.className = 'btn btn-sm btn-outline-warning';
            renameBtn.innerHTML = '<i class="fas fa-edit"></i>';
            renameBtn.title = lang.renameBtn || 'Rename';
            renameBtn.addEventListener('click', () => {
              const defaultName = isHistoryPrefix(prefix) ? prefix.replace('history_', '') : prefix;
              const newName = prompt(lang.renamePrompt || 'Enter new name:', defaultName);
              if (newName && newName.trim()) {
                const sanitized = newName.trim().replace(/[^a-zA-Z0-9_-]/g, '_');
                if (sanitized && sanitized !== prefix && sanitized !== 'default') {
                  renameHistoryPrefix(prefix, sanitized);
                  updateStorageSelect();
                  renderHistoryModal();
                }
              }
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-sm btn-outline-danger';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.title = lang.deleteBtn || 'Delete';
            deleteBtn.addEventListener('click', () => {
              if (confirm(lang.deleteConfirm || 'Delete this entry?')) {
                deleteHistoryPrefix(prefix);
                updateStorageSelect();
                renderHistoryModal();
              }
            });

            btnGroup.appendChild(loadBtn);
            btnGroup.appendChild(renameBtn);
            btnGroup.appendChild(deleteBtn);

            item.appendChild(label);
            item.appendChild(btnGroup);
            historyListEl.appendChild(item);
          });
        };

        // Logic
        const parseLines = (text) => {
          const raw = String(text || '').split(/\r?\n/).map((s) => s.trim()).filter((s) => s !== '');
          return raw.length ? raw : [''];
        };

        // Shuffle lines in a textarea
        const shuffleLines = (textareaEl) => {
          const lines = String(textareaEl.value || '').split(/\r?\n/);
          // Fisher-Yates shuffle algorithm
          for (let i = lines.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [lines[i], lines[j]] = [lines[j], lines[i]];
          }
          textareaEl.value = lines.join('\n');
          schedule();
        };

        // Sort lines ascending (A-Z)
        const sortLinesAsc = (textareaEl) => {
          const lines = String(textareaEl.value || '').split(/\r?\n/);
          lines.sort((a, b) => a.localeCompare(b));
          textareaEl.value = lines.join('\n');
          schedule();
        };

        // Sort lines descending (Z-A)
        const sortLinesDesc = (textareaEl) => {
          const lines = String(textareaEl.value || '').split(/\r?\n/);
          lines.sort((a, b) => b.localeCompare(a));
          textareaEl.value = lines.join('\n');
          schedule();
        };

        const cartesianProduct = (arrays) => {
          let acc = [[]];
          for (const arr of arrays) {
            const next = [];
            for (const prev of acc) {
              for (const item of arr) next.push(prev.concat([item]));
            }
            acc = next;
          }
          return acc;
        };

        const render = () => {
          const template = String(inputTemplateEl.value || '');
          const lists = vEls.map((el) => parseLines(el.value));
          const combos = cartesianProduct(lists);

          const lines = combos.map((valuesRaw) => {
            // Resolve chained placeholders inside variable values:
            // - V2 may reference {V1}
            // - V3 may reference {V1} and {V2}
            // - ...
            const values = [];
            for (let i = 0; i < valuesRaw.length; i++) {
              let v = String(valuesRaw[i] ?? '');
              for (let j = 0; j < i; j++) {
                v = v.replaceAll(`{V${j + 1}}`, values[j]);
              }
              values.push(v);
            }

            let out = template;
            for (let i = 0; i < values.length; i++) {
              const placeholder = `{V${i + 1}}`;
              out = out.replaceAll(placeholder, values[i]);
            }
            return out;
          });

          resultEl.value = lines.join('\n');
          resultCountEl.textContent = String(lines.length);
        };

        const saveAll = () => {
          writeField('input', inputTemplateEl.value);
          vEls.forEach((el, idx) => writeField(`v${idx + 1}`, el.value));
        };

        const loadAll = () => {
          inputTemplateEl.value = readField('input', '');
          vEls.forEach((el, idx) => (el.value = readField(`v${idx + 1}`, '')));
        };

        // Debounce
        let t = null;
        const schedule = () => {
          if (t) clearTimeout(t);
          t = setTimeout(() => {
            saveAll();
            render();
          }, 120);
        };

        // Events
        langSwitcher.addEventListener('change', (e) => {
          currentLanguage = e.target.value;
          localStorage.setItem('app_lang', currentLanguage);
          applyI18n();
          updateStorageScopeText();
        });

        themeSwitcher.addEventListener('click', () => {
          currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
          applyTheme(currentTheme);
        });

        clearBtn.addEventListener('click', () => {
          inputTemplateEl.value = '';
          vEls.forEach((el) => (el.value = ''));
          saveAll();
          render();
        });

        historyBtn.addEventListener('click', () => {
          renderHistoryModal();
          historyModal.show();
        });

        copyResultBtn.addEventListener('click', async () => {
          const text = String(resultEl.value || '');
          try {
            await navigator.clipboard.writeText(text);
          } catch {
            // fallback
            resultEl.focus();
            resultEl.select();
            document.execCommand('copy');
            resultEl.setSelectionRange(0, 0);
          }
          // Save to history
          saveHistory();
        });

        inputTemplateEl.addEventListener('input', schedule);
        vEls.forEach((el) => el.addEventListener('input', schedule));

        // Shuffle buttons
        document.querySelectorAll('[data-shuffle]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-shuffle');
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
              shuffleLines(targetEl);
            }
          });
        });

        // Sort ascending buttons
        document.querySelectorAll('[data-sort-asc]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-sort-asc');
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
              sortLinesAsc(targetEl);
            }
          });
        });

        // Sort descending buttons
        document.querySelectorAll('[data-sort-desc]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-sort-desc');
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
              sortLinesDesc(targetEl);
            }
          });
        });

        storageSelectEl.addEventListener('change', () => {
          const selectedStorage = storageSelectEl.value;
          location.hash = selectedStorage === 'default' ? '' : selectedStorage;
        });

        window.addEventListener('hashchange', () => {
          updateStorageScopeText();
          updateStorageSelect();
          loadAll();
          render();
        });

        // Init
        cleanOldHistory(); // Clean old history entries on page load
        langSwitcher.value = currentLanguage;
        applyI18n();
        applyTheme(currentTheme);
        updateStorageScopeText();
        updateStorageSelect();
        loadAll();
        render();
      });
    </script>
  </body>
</html>

