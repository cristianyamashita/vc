<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">Prompt Concat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/fontawesome/css/all.min.css" />
    <style>
      :root {
        --bg-color: #1a1a1a;
        --text-color: #f0f0f0;
        --card-bg-color: #2a2a2a;
        --border-color: #444;
        --accent-color: #0d6efd;
      }

      html[data-theme='light'] {
        --bg-color: #f8f9fa;
        --text-color: #212529;
        --card-bg-color: #fff;
        --border-color: #dee2e6;
        --accent-color: #0d6efd;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
      }

      .container-fluid {
        padding-top: 20px;
        padding-bottom: 20px;
        flex: 1;
      }

      .card {
        background-color: var(--card-bg-color);
        border-color: var(--border-color);
      }

      .card-header {
        border-bottom-color: var(--border-color);
      }

      .navbar-brand,
      .form-label {
        color: var(--text-color);
      }

      .form-control {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .form-control:focus,
      .form-select:focus {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }

      .form-select {
        background-color: var(--card-bg-color);
        color: var(--text-color);
        border-color: var(--border-color);
      }

      .help-text {
        color: #aaa;
        font-size: 0.9rem;
      }

      textarea.form-control {
        resize: vertical;
      }

      .mono {
        font-family: 'Courier New', Courier, monospace;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg" style="background-color: var(--card-bg-color); border-bottom: 1px solid var(--border-color)">
      <div class="container-fluid">
        <a class="navbar-brand" href="#" data-i18n="title">Prompt Concat</a>
        <div class="d-flex ms-auto gap-2 align-items-center">
          <select id="lang-switcher" class="form-select form-select-sm" style="width: auto;">
            <option value="en">English</option>
            <option value="pt">Português</option>
            <option value="ja">日本語</option>
          </select>
          <select id="storage-select" class="form-select form-select-sm" style="background-color: var(--card-bg-color); color: var(--text-color); border-color: var(--border-color); min-width: 150px;">
          </select>
          <button id="copy-result-btn" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="copyResultBtn" title="Copy result">
            <i class="fas fa-copy"></i>
          </button>
          <button id="clear-btn" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="clearBtn" title="Clear">
            <i class="fas fa-eraser"></i>
          </button>
          <button id="theme-switcher" class="btn btn-sm btn-outline-secondary" type="button" data-i18n-title="themeBtn" title="Toggle theme">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11">
          <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h4 class="mb-0" data-i18n="title">Prompt Concat</h4>
              <div class="help-text" id="storage-scope"></div>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="input-template" class="form-label" data-i18n="inputLabel">Input</label>
                <textarea id="input-template" class="form-control mono" rows="4" placeholder="O {V1} eh {V2} e tem o tamanho {V3}, da cor {V4}, esse eh o meu {V1}"></textarea>
                <div class="help-text mt-1" data-i18n="placeholderHelp">Use placeholders: {V1}, {V2}, {V3}, {V4}, {V5}</div>
              </div>

              <div class="row g-3 row-cols-1 row-cols-md-2 row-cols-lg-5">
                <div class="col">
                  <label for="v1" class="form-label">V1</label>
                  <textarea id="v1" class="form-control mono" rows="5" placeholder="carro&#10;bicicleta&#10;barco"></textarea>
                  <button class="btn btn-sm btn-outline-secondary mt-1 w-100" type="button" data-shuffle="v1" data-i18n-title="shuffleBtn" title="Shuffle lines">
                    <i class="fas fa-random"></i> <span data-i18n="shuffleBtn">Shuffle</span>
                  </button>
                </div>
                <div class="col">
                  <label for="v2" class="form-label">V2</label>
                  <textarea id="v2" class="form-control mono" rows="5" placeholder="moderno&#10;velho&#10;vintage"></textarea>
                  <button class="btn btn-sm btn-outline-secondary mt-1 w-100" type="button" data-shuffle="v2" data-i18n-title="shuffleBtn" title="Shuffle lines">
                    <i class="fas fa-random"></i> <span data-i18n="shuffleBtn">Shuffle</span>
                  </button>
                </div>
                <div class="col">
                  <label for="v3" class="form-label">V3</label>
                  <textarea id="v3" class="form-control mono" rows="5" placeholder="grande&#10;pequeno"></textarea>
                  <button class="btn btn-sm btn-outline-secondary mt-1 w-100" type="button" data-shuffle="v3" data-i18n-title="shuffleBtn" title="Shuffle lines">
                    <i class="fas fa-random"></i> <span data-i18n="shuffleBtn">Shuffle</span>
                  </button>
                </div>
                <div class="col">
                  <label for="v4" class="form-label">V4</label>
                  <textarea id="v4" class="form-control mono" rows="5" placeholder="amarelo&#10;vermelho"></textarea>
                  <button class="btn btn-sm btn-outline-secondary mt-1 w-100" type="button" data-shuffle="v4" data-i18n-title="shuffleBtn" title="Shuffle lines">
                    <i class="fas fa-random"></i> <span data-i18n="shuffleBtn">Shuffle</span>
                  </button>
                </div>
                <div class="col">
                  <label for="v5" class="form-label">V5</label>
                  <textarea id="v5" class="form-control mono" rows="5" placeholder=""></textarea>
                  <button class="btn btn-sm btn-outline-secondary mt-1 w-100" type="button" data-shuffle="v5" data-i18n-title="shuffleBtn" title="Shuffle lines">
                    <i class="fas fa-random"></i> <span data-i18n="shuffleBtn">Shuffle</span>
                  </button>
                </div>
              </div>

              <hr class="my-4" />

              <div class="mb-2 d-flex align-items-center justify-content-between gap-2">
                <label for="result" class="form-label mb-0" data-i18n="resultLabel">Result</label>
                <div class="help-text">
                  <span id="result-count">0</span> <span data-i18n="linesText">lines</span>
                </div>
              </div>
              <textarea id="result" class="form-control mono" rows="10" readonly></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const i18n = {
        en: {
          title: "Prompt Concat",
          inputLabel: "Input",
          placeholderHelp: "Use placeholders: {V1}, {V2}, {V3}, {V4}, {V5}",
          shuffleBtn: "Shuffle",
          resultLabel: "Result",
          linesText: "lines",
          copyResultBtn: "Copy result",
          clearBtn: "Clear",
          themeBtn: "Toggle theme",
          storageText: "storage"
        },
        pt: {
          title: "Prompt Concat",
          inputLabel: "Entrada",
          placeholderHelp: "Use placeholders: {V1}, {V2}, {V3}, {V4}, {V5}",
          shuffleBtn: "Embaralhar",
          resultLabel: "Resultado",
          linesText: "linhas",
          copyResultBtn: "Copiar resultado",
          clearBtn: "Limpar",
          themeBtn: "Alternar tema",
          storageText: "armazenamento"
        },
        ja: {
          title: "プロンプト連結",
          inputLabel: "入力",
          placeholderHelp: "プレースホルダーを使用: {V1}, {V2}, {V3}, {V4}, {V5}",
          shuffleBtn: "シャッフル",
          resultLabel: "結果",
          linesText: "行",
          copyResultBtn: "結果をコピー",
          clearBtn: "クリア",
          themeBtn: "テーマを切り替え",
          storageText: "ストレージ"
        }
      };

      document.addEventListener('DOMContentLoaded', () => {
        // Elements
        const langSwitcher = document.getElementById('lang-switcher');
        const themeSwitcher = document.getElementById('theme-switcher');
        const clearBtn = document.getElementById('clear-btn');
        const copyResultBtn = document.getElementById('copy-result-btn');
        const storageScopeEl = document.getElementById('storage-scope');
        const storageSelectEl = document.getElementById('storage-select');

        const inputTemplateEl = document.getElementById('input-template');
        const vEls = [document.getElementById('v1'), document.getElementById('v2'), document.getElementById('v3'), document.getElementById('v4'), document.getElementById('v5')];
        const resultEl = document.getElementById('result');
        const resultCountEl = document.getElementById('result-count');

        // Language
        let currentLanguage = localStorage.getItem('app_lang') || 'en';
        const applyI18n = () => {
          const lang = i18n[currentLanguage] || i18n.en;
          document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (lang[key]) {
              el.innerText = lang[key];
            }
          });
          document.querySelectorAll('[data-i18n-title]').forEach(el => {
            const key = el.getAttribute('data-i18n-title');
            if (lang[key]) {
              el.title = lang[key];
            }
          });
          document.title = lang.title;
        };

        // Theme
        let currentTheme = localStorage.getItem('app_theme') || 'dark';
        const applyTheme = (theme) => {
          document.documentElement.setAttribute('data-theme', theme);
          const icon = themeSwitcher.querySelector('i');
          icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
          localStorage.setItem('app_theme', theme);
        };

        // Storage (hash prefix)
        const getPrefix = () => {
          const h = String(location.hash || '').replace(/^#/, '').trim();
          return h ? h : 'default';
        };
        const keyFor = (field) => `prompt_concat:${getPrefix()}:${field}`;
        const updateStorageScopeText = () => {
          const prefix = getPrefix();
          const lang = i18n[currentLanguage] || i18n.en;
          storageScopeEl.textContent = `${lang.storageText}: ${prefix}`;
          document.title = `${lang.title} - ${prefix}`;
        };

        // List all existing storages
        const getAllStorages = () => {
          const storages = new Set(['default']);
          try {
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('prompt_concat:')) {
                const parts = key.split(':');
                if (parts.length >= 2) {
                  storages.add(parts[1]);
                }
              }
            }
          } catch {
            // ignore
          }
          return Array.from(storages).sort();
        };

        // Update storage select dropdown
        const updateStorageSelect = () => {
          const storages = getAllStorages();
          const currentPrefix = getPrefix();
          storageSelectEl.innerHTML = '';
          storages.forEach((storage) => {
            const option = document.createElement('option');
            option.value = storage;
            option.textContent = storage;
            if (storage === currentPrefix) {
              option.selected = true;
            }
            storageSelectEl.appendChild(option);
          });
        };

        const readField = (field, fallback = '') => {
          try {
            const v = localStorage.getItem(keyFor(field));
            return v == null ? fallback : v;
          } catch {
            return fallback;
          }
        };
        const writeField = (field, value) => {
          try {
            localStorage.setItem(keyFor(field), String(value));
          } catch {
            // ignore
          }
        };

        // Logic
        const parseLines = (text) => {
          const raw = String(text || '').split(/\r?\n/).map((s) => s.trim()).filter((s) => s !== '');
          return raw.length ? raw : [''];
        };

        // Shuffle lines in a textarea
        const shuffleLines = (textareaEl) => {
          const lines = String(textareaEl.value || '').split(/\r?\n/);
          // Fisher-Yates shuffle algorithm
          for (let i = lines.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [lines[i], lines[j]] = [lines[j], lines[i]];
          }
          textareaEl.value = lines.join('\n');
          schedule();
        };

        const cartesianProduct = (arrays) => {
          let acc = [[]];
          for (const arr of arrays) {
            const next = [];
            for (const prev of acc) {
              for (const item of arr) next.push(prev.concat([item]));
            }
            acc = next;
          }
          return acc;
        };

        const render = () => {
          const template = String(inputTemplateEl.value || '');
          const lists = vEls.map((el) => parseLines(el.value));
          const combos = cartesianProduct(lists);

          const lines = combos.map((valuesRaw) => {
            // Resolve chained placeholders inside variable values:
            // - V2 may reference {V1}
            // - V3 may reference {V1} and {V2}
            // - ...
            const values = [];
            for (let i = 0; i < valuesRaw.length; i++) {
              let v = String(valuesRaw[i] ?? '');
              for (let j = 0; j < i; j++) {
                v = v.replaceAll(`{V${j + 1}}`, values[j]);
              }
              values.push(v);
            }

            let out = template;
            for (let i = 0; i < values.length; i++) {
              const placeholder = `{V${i + 1}}`;
              out = out.replaceAll(placeholder, values[i]);
            }
            return out;
          });

          resultEl.value = lines.join('\n');
          resultCountEl.textContent = String(lines.length);
        };

        const saveAll = () => {
          writeField('input', inputTemplateEl.value);
          vEls.forEach((el, idx) => writeField(`v${idx + 1}`, el.value));
        };

        const loadAll = () => {
          inputTemplateEl.value = readField('input', '');
          vEls.forEach((el, idx) => (el.value = readField(`v${idx + 1}`, '')));
        };

        // Debounce
        let t = null;
        const schedule = () => {
          if (t) clearTimeout(t);
          t = setTimeout(() => {
            saveAll();
            render();
          }, 120);
        };

        // Events
        langSwitcher.addEventListener('change', (e) => {
          currentLanguage = e.target.value;
          localStorage.setItem('app_lang', currentLanguage);
          applyI18n();
          updateStorageScopeText();
        });

        themeSwitcher.addEventListener('click', () => {
          currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
          applyTheme(currentTheme);
        });

        clearBtn.addEventListener('click', () => {
          inputTemplateEl.value = '';
          vEls.forEach((el) => (el.value = ''));
          saveAll();
          render();
        });

        copyResultBtn.addEventListener('click', async () => {
          const text = String(resultEl.value || '');
          try {
            await navigator.clipboard.writeText(text);
          } catch {
            // fallback
            resultEl.focus();
            resultEl.select();
            document.execCommand('copy');
            resultEl.setSelectionRange(0, 0);
          }
        });

        inputTemplateEl.addEventListener('input', schedule);
        vEls.forEach((el) => el.addEventListener('input', schedule));

        // Shuffle buttons
        document.querySelectorAll('[data-shuffle]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-shuffle');
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
              shuffleLines(targetEl);
            }
          });
        });

        storageSelectEl.addEventListener('change', () => {
          const selectedStorage = storageSelectEl.value;
          location.hash = selectedStorage === 'default' ? '' : selectedStorage;
        });

        window.addEventListener('hashchange', () => {
          updateStorageScopeText();
          updateStorageSelect();
          loadAll();
          render();
        });

        // Init
        langSwitcher.value = currentLanguage;
        applyI18n();
        applyTheme(currentTheme);
        updateStorageScopeText();
        updateStorageSelect();
        loadAll();
        render();
      });
    </script>
  </body>
</html>

