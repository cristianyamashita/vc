<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/fontawesome/css/all.min.css" />
    <style>
      :root {
        --bg-color: #1a1a1a;
        --text-color: #f0f0f0;
        --card-bg-color: #2a2a2a;
        --border-color: #444;
        --accent-color: #0d6efd;
        --hover-color: #3a3a3a;
        --selected-color: #0d6efd33;
      }

      html[data-theme='light'] {
        --bg-color: #f8f9fa;
        --text-color: #212529;
        --card-bg-color: #fff;
        --border-color: #dee2e6;
        --accent-color: #0d6efd;
        --hover-color: #e9ecef;
        --selected-color: #0d6efd22;
      }

      * { box-sizing: border-box; }

      html, body { height: 100%; margin: 0; }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      }

      .navbar {
        background-color: var(--card-bg-color);
        border-bottom: 1px solid var(--border-color);
        padding: 0.5rem 1rem;
      }

      .navbar-brand { color: var(--text-color); font-weight: 600; }

      .main-container {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .nav-column {
        display: flex;
        flex-direction: column;
        min-width: 180px;
        max-width: 250px;
        width: 200px;
        background-color: var(--card-bg-color);
        border-right: 1px solid var(--border-color);
        transition: width 0.3s ease, min-width 0.3s ease;
        overflow: hidden;
      }

      .nav-column.collapsed { min-width: 42px; width: 42px; }

      .nav-column.collapsed .column-content,
      .nav-column.collapsed .column-title-text,
      .nav-column.collapsed .add-btn-text { display: none; }

      .nav-column.collapsed .column-header { justify-content: center; padding: 0.5rem; }

      .nav-column.collapsed .collapse-btn { transform: rotate(180deg); }

      .column-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bg-color);
        min-height: 42px;
      }

      .column-title { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; font-size: 0.9rem; }

      .collapse-btn {
        background: none; border: none; color: var(--text-color);
        cursor: pointer; padding: 0.25rem; opacity: 0.7; transition: opacity 0.2s, transform 0.3s;
      }

      .collapse-btn:hover { opacity: 1; }

      .column-content { flex: 1; overflow-y: auto; padding: 0.5rem; }

      .item-list { list-style: none; padding: 0; margin: 0; }

      .item-list li {
        display: flex; align-items: center;
        padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; margin-bottom: 2px;
        transition: background-color 0.15s;
      }

      .item-list li:hover { background-color: var(--hover-color); }

      .item-list li.selected { background-color: var(--selected-color); border: 1px solid var(--accent-color); }

      .item-list li .item-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

      .item-list li .item-actions { display: none; gap: 0.25rem; }

      .item-list li:hover .item-actions { display: flex; }

      .item-actions button {
        background: none; border: none; color: var(--text-color);
        cursor: pointer; padding: 0.15rem 0.3rem; opacity: 0.6; font-size: 0.75rem;
      }

      .item-actions button:hover { opacity: 1; }

      .add-item-btn {
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        width: 100%; padding: 0.5rem; margin-top: 0.5rem;
        background-color: transparent; border: 1px dashed var(--border-color);
        border-radius: 6px; color: var(--text-color); cursor: pointer;
        opacity: 0.7; transition: opacity 0.2s, border-color 0.2s;
      }

      .add-item-btn:hover { opacity: 1; border-color: var(--accent-color); }

      .content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

      .content-header {
        display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;
        padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color);
        background-color: var(--card-bg-color); min-height: 50px;
      }

      .content-path { font-size: 0.85rem; color: var(--text-color); opacity: 0.7; }

      .content-path span { opacity: 0.5; }

      .continue-checkbox { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }

      .continue-checkbox input { cursor: pointer; }

      .content-body { flex: 1; display: flex; flex-direction: column; padding: 1rem; overflow: hidden; }

      .drop-zone {
        border: 2px dashed var(--border-color);
        border-radius: 8px; padding: 1.5rem; text-align: center;
        color: var(--text-color); opacity: 0.7; margin-bottom: 1rem;
        transition: border-color 0.2s, opacity 0.2s;
      }

      .drop-zone.drag-over { border-color: var(--accent-color); opacity: 1; }

      .drop-zone.disabled { pointer-events: none; opacity: 0.4; }

      .tracks-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }

      .track-item {
        display: flex; flex-direction: column; align-items: stretch;
        padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 2px;
        border: 1px solid transparent; transition: background-color 0.15s;
      }

      .track-item:hover { background-color: var(--hover-color); }

      .track-item.playing { background-color: var(--selected-color); border-color: var(--accent-color); }

      .track-row {
        display: flex; align-items: center; gap: 0.5rem;
      }

      .track-item .track-play { flex-shrink: 0; background: none; border: none; color: var(--text-color); cursor: pointer; padding: 0.25rem; }

      .track-item .track-name-input {
        flex: 1; min-width: 0; background: var(--card-bg-color); color: var(--text-color);
        border: 1px solid transparent; border-radius: 4px; padding: 0.25rem 0.5rem;
        font-size: 0.95rem;
      }

      .track-item .track-name-input:focus {
        outline: none; border-color: var(--accent-color);
      }

      .track-item .track-desc-btn, .track-item .track-delete {
        flex-shrink: 0; background: none; border: none; color: var(--text-color);
        cursor: pointer; padding: 0.25rem; opacity: 0.7;
      }

      .track-item .track-desc-btn:hover, .track-item .track-delete:hover { opacity: 1; }

      .track-desc-panel {
        padding: 0.75rem; margin-top: 0.25rem; margin-bottom: 0.5rem;
        background: var(--card-bg-color); border: 1px solid var(--border-color);
        border-radius: 6px;
      }

      .track-desc-panel textarea {
        width: 100%; min-height: 80px; background: var(--bg-color); color: var(--text-color);
        border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;
        font-size: 0.9rem; resize: vertical;
      }

      .track-desc-panel textarea:focus {
        outline: none; border-color: var(--accent-color);
      }

      .no-selection {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 100%; color: var(--text-color); opacity: 0.5; text-align: center;
      }

      .no-selection i { font-size: 3rem; margin-bottom: 1rem; }

      /* Player bar */
      .player-bar {
        display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
        padding: 0.75rem 1rem; background-color: var(--card-bg-color);
        border-top: 1px solid var(--border-color); min-height: 72px;
      }

      .player-info { min-width: 120px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.9rem; }

      .player-controls { display: flex; align-items: center; gap: 0.5rem; }

      .player-controls button {
        background: none; border: none; color: var(--text-color);
        cursor: pointer; padding: 0.35rem; border-radius: 4px;
        opacity: 0.9; transition: opacity 0.2s;
      }

      .player-controls button:hover { opacity: 1; background: var(--hover-color); }

      .player-controls button:disabled { opacity: 0.4; cursor: not-allowed; }

      .player-progress { flex: 1; min-width: 100px; display: flex; align-items: center; gap: 0.5rem; }

      .player-progress input[type="range"] {
        flex: 1; height: 6px; accent-color: var(--accent-color);
        background: var(--border-color); border-radius: 3px;
      }

      .player-time { font-size: 0.8rem; opacity: 0.8; min-width: 90px; text-align: center; }

      .player-volume { display: flex; align-items: center; gap: 0.35rem; min-width: 120px; }

      .player-volume input[type="range"] {
        flex: 1; height: 6px; accent-color: var(--accent-color);
        background: var(--border-color); border-radius: 3px;
      }

      .form-control, .form-select {
        background-color: var(--card-bg-color); color: var(--text-color);
        border-color: var(--border-color);
      }

      .form-control:focus, .form-select:focus {
        background-color: var(--card-bg-color); color: var(--text-color);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }

      .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

      html[data-theme='light'] .btn-close { filter: none; }

      .modal-content { background-color: var(--card-bg-color); color: var(--text-color); border-color: var(--border-color); }

      .modal-header, .modal-footer { border-color: var(--border-color); }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Audio Player</a>
        <button id="theme-switcher" class="btn btn-sm btn-outline-secondary" type="button" title="Toggle theme">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </nav>

    <div class="main-container">
      <div class="nav-column" id="folders-column">
        <div class="column-header">
          <div class="column-title">
            <i class="fas fa-folder"></i>
            <span class="column-title-text">Folders</span>
          </div>
          <button class="collapse-btn" data-target="folders-column" title="Toggle"><i class="fas fa-chevron-left"></i></button>
        </div>
        <div class="column-content">
          <ul class="item-list" id="folders-list"></ul>
          <button class="add-item-btn" id="add-folder-btn">
            <i class="fas fa-plus"></i>
            <span class="add-btn-text">Add Folder</span>
          </button>
        </div>
      </div>

      <div class="nav-column" id="subfolders-column">
        <div class="column-header">
          <div class="column-title">
            <i class="fas fa-folder-open"></i>
            <span class="column-title-text">Subfolders</span>
          </div>
          <button class="collapse-btn" data-target="subfolders-column" title="Toggle"><i class="fas fa-chevron-left"></i></button>
        </div>
        <div class="column-content">
          <ul class="item-list" id="subfolders-list"></ul>
          <button class="add-item-btn" id="add-subfolder-btn" style="display: none;">
            <i class="fas fa-plus"></i>
            <span class="add-btn-text">Add Subfolder</span>
          </button>
        </div>
      </div>

      <div class="content-area">
        <div class="content-header">
          <div class="content-path" id="content-path"></div>
          <div class="continue-checkbox" id="continue-wrap" style="display: none;">
            <input type="checkbox" id="continue-next" />
            <label for="continue-next">Continue to next</label>
          </div>
        </div>
        <div class="content-body">
          <div class="no-selection" id="no-selection">
            <i class="fas fa-music"></i>
            <p>Select a subfolder to add and play audio</p>
          </div>
          <div id="tracks-container" style="display: none;">
            <div class="drop-zone" id="drop-zone">
              Drag audio files here (mp3, m4a, ogg, etc.)
            </div>
            <ul class="tracks-list" id="tracks-list"></ul>
          </div>
        </div>
      </div>
    </div>

    <div class="player-bar">
      <div class="player-info" id="player-info">No track</div>
      <div class="player-controls">
        <button type="button" id="btn-prev" title="Previous"><i class="fas fa-step-backward"></i></button>
        <button type="button" id="btn-play" title="Play/Pause"><i class="fas fa-play"></i></button>
        <button type="button" id="btn-next" title="Next"><i class="fas fa-step-forward"></i></button>
      </div>
      <div class="player-progress">
        <input type="range" id="progress-range" min="0" max="100" value="0" step="0.1" />
      </div>
      <div class="player-time" id="player-time">0:00 / 0:00</div>
      <div class="player-volume">
        <i class="fas fa-volume-up" style="opacity: 0.8;"></i>
        <input type="range" id="volume-range" min="0" max="100" value="100" />
      </div>
    </div>

    <audio id="audio-el" style="display: none;"></audio>

    <!-- Description modal (optional, for editing description in a modal if preferred - we use inline panel) -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const DB_NAME = 'AudioPlayerDB';
      const DB_VERSION = 1;
      let db = null;

      const openDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onerror = () => reject(request.error);
          request.onsuccess = () => { db = request.result; resolve(db); };
          request.onupgradeneeded = (event) => {
            const database = event.target.result;
            if (!database.objectStoreNames.contains('folders')) {
              const store = database.createObjectStore('folders', { keyPath: 'id' });
              store.createIndex('order', 'order', { unique: false });
            }
            if (!database.objectStoreNames.contains('subfolders')) {
              const store = database.createObjectStore('subfolders', { keyPath: 'id' });
              store.createIndex('folderId', 'folderId', { unique: false });
              store.createIndex('order', 'order', { unique: false });
            }
            if (!database.objectStoreNames.contains('tracks')) {
              const store = database.createObjectStore('tracks', { keyPath: 'id' });
              store.createIndex('subfolderId', 'subfolderId', { unique: false });
            }
          };
        });
      };

      const dbAdd = (storeName, data) => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          const req = store.add(data);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      };

      const dbPut = (storeName, data) => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          const req = store.put(data);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      };

      const dbDelete = (storeName, id) => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          const req = store.delete(id);
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      };

      const dbGetAll = (storeName) => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readonly');
          const store = tx.objectStore(storeName);
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      };

      const dbGetByIndex = (storeName, indexName, value) => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readonly');
          const store = tx.objectStore(storeName);
          const index = store.index(indexName);
          const req = index.getAll(value);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      };

      const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

      const escapeHtml = (str) => {
        if (str == null) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      };

      let state = {
        folders: [],
        subfolders: [],
        tracks: [],
        selectedFolderId: null,
        selectedSubfolderId: null,
        currentTrackId: null,
        currentTrackIndex: -1,
        expandedDescTrackId: null
      };

      const foldersList = document.getElementById('folders-list');
      const subfoldersList = document.getElementById('subfolders-list');
      const addFolderBtn = document.getElementById('add-folder-btn');
      const addSubfolderBtn = document.getElementById('add-subfolder-btn');
      const contentPath = document.getElementById('content-path');
      const continueWrap = document.getElementById('continue-wrap');
      const continueNextCheckbox = document.getElementById('continue-next');
      const noSelection = document.getElementById('no-selection');
      const tracksContainer = document.getElementById('tracks-container');
      const dropZone = document.getElementById('drop-zone');
      const tracksListEl = document.getElementById('tracks-list');
      const audioEl = document.getElementById('audio-el');
      const playerInfo = document.getElementById('player-info');
      const btnPrev = document.getElementById('btn-prev');
      const btnPlay = document.getElementById('btn-play');
      const btnNext = document.getElementById('btn-next');
      const progressRange = document.getElementById('progress-range');
      const playerTime = document.getElementById('player-time');
      const volumeRange = document.getElementById('volume-range');

      function getSortedTracks(subfolderId) {
        const list = state.tracks.filter(t => t.subfolderId === subfolderId);
        return list.sort((a, b) => (a.name || '').localeCompare(b.name || '', undefined, { sensitivity: 'base' }));
      }

      function getCurrentSortedTracks() {
        if (!state.selectedSubfolderId) return [];
        return getSortedTracks(state.selectedSubfolderId);
      }

      function renderFolders() {
        foldersList.innerHTML = '';
        const sorted = [...state.folders].sort((a, b) => a.order - b.order);
        sorted.forEach(folder => {
          const li = document.createElement('li');
          li.dataset.id = folder.id;
          if (folder.id === state.selectedFolderId) li.classList.add('selected');
          li.innerHTML = `
            <span class="item-name">${escapeHtml(folder.name)}</span>
            <div class="item-actions">
              <button class="rename-btn" title="Rename"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
          `;
          li.addEventListener('click', (e) => {
            if (!e.target.closest('.item-actions')) selectFolder(folder.id);
          });
          li.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); renameFolder(folder.id); });
          li.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteFolder(folder.id); });
          foldersList.appendChild(li);
        });
      }

      function renderSubfolders() {
        subfoldersList.innerHTML = '';
        const filtered = state.subfolders.filter(s => s.folderId === state.selectedFolderId);
        const sorted = [...filtered].sort((a, b) => a.order - b.order);
        addSubfolderBtn.style.display = state.selectedFolderId ? 'flex' : 'none';
        sorted.forEach(sub => {
          const li = document.createElement('li');
          li.dataset.id = sub.id;
          if (sub.id === state.selectedSubfolderId) li.classList.add('selected');
          li.innerHTML = `
            <span class="item-name">${escapeHtml(sub.name)}</span>
            <div class="item-actions">
              <button class="rename-btn" title="Rename"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
          `;
          li.addEventListener('click', (e) => {
            if (!e.target.closest('.item-actions')) selectSubfolder(sub.id);
          });
          li.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); renameSubfolder(sub.id); });
          li.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteSubfolder(sub.id); });
          subfoldersList.appendChild(li);
        });
      }

      function renderContentPath() {
        const folder = state.folders.find(f => f.id === state.selectedFolderId);
        const sub = state.subfolders.find(s => s.id === state.selectedSubfolderId);
        if (sub && folder) {
          contentPath.innerHTML = `<span>${escapeHtml(folder.name)}</span> / <strong>${escapeHtml(sub.name)}</strong>`;
        } else {
          contentPath.innerHTML = '';
        }
      }

      function renderContinueCheckbox() {
        const sub = state.subfolders.find(s => s.id === state.selectedSubfolderId);
        if (sub) {
          continueWrap.style.display = 'flex';
          continueNextCheckbox.checked = !!sub.continueToNext;
        } else {
          continueWrap.style.display = 'none';
        }
      }

      function renderTracks() {
        tracksListEl.innerHTML = '';
        const sorted = getCurrentSortedTracks();
        sorted.forEach((track) => {
          const li = document.createElement('li');
          li.className = 'track-item' + (track.id === state.currentTrackId ? ' playing' : '');
          li.dataset.trackId = track.id;
          const row = document.createElement('div');
          row.className = 'track-row';
          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.className = 'track-name-input';
          nameInput.value = track.name || '';
          nameInput.placeholder = 'Track name';
          nameInput.addEventListener('change', () => {
            const t = state.tracks.find(x => x.id === track.id);
            if (t && t.name !== nameInput.value.trim()) {
              t.name = nameInput.value.trim() || t.originalFilename || 'Untitled';
              dbPut('tracks', t);
            }
          });
          const descBtn = document.createElement('button');
          descBtn.type = 'button';
          descBtn.className = 'track-desc-btn';
          descBtn.title = 'Description / Lyrics';
          descBtn.innerHTML = '<i class="fas fa-align-left"></i>';
          descBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDescPanel(track.id);
          });
          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'track-delete';
          deleteBtn.title = 'Delete';
          deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteTrack(track.id);
          });
          const playBtn = document.createElement('button');
          playBtn.type = 'button';
          playBtn.className = 'track-play';
          playBtn.title = 'Play';
          playBtn.innerHTML = track.id === state.currentTrackId && !audioEl.paused ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
          playBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (track.id === state.currentTrackId && !audioEl.paused) {
              audioEl.pause();
              updatePlayerUI();
            } else {
              playTrackById(track.id);
            }
          });
          row.appendChild(playBtn);
          row.appendChild(nameInput);
          row.appendChild(descBtn);
          row.appendChild(deleteBtn);
          li.appendChild(row);
          if (state.expandedDescTrackId === track.id) {
            const panel = document.createElement('div');
            panel.className = 'track-desc-panel';
            const textarea = document.createElement('textarea');
            textarea.placeholder = 'Description / Lyrics';
            textarea.value = track.description || '';
            textarea.addEventListener('change', () => {
              const t = state.tracks.find(x => x.id === track.id);
              if (t) {
                t.description = textarea.value;
                dbPut('tracks', t);
              }
            });
            panel.appendChild(textarea);
            li.appendChild(panel);
          }
          tracksListEl.appendChild(li);
        });
      }

      function toggleDescPanel(trackId) {
        state.expandedDescTrackId = state.expandedDescTrackId === trackId ? null : trackId;
        renderTracks();
        if (state.expandedDescTrackId) {
          const track = state.tracks.find(t => t.id === trackId);
          const panel = tracksListEl.querySelector(`.track-item[data-track-id="${trackId}"] .track-desc-panel`);
          if (panel && track) {
            const ta = panel.querySelector('textarea');
            if (ta) ta.value = track.description || '';
          }
        }
      }

      function renderContent() {
        renderContentPath();
        renderContinueCheckbox();
        if (state.selectedSubfolderId) {
          noSelection.style.display = 'none';
          tracksContainer.style.display = 'flex';
          tracksContainer.style.flexDirection = 'column';
          renderTracks();
        } else {
          noSelection.style.display = 'flex';
          tracksContainer.style.display = 'none';
        }
      }

      function updatePlayerUI() {
        const sorted = getCurrentSortedTracks();
        const idx = state.currentTrackIndex >= 0 && state.currentTrackIndex < sorted.length ? state.currentTrackIndex : -1;
        const track = idx >= 0 ? sorted[idx] : null;
        if (track) {
          playerInfo.textContent = track.name || track.originalFilename || 'Untitled';
        } else {
          playerInfo.textContent = 'No track';
        }
        btnPrev.disabled = sorted.length === 0;
        btnNext.disabled = sorted.length === 0;
        btnPlay.disabled = sorted.length === 0;
        const playIcon = btnPlay.querySelector('i');
        if (audioEl.paused) {
          playIcon.className = 'fas fa-play';
        } else {
          playIcon.className = 'fas fa-pause';
        }
        renderTracks();
      }

      function selectFolder(folderId) {
        state.selectedFolderId = folderId;
        state.selectedSubfolderId = null;
        renderFolders();
        renderSubfolders();
        renderContent();
        saveState();
      }

      function selectSubfolder(subfolderId) {
        state.selectedSubfolderId = subfolderId;
        renderSubfolders();
        renderContent();
        saveState();
      }

      async function addFolder() {
        const name = prompt('Folder name:', 'New Folder');
        if (!name || !name.trim()) return;
        const folder = {
          id: generateId(),
          name: name.trim(),
          order: state.folders.length,
          createdAt: Date.now()
        };
        await dbAdd('folders', folder);
        state.folders.push(folder);
        renderFolders();
        selectFolder(folder.id);
      }

      async function renameFolder(folderId) {
        const folder = state.folders.find(f => f.id === folderId);
        if (!folder) return;
        const name = prompt('Folder name:', folder.name);
        if (!name || !name.trim()) return;
        folder.name = name.trim();
        await dbPut('folders', folder);
        renderFolders();
        renderContentPath();
      }

      async function deleteFolder(folderId) {
        if (!confirm('Delete this folder and all its subfolders and tracks?')) return;
        const subs = state.subfolders.filter(s => s.folderId === folderId);
        for (const sub of subs) {
          const trks = state.tracks.filter(t => t.subfolderId === sub.id);
          for (const t of trks) await dbDelete('tracks', t.id);
          await dbDelete('subfolders', sub.id);
        }
        await dbDelete('folders', folderId);
        state.tracks = state.tracks.filter(t => !subs.some(s => s.id === t.subfolderId));
        state.subfolders = state.subfolders.filter(s => s.folderId !== folderId);
        state.folders = state.folders.filter(f => f.id !== folderId);
        if (state.selectedFolderId === folderId) {
          state.selectedFolderId = null;
          state.selectedSubfolderId = null;
          if (state.currentTrackId) stopAndClearTrack();
        }
        renderFolders();
        renderSubfolders();
        renderContent();
        updatePlayerUI();
        saveState();
      }

      async function addSubfolder() {
        if (!state.selectedFolderId) return;
        const name = prompt('Subfolder name:', 'New Subfolder');
        if (!name || !name.trim()) return;
        const subsInFolder = state.subfolders.filter(s => s.folderId === state.selectedFolderId);
        const sub = {
          id: generateId(),
          folderId: state.selectedFolderId,
          name: name.trim(),
          order: subsInFolder.length,
          continueToNext: false,
          createdAt: Date.now()
        };
        await dbAdd('subfolders', sub);
        state.subfolders.push(sub);
        renderSubfolders();
        selectSubfolder(sub.id);
      }

      async function renameSubfolder(subfolderId) {
        const sub = state.subfolders.find(s => s.id === subfolderId);
        if (!sub) return;
        const name = prompt('Subfolder name:', sub.name);
        if (!name || !name.trim()) return;
        sub.name = name.trim();
        await dbPut('subfolders', sub);
        renderSubfolders();
        renderContentPath();
      }

      async function deleteSubfolder(subfolderId) {
        if (!confirm('Delete this subfolder and all its tracks?')) return;
        const trks = state.tracks.filter(t => t.subfolderId === subfolderId);
        for (const t of trks) await dbDelete('tracks', t.id);
        await dbDelete('subfolders', subfolderId);
        state.tracks = state.tracks.filter(t => t.subfolderId !== subfolderId);
        state.subfolders = state.subfolders.filter(s => s.id !== subfolderId);
        if (state.selectedSubfolderId === subfolderId) {
          state.selectedSubfolderId = null;
          if (state.currentTrackId) stopAndClearTrack();
        }
        renderSubfolders();
        renderContent();
        updatePlayerUI();
        saveState();
      }

      let currentObjectUrl = null;

      function stopAndClearTrack() {
        audioEl.pause();
        audioEl.removeAttribute('src');
        if (currentObjectUrl) {
          URL.revokeObjectURL(currentObjectUrl);
          currentObjectUrl = null;
        }
        state.currentTrackId = null;
        state.currentTrackIndex = -1;
        progressRange.value = 0;
        playerTime.textContent = '0:00 / 0:00';
        updatePlayerUI();
      }

      function playTrackById(trackId) {
        const sorted = getCurrentSortedTracks();
        const idx = sorted.findIndex(t => t.id === trackId);
        if (idx < 0) return;
        const track = sorted[idx];
        if (!track.blob) return;
        if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
        currentObjectUrl = URL.createObjectURL(track.blob);
        audioEl.src = currentObjectUrl;
        state.currentTrackId = track.id;
        state.currentTrackIndex = idx;
        audioEl.volume = volumeRange.value / 100;
        audioEl.play().catch(() => {});
        updatePlayerUI();
      }

      function playTrackByIndex(index) {
        const sorted = getCurrentSortedTracks();
        if (index < 0 || index >= sorted.length) return;
        playTrackById(sorted[index].id);
      }

      function onAudioEnded() {
        const sub = state.subfolders.find(s => s.id === state.selectedSubfolderId);
        if (sub && sub.continueToNext) {
          const sorted = getCurrentSortedTracks();
          const nextIdx = state.currentTrackIndex + 1;
          if (nextIdx < sorted.length) {
            playTrackByIndex(nextIdx);
            return;
          }
        }
        state.currentTrackId = null;
        state.currentTrackIndex = -1;
        progressRange.value = 0;
        playerTime.textContent = '0:00 / 0:00';
        updatePlayerUI();
      }

      continueNextCheckbox.addEventListener('change', async () => {
        const sub = state.subfolders.find(s => s.id === state.selectedSubfolderId);
        if (!sub) return;
        sub.continueToNext = continueNextCheckbox.checked;
        await dbPut('subfolders', sub);
      });

      async function deleteTrack(trackId) {
        if (!confirm('Delete this track?')) return;
        await dbDelete('tracks', trackId);
        state.tracks = state.tracks.filter(t => t.id !== trackId);
        if (state.currentTrackId === trackId) stopAndClearTrack();
        else {
          const sorted = getCurrentSortedTracks();
          const newIdx = sorted.findIndex(t => t.id === state.currentTrackId);
          state.currentTrackIndex = newIdx;
          updatePlayerUI();
        }
        renderTracks();
        saveState();
      }

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (state.selectedSubfolderId) dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('drag-over');
        if (!state.selectedSubfolderId) return;
        const files = [...e.dataTransfer.files].filter(f => f.type.startsWith('audio/'));
        for (const file of files) {
          const name = file.name.replace(/\.[^.]+$/, '') || file.name;
          const track = {
            id: generateId(),
            subfolderId: state.selectedSubfolderId,
            name,
            originalFilename: file.name,
            description: '',
            blob: file,
            createdAt: Date.now()
          };
          await dbAdd('tracks', track);
          state.tracks.push(track);
        }
        renderTracks();
        updatePlayerUI();
      });

      btnPrev.addEventListener('click', () => {
        const sorted = getCurrentSortedTracks();
        if (sorted.length === 0) return;
        const idx = state.currentTrackIndex <= 0 ? sorted.length - 1 : state.currentTrackIndex - 1;
        playTrackByIndex(idx);
      });

      btnPlay.addEventListener('click', () => {
        const sorted = getCurrentSortedTracks();
        if (sorted.length === 0) return;
        if (state.currentTrackId && state.currentTrackIndex >= 0) {
          if (audioEl.paused) audioEl.play();
          else audioEl.pause();
        } else {
          playTrackByIndex(0);
        }
        updatePlayerUI();
      });

      btnNext.addEventListener('click', () => {
        const sorted = getCurrentSortedTracks();
        if (sorted.length === 0) return;
        const idx = state.currentTrackIndex < 0 || state.currentTrackIndex >= sorted.length - 1 ? 0 : state.currentTrackIndex + 1;
        playTrackByIndex(idx);
      });

      progressRange.addEventListener('input', () => {
        if (!isFinite(audioEl.duration)) return;
        const pct = progressRange.value;
        audioEl.currentTime = (pct / 100) * audioEl.duration;
      });

      audioEl.addEventListener('timeupdate', () => {
        if (!isFinite(audioEl.duration)) return;
        progressRange.value = (audioEl.currentTime / audioEl.duration) * 100;
        const m1 = Math.floor(audioEl.currentTime / 60);
        const s1 = Math.floor(audioEl.currentTime % 60);
        const m2 = Math.floor(audioEl.duration / 60);
        const s2 = Math.floor(audioEl.duration % 60);
        playerTime.textContent = `${m1}:${s1.toString().padStart(2, '0')} / ${m2}:${s2.toString().padStart(2, '0')}`;
      });

      audioEl.addEventListener('ended', onAudioEnded);

      audioEl.addEventListener('loadedmetadata', () => {
        if (isFinite(audioEl.duration)) {
          const m = Math.floor(audioEl.duration / 60);
          const s = Math.floor(audioEl.duration % 60);
          playerTime.textContent = `0:00 / ${m}:${s.toString().padStart(2, '0')}`;
        }
      });

      volumeRange.addEventListener('input', () => {
        audioEl.volume = volumeRange.value / 100;
        try { localStorage.setItem('audio_player_volume', volumeRange.value); } catch (e) {}
      });

      progressRange.addEventListener('click', (e) => {
        const rect = progressRange.getBoundingClientRect();
        const pct = ((e.clientX - rect.left) / rect.width) * 100;
        progressRange.value = pct;
        if (isFinite(audioEl.duration)) audioEl.currentTime = (pct / 100) * audioEl.duration;
      });

      addFolderBtn.addEventListener('click', addFolder);
      addSubfolderBtn.addEventListener('click', addSubfolder);

      document.getElementById('theme-switcher').addEventListener('click', () => {
        const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        const icon = document.querySelector('#theme-switcher i');
        icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        try { localStorage.setItem('audio_player_theme', theme); } catch (e) {}
      });

      function saveState() {
        try {
          localStorage.setItem('audio_player_state', JSON.stringify({
            selectedFolderId: state.selectedFolderId,
            selectedSubfolderId: state.selectedSubfolderId
          }));
        } catch (e) {}
      }

      function loadState() {
        try {
          const s = localStorage.getItem('audio_player_state');
          if (s) {
            const parsed = JSON.parse(s);
            state.selectedFolderId = parsed.selectedFolderId || null;
            state.selectedSubfolderId = parsed.selectedSubfolderId || null;
          }
          const vol = localStorage.getItem('audio_player_volume');
          if (vol != null) volumeRange.value = Math.min(100, Math.max(0, parseInt(vol, 10)));
          const theme = localStorage.getItem('audio_player_theme');
          if (theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.querySelector('#theme-switcher i');
            icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
          }
        } catch (e) {}
      }

      function setupCollapseButtons() {
        document.querySelectorAll('.collapse-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const targetId = btn.dataset.target;
            const col = document.getElementById(targetId);
            if (col) col.classList.toggle('collapsed');
            try {
              const collapseState = {};
              document.querySelectorAll('.nav-column').forEach(c => {
                collapseState[c.id] = c.classList.contains('collapsed');
              });
              localStorage.setItem('audio_player_collapse', JSON.stringify(collapseState));
            } catch (e) {}
          });
        });
        try {
          const saved = localStorage.getItem('audio_player_collapse');
          if (saved) {
            const obj = JSON.parse(saved);
            Object.entries(obj).forEach(([id, collapsed]) => {
              const col = document.getElementById(id);
              if (col && collapsed) col.classList.add('collapsed');
            });
          }
        } catch (e) {}
      }

      const init = async () => {
        await openDB();
        state.folders = await dbGetAll('folders');
        state.subfolders = await dbGetAll('subfolders');
        state.tracks = await dbGetAll('tracks');
        loadState();
        audioEl.volume = volumeRange.value / 100;
        if (state.selectedFolderId && !state.folders.find(f => f.id === state.selectedFolderId)) state.selectedFolderId = null;
        if (state.selectedSubfolderId && !state.subfolders.find(s => s.id === state.selectedSubfolderId)) state.selectedSubfolderId = null;
        setupCollapseButtons();
        renderFolders();
        renderSubfolders();
        renderContent();
        updatePlayerUI();
      };

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
