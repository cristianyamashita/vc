<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>タイプインベーダー 日本語版</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a1a;
      --text: #ff6b9d;
      --text-dim: #cc5580;
      --accent: #00ff88;
      --accent-2: #ffcc00;
      --word-bg: rgba(255, 107, 157, 0.1);
      --word-border: #ff6b9d;
      --correct: #00ff88;
      --wrong: #ff3366;
      --panel-bg: rgba(10, 10, 26, 0.95);
      --hiragana: #ff6b9d;
      --katakana: #00aaff;
      --kanji: #ffcc00;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans JP', 'Courier New', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
    }

    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: 
        radial-gradient(ellipse at 50% 0%, rgba(255, 107, 157, 0.1) 0%, transparent 50%),
        linear-gradient(180deg, #0a0a1a 0%, #050510 100%);
      overflow: hidden;
    }

    /* Stars background with sakura petals effect */
    .stars {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, #ffb7c5, transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(255,183,197,0.8), transparent),
        radial-gradient(1px 1px at 90px 40px, white, transparent),
        radial-gradient(2px 2px at 130px 80px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 160px 120px, #ffb7c5, transparent);
      background-size: 200px 200px;
      animation: stars-move 100s linear infinite;
    }

    @keyframes stars-move {
      from { background-position: 0 0; }
      to { background-position: 0 1000px; }
    }

    /* HUD */
    #hud {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
      z-index: 100;
      font-size: 16px;
    }

    .hud-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hud-label {
      color: var(--text-dim);
      text-transform: uppercase;
      font-size: 12px;
    }

    .hud-value {
      font-size: 20px;
      font-weight: bold;
      color: var(--text);
      text-shadow: 0 0 10px var(--text);
    }

    #lives {
      display: flex;
      gap: 5px;
    }

    .life {
      width: 20px;
      height: 20px;
      background: var(--accent);
      clip-path: polygon(50% 0%, 100% 35%, 80% 100%, 50% 75%, 20% 100%, 0% 35%);
      box-shadow: 0 0 10px var(--accent);
    }

    .life.lost {
      background: #333;
      box-shadow: none;
    }

    /* Game area */
    #game-area {
      position: absolute;
      top: 60px;
      bottom: 120px;
      left: 0;
      right: 0;
    }

    /* Defense line */
    #defense-line {
      position: absolute;
      bottom: 120px;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        var(--wrong) 20%, 
        var(--wrong) 80%, 
        transparent 100%);
      box-shadow: 0 0 20px var(--wrong), 0 0 40px var(--wrong);
      animation: pulse-line 2s ease-in-out infinite;
    }

    @keyframes pulse-line {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }

    /* Words */
    .word {
      position: absolute;
      padding: 8px 16px;
      background: var(--word-bg);
      border: 2px solid var(--word-border);
      border-radius: 8px;
      font-size: 28px;
      font-weight: bold;
      letter-spacing: 2px;
      transition: transform 0.1s ease;
      cursor: default;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .word.hiragana {
      border-color: var(--hiragana);
      background: rgba(255, 107, 157, 0.15);
    }

    .word.katakana {
      border-color: var(--katakana);
      background: rgba(0, 170, 255, 0.15);
    }

    .word.kanji {
      border-color: var(--kanji);
      background: rgba(255, 204, 0, 0.15);
    }

    .word.targeted {
      box-shadow: 0 0 20px currentColor, 0 0 40px rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .word .japanese {
      font-size: 32px;
    }

    .word .romaji {
      font-size: 14px;
      color: var(--text-dim);
      letter-spacing: 1px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .word.show-romaji .romaji {
      opacity: 1;
    }

    .word.show-romaji {
      border-style: dashed;
      opacity: 0.8;
    }

    .word .typed {
      color: var(--correct);
      text-shadow: 0 0 10px var(--correct);
    }

    .word .remaining {
      color: inherit;
      opacity: 0.7;
    }

    /* Input area */
    #input-area {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 120px;
      background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 15px;
    }

    #current-target {
      font-size: 14px;
      color: var(--text-dim);
      height: 20px;
    }

    #input-wrapper {
      position: relative;
      width: 100%;
      max-width: 500px;
    }

    #type-input {
      width: 100%;
      padding: 15px 25px;
      font-size: 28px;
      font-family: 'Noto Sans JP', 'Courier New', monospace;
      background: rgba(255, 107, 157, 0.1);
      border: 3px solid var(--text);
      border-radius: 12px;
      color: var(--text);
      text-align: center;
      letter-spacing: 4px;
      outline: none;
      box-shadow: 0 0 30px rgba(255, 107, 157, 0.2), inset 0 0 20px rgba(255, 107, 157, 0.1);
    }

    #type-input:focus {
      border-color: var(--accent-2);
      box-shadow: 0 0 30px rgba(255, 204, 0, 0.3), inset 0 0 20px rgba(255, 204, 0, 0.1);
    }

    #type-input.error {
      border-color: var(--wrong);
      animation: shake 0.3s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    /* Explosions */
    .explosion {
      position: absolute;
      pointer-events: none;
      animation: explode 0.5s ease-out forwards;
    }

    .explosion-particle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--text);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--text);
    }

    @keyframes explode {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }

    /* Screens */
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--panel-bg);
      z-index: 1000;
      gap: 20px;
      padding: 20px;
    }

    .screen.hidden {
      display: none;
    }

    .screen h1 {
      font-size: 42px;
      text-shadow: 0 0 20px var(--text);
      letter-spacing: 4px;
    }

    .screen h2 {
      font-size: 28px;
      color: var(--accent);
      text-shadow: 0 0 15px var(--accent);
    }

    .screen p {
      font-size: 16px;
      color: var(--text-dim);
      text-align: center;
      max-width: 500px;
      line-height: 1.6;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 20px 0;
    }

    .stat-item {
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-dim);
    }

    .stat-value {
      font-size: 28px;
      color: var(--text);
      text-shadow: 0 0 10px var(--text);
    }

    .btn {
      padding: 15px 40px;
      font-size: 18px;
      font-family: 'Noto Sans JP', 'Courier New', monospace;
      background: transparent;
      border: 3px solid var(--text);
      color: var(--text);
      border-radius: 10px;
      cursor: pointer;
      letter-spacing: 2px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      background: var(--text);
      color: var(--bg);
      box-shadow: 0 0 30px var(--text);
    }

    .btn-secondary {
      border-color: var(--accent-2);
      color: var(--accent-2);
    }

    .btn-secondary:hover {
      background: var(--accent-2);
      color: var(--bg);
      box-shadow: 0 0 30px var(--accent-2);
    }

    /* Language selector */
    .lang-selector {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }

    .lang-btn {
      padding: 8px 12px;
      font-size: 14px;
      font-family: 'Noto Sans JP', 'Courier New', monospace;
      background: transparent;
      border: 2px solid var(--text-dim);
      color: var(--text-dim);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .lang-btn:hover, .lang-btn.active {
      border-color: var(--text);
      color: var(--text);
    }

    /* Category selector */
    .category-selector {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 15px 0;
    }

    .category-btn {
      padding: 12px 24px;
      font-size: 16px;
      font-family: 'Noto Sans JP', 'Courier New', monospace;
      background: transparent;
      border: 2px solid var(--text-dim);
      color: var(--text-dim);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .category-btn.hiragana {
      border-color: var(--hiragana);
      color: var(--hiragana);
    }

    .category-btn.katakana {
      border-color: var(--katakana);
      color: var(--katakana);
    }

    .category-btn.kanji {
      border-color: var(--kanji);
      color: var(--kanji);
    }

    .category-btn:hover, .category-btn.active {
      transform: scale(1.05);
      box-shadow: 0 0 20px currentColor;
    }

    .category-btn.active {
      background: rgba(255, 255, 255, 0.1);
    }

    .category-btn .name {
      font-size: 18px;
      font-weight: bold;
    }

    .category-btn .sample {
      font-size: 24px;
    }

    /* Difficulty selector */
    .difficulty-selector {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 10px 0;
    }

    .difficulty-btn {
      padding: 10px 20px;
      font-size: 14px;
      font-family: 'Noto Sans JP', 'Courier New', monospace;
      background: transparent;
      border: 2px solid var(--text-dim);
      color: var(--text-dim);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .difficulty-btn:hover, .difficulty-btn.active {
      border-color: var(--accent);
      color: var(--accent);
    }

    .difficulty-btn.active {
      background: rgba(0, 255, 136, 0.1);
    }

    /* Level up notification */
    #level-up {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      color: var(--accent-2);
      text-shadow: 0 0 30px var(--accent-2);
      animation: level-up 1.5s ease-out forwards;
      pointer-events: none;
      z-index: 500;
    }

    #level-up.hidden {
      display: none;
    }

    @keyframes level-up {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
    }

    /* Combo indicator */
    #combo {
      position: absolute;
      top: 100px;
      right: 30px;
      text-align: right;
    }

    #combo.hidden {
      display: none;
    }

    #combo-count {
      font-size: 36px;
      color: var(--accent-2);
      text-shadow: 0 0 15px var(--accent-2);
    }

    #combo-label {
      font-size: 14px;
      color: var(--text-dim);
    }

    /* Category indicator */
    #category-display {
      position: absolute;
      top: 100px;
      left: 30px;
    }

    .category-label {
      font-size: 12px;
      color: var(--text-dim);
    }

    .category-name {
      font-size: 18px;
      font-weight: bold;
    }

    .category-name.hiragana { color: var(--hiragana); }
    .category-name.katakana { color: var(--katakana); }
    .category-name.kanji { color: var(--kanji); }

    /* Instructions */
    .instructions {
      background: rgba(255, 107, 157, 0.1);
      border: 1px solid var(--text-dim);
      border-radius: 10px;
      padding: 15px 25px;
      margin: 15px 0;
      max-width: 500px;
    }

    .instructions h3 {
      color: var(--text);
      margin-bottom: 10px;
      font-size: 16px;
    }

    .instructions ul {
      list-style: none;
      text-align: left;
    }

    .instructions li {
      padding: 4px 0;
      color: var(--text-dim);
      font-size: 14px;
    }

    .instructions li::before {
      content: '▸ ';
      color: var(--accent-2);
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 10px 0;
      font-size: 14px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .legend-dot.hiragana { background: var(--hiragana); }
    .legend-dot.katakana { background: var(--katakana); }
    .legend-dot.kanji { background: var(--kanji); }
  </style>
</head>
<body>
  <div id="game-container">
    <div class="stars"></div>
    
    <!-- Start Screen -->
    <div id="start-screen" class="screen">
      <div class="lang-selector">
        <button class="lang-btn" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="pt">PT</button>
        <button class="lang-btn active" data-lang="ja">JA</button>
      </div>
      <h1 data-i18n="title">タイプインベーダー</h1>
      <p data-i18n="subtitle">日本語版</p>
      <p data-i18n="description">ローマ字をタイプして日本語の単語を撃破！防衛ラインに到達する前に倒そう。</p>
      
      <div class="category-selector">
        <button class="category-btn hiragana active" data-category="hiragana">
          <span class="name" data-i18n="hiragana">ひらがな</span>
          <span class="sample">あいう</span>
        </button>
        <button class="category-btn katakana" data-category="katakana">
          <span class="name" data-i18n="katakana">カタカナ</span>
          <span class="sample">アイウ</span>
        </button>
        <button class="category-btn kanji" data-category="kanji">
          <span class="name" data-i18n="kanji">漢字</span>
          <span class="sample">日本語</span>
        </button>
      </div>

      <div>
        <p style="margin-bottom: 8px;" data-i18n="difficulty">難易度</p>
        <div class="difficulty-selector">
          <button class="difficulty-btn active" data-difficulty="1" data-i18n="level1">レベル1</button>
          <button class="difficulty-btn" data-difficulty="2" data-i18n="level2">レベル2</button>
          <button class="difficulty-btn" data-difficulty="3" data-i18n="level3">レベル3</button>
          <button class="difficulty-btn" data-difficulty="4" data-i18n="level4">レベル4</button>
          <button class="difficulty-btn" data-difficulty="5" data-i18n="level5">レベル5</button>
        </div>
      </div>

      <div class="instructions">
        <h3 data-i18n="howToPlay">遊び方</h3>
        <ul>
          <li data-i18n="instruction1">日本語を見てローマ字をタイプ（最初はローマ字非表示）</li>
          <li data-i18n="instruction2">タイプすると自動的に単語がマッチ</li>
          <li data-i18n="instruction3">単語を完成させて破壊</li>
          <li data-i18n="instruction4">赤いラインに到達させないで！</li>
          <li data-i18n="instruction5">コンボでボーナスポイント</li>
          <li data-i18n="instruction6">⚠️ ローマ字が表示されると得点が半分に！</li>
        </ul>
      </div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-dot hiragana"></div>
          <span data-i18n="hiragana">ひらがな</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot katakana"></div>
          <span data-i18n="katakana">カタカナ</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot kanji"></div>
          <span data-i18n="kanji">漢字</span>
        </div>
      </div>

      <button class="btn" id="start-btn" data-i18n="startGame">ゲーム開始</button>
    </div>

    <!-- Game Over Screen -->
    <div id="gameover-screen" class="screen hidden">
      <h2 data-i18n="gameOver">ゲームオーバー</h2>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-label" data-i18n="finalScore">最終スコア</div>
          <div class="stat-value" id="final-score">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label" data-i18n="level">レベル</div>
          <div class="stat-value" id="final-level">1</div>
        </div>
        <div class="stat-item">
          <div class="stat-label" data-i18n="wordsDestroyed">破壊した単語</div>
          <div class="stat-value" id="final-words">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label" data-i18n="maxCombo">最大コンボ</div>
          <div class="stat-value" id="final-combo">0</div>
        </div>
      </div>
      <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
        <button class="btn" id="restart-btn" data-i18n="playAgain">もう一度</button>
        <button class="btn btn-secondary" id="menu-btn" data-i18n="mainMenu">メインメニュー</button>
      </div>
    </div>

    <!-- HUD -->
    <div id="hud">
      <div class="hud-item">
        <span class="hud-label" data-i18n="score">スコア</span>
        <span class="hud-value" id="score">0</span>
      </div>
      <div class="hud-item">
        <span class="hud-label" data-i18n="level">レベル</span>
        <span class="hud-value" id="level">1</span>
      </div>
      <div class="hud-item">
        <div id="lives"></div>
      </div>
    </div>

    <!-- Category indicator -->
    <div id="category-display">
      <div class="category-label" data-i18n="categoryLabel">カテゴリー</div>
      <div class="category-name hiragana" id="category-name">ひらがな</div>
    </div>

    <!-- Combo indicator -->
    <div id="combo" class="hidden">
      <div id="combo-count">0</div>
      <div id="combo-label">COMBO</div>
    </div>

    <!-- Level up notification -->
    <div id="level-up" class="hidden"></div>

    <!-- Game Area -->
    <div id="game-area"></div>

    <!-- Defense Line -->
    <div id="defense-line"></div>

    <!-- Input Area -->
    <div id="input-area">
      <div id="current-target"></div>
      <div id="input-wrapper">
        <input type="text" id="type-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="ローマ字でタイプ...">
      </div>
    </div>
  </div>

  <script>
    // Word lists by category and difficulty
    const wordLists = {
      hiragana: {
        1: [ // Basic vowels and simple syllables
          { japanese: 'あ', romaji: 'a' },
          { japanese: 'い', romaji: 'i' },
          { japanese: 'う', romaji: 'u' },
          { japanese: 'え', romaji: 'e' },
          { japanese: 'お', romaji: 'o' },
          { japanese: 'か', romaji: 'ka' },
          { japanese: 'き', romaji: 'ki' },
          { japanese: 'く', romaji: 'ku' },
          { japanese: 'け', romaji: 'ke' },
          { japanese: 'こ', romaji: 'ko' },
          { japanese: 'さ', romaji: 'sa' },
          { japanese: 'し', romaji: 'shi' },
          { japanese: 'す', romaji: 'su' },
          { japanese: 'せ', romaji: 'se' },
          { japanese: 'そ', romaji: 'so' },
        ],
        2: [ // More syllables
          { japanese: 'た', romaji: 'ta' },
          { japanese: 'ち', romaji: 'chi' },
          { japanese: 'つ', romaji: 'tsu' },
          { japanese: 'て', romaji: 'te' },
          { japanese: 'と', romaji: 'to' },
          { japanese: 'な', romaji: 'na' },
          { japanese: 'に', romaji: 'ni' },
          { japanese: 'ぬ', romaji: 'nu' },
          { japanese: 'ね', romaji: 'ne' },
          { japanese: 'の', romaji: 'no' },
          { japanese: 'は', romaji: 'ha' },
          { japanese: 'ひ', romaji: 'hi' },
          { japanese: 'ふ', romaji: 'fu' },
          { japanese: 'へ', romaji: 'he' },
          { japanese: 'ほ', romaji: 'ho' },
        ],
        3: [ // Simple words
          { japanese: 'あめ', romaji: 'ame' },
          { japanese: 'いぬ', romaji: 'inu' },
          { japanese: 'うみ', romaji: 'umi' },
          { japanese: 'えき', romaji: 'eki' },
          { japanese: 'かさ', romaji: 'kasa' },
          { japanese: 'くも', romaji: 'kumo' },
          { japanese: 'さけ', romaji: 'sake' },
          { japanese: 'そら', romaji: 'sora' },
          { japanese: 'ねこ', romaji: 'neko' },
          { japanese: 'はな', romaji: 'hana' },
          { japanese: 'やま', romaji: 'yama' },
          { japanese: 'かわ', romaji: 'kawa' },
          { japanese: 'もり', romaji: 'mori' },
          { japanese: 'ほし', romaji: 'hoshi' },
          { japanese: 'つき', romaji: 'tsuki' },
        ],
        4: [ // Longer words
          { japanese: 'さくら', romaji: 'sakura' },
          { japanese: 'おかし', romaji: 'okashi' },
          { japanese: 'あたま', romaji: 'atama' },
          { japanese: 'こころ', romaji: 'kokoro' },
          { japanese: 'ひかり', romaji: 'hikari' },
          { japanese: 'かぜ', romaji: 'kaze' },
          { japanese: 'みず', romaji: 'mizu' },
          { japanese: 'たべる', romaji: 'taberu' },
          { japanese: 'のむ', romaji: 'nomu' },
          { japanese: 'いく', romaji: 'iku' },
          { japanese: 'くる', romaji: 'kuru' },
          { japanese: 'みる', romaji: 'miru' },
          { japanese: 'きく', romaji: 'kiku' },
          { japanese: 'はなす', romaji: 'hanasu' },
          { japanese: 'よむ', romaji: 'yomu' },
        ],
        5: [ // Complex words
          { japanese: 'ありがとう', romaji: 'arigatou' },
          { japanese: 'おはよう', romaji: 'ohayou' },
          { japanese: 'こんにちは', romaji: 'konnichiha' },
          { japanese: 'さようなら', romaji: 'sayounara' },
          { japanese: 'おやすみ', romaji: 'oyasumi' },
          { japanese: 'すみません', romaji: 'sumimasen' },
          { japanese: 'ごめんなさい', romaji: 'gomennasai' },
          { japanese: 'たのしい', romaji: 'tanoshii' },
          { japanese: 'うれしい', romaji: 'ureshii' },
          { japanese: 'かなしい', romaji: 'kanashii' },
          { japanese: 'おいしい', romaji: 'oishii' },
          { japanese: 'つめたい', romaji: 'tsumetai' },
          { japanese: 'あたたかい', romaji: 'atatakai' },
          { japanese: 'すばらしい', romaji: 'subarashii' },
          { japanese: 'おもしろい', romaji: 'omoshiroi' },
        ],
      },
      katakana: {
        1: [ // Basic vowels
          { japanese: 'ア', romaji: 'a' },
          { japanese: 'イ', romaji: 'i' },
          { japanese: 'ウ', romaji: 'u' },
          { japanese: 'エ', romaji: 'e' },
          { japanese: 'オ', romaji: 'o' },
          { japanese: 'カ', romaji: 'ka' },
          { japanese: 'キ', romaji: 'ki' },
          { japanese: 'ク', romaji: 'ku' },
          { japanese: 'ケ', romaji: 'ke' },
          { japanese: 'コ', romaji: 'ko' },
          { japanese: 'サ', romaji: 'sa' },
          { japanese: 'シ', romaji: 'shi' },
          { japanese: 'ス', romaji: 'su' },
          { japanese: 'セ', romaji: 'se' },
          { japanese: 'ソ', romaji: 'so' },
        ],
        2: [ // More syllables
          { japanese: 'タ', romaji: 'ta' },
          { japanese: 'チ', romaji: 'chi' },
          { japanese: 'ツ', romaji: 'tsu' },
          { japanese: 'テ', romaji: 'te' },
          { japanese: 'ト', romaji: 'to' },
          { japanese: 'ナ', romaji: 'na' },
          { japanese: 'ニ', romaji: 'ni' },
          { japanese: 'ヌ', romaji: 'nu' },
          { japanese: 'ネ', romaji: 'ne' },
          { japanese: 'ノ', romaji: 'no' },
          { japanese: 'ハ', romaji: 'ha' },
          { japanese: 'ヒ', romaji: 'hi' },
          { japanese: 'フ', romaji: 'fu' },
          { japanese: 'ヘ', romaji: 'he' },
          { japanese: 'ホ', romaji: 'ho' },
        ],
        3: [ // Simple loanwords
          { japanese: 'ペン', romaji: 'pen' },
          { japanese: 'バス', romaji: 'basu' },
          { japanese: 'カメラ', romaji: 'kamera' },
          { japanese: 'テレビ', romaji: 'terebi' },
          { japanese: 'ラジオ', romaji: 'rajio' },
          { japanese: 'コーヒー', romaji: 'koohii' },
          { japanese: 'ビール', romaji: 'biiru' },
          { japanese: 'パン', romaji: 'pan' },
          { japanese: 'ケーキ', romaji: 'keeki' },
          { japanese: 'ミルク', romaji: 'miruku' },
          { japanese: 'タクシー', romaji: 'takushii' },
          { japanese: 'ホテル', romaji: 'hoteru' },
          { japanese: 'エレベーター', romaji: 'erebeetaa' },
          { japanese: 'スーパー', romaji: 'suupaa' },
          { japanese: 'デパート', romaji: 'depaato' },
        ],
        4: [ // Technology words
          { japanese: 'コンピューター', romaji: 'konpyuutaa' },
          { japanese: 'インターネット', romaji: 'intaanetto' },
          { japanese: 'スマートフォン', romaji: 'sumaatofon' },
          { japanese: 'ソフトウェア', romaji: 'sofutowea' },
          { japanese: 'プログラム', romaji: 'puroguramu' },
          { japanese: 'ゲーム', romaji: 'geemu' },
          { japanese: 'アプリ', romaji: 'apuri' },
          { japanese: 'データ', romaji: 'deeta' },
          { japanese: 'メール', romaji: 'meeru' },
          { japanese: 'サイト', romaji: 'saito' },
          { japanese: 'ブログ', romaji: 'burogu' },
          { japanese: 'チャット', romaji: 'chatto' },
          { japanese: 'クラウド', romaji: 'kuraudo' },
          { japanese: 'セキュリティ', romaji: 'sekyuriti' },
          { japanese: 'ネットワーク', romaji: 'nettowaaku' },
        ],
        5: [ // Complex loanwords
          { japanese: 'プレゼンテーション', romaji: 'purezenteeshan' },
          { japanese: 'コミュニケーション', romaji: 'komyunikeeshon' },
          { japanese: 'アルゴリズム', romaji: 'arugorizumu' },
          { japanese: 'インフラストラクチャー', romaji: 'infurasutorakuchaa' },
          { japanese: 'アーキテクチャー', romaji: 'aakitekuchaa' },
          { japanese: 'エンターテインメント', romaji: 'entaateinmento' },
          { japanese: 'ドキュメンテーション', romaji: 'dokyumenteeshan' },
          { japanese: 'オートメーション', romaji: 'ootomeeshon' },
          { japanese: 'トランスフォーメーション', romaji: 'toransufoomeeshon' },
          { japanese: 'インテリジェンス', romaji: 'interijensu' },
          { japanese: 'マネジメント', romaji: 'manejimento' },
          { japanese: 'デベロッパー', romaji: 'deberoppaa' },
          { japanese: 'エンジニアリング', romaji: 'enjiniaringu' },
          { japanese: 'プロフェッショナル', romaji: 'purofesshonaru' },
          { japanese: 'コラボレーション', romaji: 'koraboreeshan' },
        ],
      },
      kanji: {
        1: [ // Numbers and basic kanji
          { japanese: '一', romaji: 'ichi' },
          { japanese: '二', romaji: 'ni' },
          { japanese: '三', romaji: 'san' },
          { japanese: '四', romaji: 'yon' },
          { japanese: '五', romaji: 'go' },
          { japanese: '六', romaji: 'roku' },
          { japanese: '七', romaji: 'nana' },
          { japanese: '八', romaji: 'hachi' },
          { japanese: '九', romaji: 'kyuu' },
          { japanese: '十', romaji: 'juu' },
          { japanese: '百', romaji: 'hyaku' },
          { japanese: '千', romaji: 'sen' },
          { japanese: '万', romaji: 'man' },
          { japanese: '円', romaji: 'en' },
          { japanese: '年', romaji: 'nen' },
        ],
        2: [ // Nature and basic nouns
          { japanese: '日', romaji: 'hi' },
          { japanese: '月', romaji: 'tsuki' },
          { japanese: '火', romaji: 'hi' },
          { japanese: '水', romaji: 'mizu' },
          { japanese: '木', romaji: 'ki' },
          { japanese: '金', romaji: 'kin' },
          { japanese: '土', romaji: 'tsuchi' },
          { japanese: '山', romaji: 'yama' },
          { japanese: '川', romaji: 'kawa' },
          { japanese: '海', romaji: 'umi' },
          { japanese: '空', romaji: 'sora' },
          { japanese: '花', romaji: 'hana' },
          { japanese: '雨', romaji: 'ame' },
          { japanese: '風', romaji: 'kaze' },
          { japanese: '雪', romaji: 'yuki' },
        ],
        3: [ // Common words
          { japanese: '日本', romaji: 'nihon' },
          { japanese: '東京', romaji: 'toukyou' },
          { japanese: '大阪', romaji: 'oosaka' },
          { japanese: '京都', romaji: 'kyouto' },
          { japanese: '人', romaji: 'hito' },
          { japanese: '男', romaji: 'otoko' },
          { japanese: '女', romaji: 'onna' },
          { japanese: '子供', romaji: 'kodomo' },
          { japanese: '友達', romaji: 'tomodachi' },
          { japanese: '先生', romaji: 'sensei' },
          { japanese: '学生', romaji: 'gakusei' },
          { japanese: '会社', romaji: 'kaisha' },
          { japanese: '仕事', romaji: 'shigoto' },
          { japanese: '時間', romaji: 'jikan' },
          { japanese: '今日', romaji: 'kyou' },
        ],
        4: [ // Verbs and adjectives
          { japanese: '食べる', romaji: 'taberu' },
          { japanese: '飲む', romaji: 'nomu' },
          { japanese: '見る', romaji: 'miru' },
          { japanese: '聞く', romaji: 'kiku' },
          { japanese: '読む', romaji: 'yomu' },
          { japanese: '書く', romaji: 'kaku' },
          { japanese: '話す', romaji: 'hanasu' },
          { japanese: '歩く', romaji: 'aruku' },
          { japanese: '走る', romaji: 'hashiru' },
          { japanese: '大きい', romaji: 'ookii' },
          { japanese: '小さい', romaji: 'chiisai' },
          { japanese: '新しい', romaji: 'atarashii' },
          { japanese: '古い', romaji: 'furui' },
          { japanese: '高い', romaji: 'takai' },
          { japanese: '安い', romaji: 'yasui' },
        ],
        5: [ // Complex kanji compounds
          { japanese: '電話', romaji: 'denwa' },
          { japanese: '電車', romaji: 'densha' },
          { japanese: '飛行機', romaji: 'hikouki' },
          { japanese: '自動車', romaji: 'jidousha' },
          { japanese: '図書館', romaji: 'toshokan' },
          { japanese: '病院', romaji: 'byouin' },
          { japanese: '銀行', romaji: 'ginkou' },
          { japanese: '郵便局', romaji: 'yuubinkyoku' },
          { japanese: '大学', romaji: 'daigaku' },
          { japanese: '勉強', romaji: 'benkyou' },
          { japanese: '練習', romaji: 'renshuu' },
          { japanese: '経験', romaji: 'keiken' },
          { japanese: '問題', romaji: 'mondai' },
          { japanese: '質問', romaji: 'shitsumon' },
          { japanese: '説明', romaji: 'setsumei' },
        ],
      },
    };

    // Translations
    const i18n = {
      en: {
        title: 'Type Invaders',
        subtitle: 'Japanese Edition',
        description: 'Type romaji to destroy Japanese words! Stop them before they reach the defense line.',
        hiragana: 'Hiragana',
        katakana: 'Katakana',
        kanji: 'Kanji',
        difficulty: 'Difficulty',
        level1: 'Level 1',
        level2: 'Level 2',
        level3: 'Level 3',
        level4: 'Level 4',
        level5: 'Level 5',
        howToPlay: 'How to Play',
        instruction1: 'Read Japanese and type romaji (romaji hidden at first)',
        instruction2: 'Words automatically match as you type',
        instruction3: 'Complete the word to destroy it',
        instruction4: "Don't let words reach the red line!",
        instruction5: 'Build combos for bonus points',
        instruction6: '⚠️ Half points if romaji is revealed!',
        startGame: 'Start Game',
        gameOver: 'Game Over',
        finalScore: 'Final Score',
        level: 'Level',
        wordsDestroyed: 'Words Destroyed',
        maxCombo: 'Max Combo',
        playAgain: 'Play Again',
        mainMenu: 'Main Menu',
        score: 'Score',
        categoryLabel: 'Category',
        levelUp: 'Level Up!',
        targeting: 'Target:'
      },
      pt: {
        title: 'Type Invaders',
        subtitle: 'Edição Japonesa',
        description: 'Digite romaji para destruir palavras japonesas! Pare-as antes que cheguem à linha de defesa.',
        hiragana: 'Hiragana',
        katakana: 'Katakana',
        kanji: 'Kanji',
        difficulty: 'Dificuldade',
        level1: 'Nível 1',
        level2: 'Nível 2',
        level3: 'Nível 3',
        level4: 'Nível 4',
        level5: 'Nível 5',
        howToPlay: 'Como Jogar',
        instruction1: 'Leia japonês e digite romaji (romaji oculto no início)',
        instruction2: 'Palavras combinam automaticamente ao digitar',
        instruction3: 'Complete a palavra para destruí-la',
        instruction4: 'Não deixe palavras chegarem à linha vermelha!',
        instruction5: 'Faça combos para pontos bônus',
        instruction6: '⚠️ Metade dos pontos se o romaji aparecer!',
        startGame: 'Iniciar Jogo',
        gameOver: 'Fim de Jogo',
        finalScore: 'Pontuação Final',
        level: 'Nível',
        wordsDestroyed: 'Palavras Destruídas',
        maxCombo: 'Combo Máximo',
        playAgain: 'Jogar Novamente',
        mainMenu: 'Menu Principal',
        score: 'Pontos',
        categoryLabel: 'Categoria',
        levelUp: 'Subiu de Nível!',
        targeting: 'Alvo:'
      },
      ja: {
        title: 'タイプインベーダー',
        subtitle: '日本語版',
        description: 'ローマ字をタイプして日本語の単語を撃破！防衛ラインに到達する前に倒そう。',
        hiragana: 'ひらがな',
        katakana: 'カタカナ',
        kanji: '漢字',
        difficulty: '難易度',
        level1: 'レベル1',
        level2: 'レベル2',
        level3: 'レベル3',
        level4: 'レベル4',
        level5: 'レベル5',
        howToPlay: '遊び方',
        instruction1: '日本語を見てローマ字をタイプ（最初はローマ字非表示）',
        instruction2: 'タイプすると自動的に単語がマッチ',
        instruction3: '単語を完成させて破壊',
        instruction4: '赤いラインに到達させないで！',
        instruction5: 'コンボでボーナスポイント',
        instruction6: '⚠️ ローマ字が表示されると得点が半分に！',
        startGame: 'ゲーム開始',
        gameOver: 'ゲームオーバー',
        finalScore: '最終スコア',
        level: 'レベル',
        wordsDestroyed: '破壊した単語',
        maxCombo: '最大コンボ',
        playAgain: 'もう一度',
        mainMenu: 'メインメニュー',
        score: 'スコア',
        categoryLabel: 'カテゴリー',
        levelUp: 'レベルアップ！',
        targeting: 'ターゲット:'
      }
    };

    // Game state
    let currentLang = 'ja';
    let currentCategory = 'hiragana';
    let startDifficulty = 1;
    let gameRunning = false;
    let score = 0;
    let level = 1;
    let lives = 3;
    let words = [];
    let targetWord = null;
    let combo = 0;
    let maxCombo = 0;
    let wordsDestroyed = 0;
    let lastFrameTime = 0;
    let spawnTimer = 0;
    let animationId = null;

    // Game settings (adjusted by level)
    const baseSettings = {
      spawnInterval: 3500,
      fallSpeed: 25,
      maxWords: 3
    };

    // DOM elements
    const gameContainer = document.getElementById('game-container');
    const gameArea = document.getElementById('game-area');
    const typeInput = document.getElementById('type-input');
    const scoreDisplay = document.getElementById('score');
    const levelDisplay = document.getElementById('level');
    const livesDisplay = document.getElementById('lives');
    const comboDisplay = document.getElementById('combo');
    const comboCount = document.getElementById('combo-count');
    const categoryNameDisplay = document.getElementById('category-name');
    const levelUpDisplay = document.getElementById('level-up');
    const currentTargetDisplay = document.getElementById('current-target');
    const startScreen = document.getElementById('start-screen');
    const gameoverScreen = document.getElementById('gameover-screen');

    // Initialize
    function init() {
      setupLanguage();
      setupEventListeners();
      updateLives();
    }

    // Language setup
    function setupLanguage() {
      const savedLang = localStorage.getItem('type-invaders-jp-lang') || 'ja';
      setLanguage(savedLang);
    }

    function setLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('type-invaders-jp-lang', lang);

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18n[lang] && i18n[lang][key]) {
          el.textContent = i18n[lang][key];
        }
      });

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      // Update input placeholder
      const placeholders = {
        en: 'Type romaji...',
        pt: 'Digite romaji...',
        ja: 'ローマ字でタイプ...'
      };
      typeInput.placeholder = placeholders[lang] || placeholders.ja;
    }

    // Event listeners
    function setupEventListeners() {
      // Language buttons
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
      });

      // Category buttons
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentCategory = btn.dataset.category;
        });
      });

      // Difficulty buttons
      document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          startDifficulty = parseInt(btn.dataset.difficulty);
        });
      });

      // Start button
      document.getElementById('start-btn').addEventListener('click', startGame);
      document.getElementById('restart-btn').addEventListener('click', startGame);
      document.getElementById('menu-btn').addEventListener('click', showMainMenu);

      // Input handling
      typeInput.addEventListener('input', handleInput);
      typeInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          checkWordComplete();
        }
      });

      // Prevent input from losing focus
      document.addEventListener('click', () => {
        if (gameRunning) {
          typeInput.focus();
        }
      });
    }

    // Game control
    function startGame() {
      // Reset state
      score = 0;
      level = startDifficulty;
      lives = 3;
      words = [];
      targetWord = null;
      combo = 0;
      maxCombo = 0;
      wordsDestroyed = 0;
      spawnTimer = 0;
      lastFrameTime = performance.now();

      // Clear game area
      gameArea.innerHTML = '';

      // Update displays
      updateScore();
      updateLevel();
      updateLives();
      updateCombo();
      updateCategoryDisplay();

      // Hide screens
      startScreen.classList.add('hidden');
      gameoverScreen.classList.add('hidden');

      // Start game
      gameRunning = true;
      typeInput.value = '';
      typeInput.focus();
      currentTargetDisplay.textContent = '';

      // Start game loop
      if (animationId) cancelAnimationFrame(animationId);
      gameLoop(performance.now());
    }

    function showMainMenu() {
      gameRunning = false;
      if (animationId) cancelAnimationFrame(animationId);
      gameArea.innerHTML = '';
      startScreen.classList.remove('hidden');
      gameoverScreen.classList.add('hidden');
    }

    function endGame() {
      gameRunning = false;
      if (animationId) cancelAnimationFrame(animationId);

      // Update final stats
      document.getElementById('final-score').textContent = score;
      document.getElementById('final-level').textContent = level;
      document.getElementById('final-words').textContent = wordsDestroyed;
      document.getElementById('final-combo').textContent = maxCombo;

      // Show game over screen
      gameoverScreen.classList.remove('hidden');
    }

    // Game loop
    function gameLoop(timestamp) {
      if (!gameRunning) return;

      const deltaTime = timestamp - lastFrameTime;
      lastFrameTime = timestamp;

      // Spawn words
      spawnTimer += deltaTime;
      const spawnInterval = getSpawnInterval();
      if (spawnTimer >= spawnInterval && words.length < getMaxWords()) {
        spawnWord();
        spawnTimer = 0;
      }

      // Update words
      updateWords(deltaTime);

      // Request next frame
      animationId = requestAnimationFrame(gameLoop);
    }

    // Word spawning
    function spawnWord() {
      const wordData = getRandomWord();
      const word = {
        japanese: wordData.japanese,
        romaji: wordData.romaji,
        typed: '',
        x: Math.random() * (gameArea.clientWidth - 200) + 50,
        y: -80,
        speed: getFallSpeed(),
        category: currentCategory,
        romajiRevealed: false,
        element: null
      };

      // Create DOM element
      const el = document.createElement('div');
      el.className = `word ${currentCategory}`;
      el.innerHTML = `
        <div class="japanese">${wordData.japanese}</div>
        <div class="romaji">
          <span class="typed"></span><span class="remaining">${wordData.romaji}</span>
        </div>
      `;
      el.style.left = word.x + 'px';
      el.style.top = word.y + 'px';
      gameArea.appendChild(el);
      word.element = el;

      words.push(word);
    }

    function getRandomWord() {
      // Get words from current difficulty level and below
      let pool = [];
      for (let i = 1; i <= level && i <= 5; i++) {
        if (wordLists[currentCategory][i]) {
          pool = pool.concat(wordLists[currentCategory][i]);
        }
      }

      // Favor higher difficulty words as level increases
      if (level >= 3 && wordLists[currentCategory][Math.min(level, 5)]) {
        pool = pool.concat(wordLists[currentCategory][Math.min(level, 5)]);
      }

      // Avoid duplicate words on screen
      const activeRomaji = words.map(w => w.romaji);
      const available = pool.filter(w => !activeRomaji.includes(w.romaji));
      
      if (available.length === 0) return pool[Math.floor(Math.random() * pool.length)];
      return available[Math.floor(Math.random() * available.length)];
    }

    // Level-based settings
    function getSpawnInterval() {
      const min = 1000;
      const base = baseSettings.spawnInterval;
      return Math.max(min, base - (level - 1) * 300);
    }

    function getFallSpeed() {
      const base = baseSettings.fallSpeed;
      const variance = 8;
      return base + (level - 1) * 6 + (Math.random() * variance - variance / 2);
    }

    function getMaxWords() {
      return Math.min(7, baseSettings.maxWords + Math.floor(level / 2));
    }

    // Word updates
    function updateWords(deltaTime) {
      const defenseY = gameArea.clientHeight;
      const romajiThreshold = defenseY * 0.7; // Show romaji after 70% of the screen

      for (let i = words.length - 1; i >= 0; i--) {
        const word = words[i];
        
        // Move word down
        word.y += word.speed * (deltaTime / 1000);
        word.element.style.top = word.y + 'px';

        // Check if romaji should be revealed (past 70% of screen)
        if (!word.romajiRevealed && word.y >= romajiThreshold) {
          word.romajiRevealed = true;
          word.element.classList.add('show-romaji');
        }

        // Check if word reached defense line
        if (word.y >= defenseY) {
          destroyWord(i, false);
          loseLife();
        }
      }
    }

    function destroyWord(index, success) {
      const word = words[index];
      
      if (success) {
        // Create explosion effect
        createExplosion(word.x + word.element.offsetWidth / 2, word.y + word.element.offsetHeight / 2, word.category);
        
        // Award points - reduced by 50% if romaji was revealed
        const basePoints = word.romaji.length * 15 * (1 + combo * 0.1);
        const pointMultiplier = word.romajiRevealed ? 0.5 : 1.0;
        const points = basePoints * pointMultiplier;
        addScore(Math.floor(points));
        
        // Increment combo and words destroyed
        combo++;
        maxCombo = Math.max(maxCombo, combo);
        wordsDestroyed++;
        updateCombo();
        
        // Check for level up
        if (wordsDestroyed % 8 === 0 && level < 5) {
          levelUp();
        }
      } else {
        // Reset combo on miss
        combo = 0;
        updateCombo();
      }

      // Remove word
      word.element.remove();
      words.splice(index, 1);

      // Clear target if it was the destroyed word
      if (targetWord === word) {
        targetWord = null;
        currentTargetDisplay.textContent = '';
        typeInput.value = '';
      }
    }

    function createExplosion(x, y, category) {
      const explosion = document.createElement('div');
      explosion.className = 'explosion';
      explosion.style.left = x + 'px';
      explosion.style.top = y + 'px';

      const colors = {
        hiragana: '#ff6b9d',
        katakana: '#00aaff',
        kanji: '#ffcc00'
      };
      const color = colors[category] || '#ff6b9d';

      // Create particles
      for (let i = 0; i < 12; i++) {
        const particle = document.createElement('div');
        particle.className = 'explosion-particle';
        particle.style.background = color;
        particle.style.boxShadow = `0 0 10px ${color}`;
        const angle = (i / 12) * Math.PI * 2;
        const distance = 30 + Math.random() * 20;
        particle.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px)`;
        explosion.appendChild(particle);
      }

      gameArea.appendChild(explosion);
      setTimeout(() => explosion.remove(), 500);
    }

    // Input handling
    function handleInput() {
      const typed = typeInput.value.toLowerCase();
      
      if (typed === '') {
        // Clear target
        if (targetWord) {
          targetWord.element.classList.remove('targeted');
          targetWord.typed = '';
          updateWordDisplay(targetWord);
        }
        targetWord = null;
        currentTargetDisplay.textContent = '';
        return;
      }

      // Find matching word
      let bestMatch = null;
      let bestMatchLength = 0;

      for (const word of words) {
        if (word.romaji.startsWith(typed) && typed.length > bestMatchLength) {
          bestMatch = word;
          bestMatchLength = typed.length;
        }
      }

      // Update target
      if (bestMatch !== targetWord) {
        if (targetWord) {
          targetWord.element.classList.remove('targeted');
          targetWord.typed = '';
          updateWordDisplay(targetWord);
        }
        targetWord = bestMatch;
        if (targetWord) {
          targetWord.element.classList.add('targeted');
        }
      }

      if (targetWord) {
        targetWord.typed = typed;
        updateWordDisplay(targetWord);
        // Only show romaji in target display if it's been revealed on screen
        if (targetWord.romajiRevealed) {
          currentTargetDisplay.textContent = `${i18n[currentLang].targeting} ${targetWord.japanese} (${targetWord.romaji})`;
        } else {
          currentTargetDisplay.textContent = `${i18n[currentLang].targeting} ${targetWord.japanese}`;
        }
        typeInput.classList.remove('error');

        // Check if word is complete
        if (typed === targetWord.romaji) {
          const index = words.indexOf(targetWord);
          if (index !== -1) {
            destroyWord(index, true);
            typeInput.value = '';
          }
        }
      } else if (typed.length > 0) {
        // No matching word - show error
        typeInput.classList.add('error');
        setTimeout(() => typeInput.classList.remove('error'), 300);
        currentTargetDisplay.textContent = '';
      }
    }

    function checkWordComplete() {
      if (targetWord && typeInput.value.toLowerCase() === targetWord.romaji) {
        const index = words.indexOf(targetWord);
        if (index !== -1) {
          destroyWord(index, true);
          typeInput.value = '';
        }
      }
    }

    function updateWordDisplay(word) {
      const typedSpan = word.element.querySelector('.typed');
      const remainingSpan = word.element.querySelector('.remaining');
      // Only show typed progress in romaji when romaji is revealed
      if (word.romajiRevealed) {
        typedSpan.textContent = word.typed;
        remainingSpan.textContent = word.romaji.slice(word.typed.length);
      } else {
        // When romaji is hidden, show nothing (it's hidden by CSS anyway)
        typedSpan.textContent = '';
        remainingSpan.textContent = word.romaji;
      }
    }

    // Life management
    function loseLife() {
      lives--;
      updateLives();
      
      // Visual feedback
      gameContainer.style.animation = 'none';
      gameContainer.offsetHeight; // Trigger reflow
      gameContainer.style.animation = 'shake 0.3s ease';

      if (lives <= 0) {
        endGame();
      }
    }

    function updateLives() {
      livesDisplay.innerHTML = '';
      for (let i = 0; i < 3; i++) {
        const life = document.createElement('div');
        life.className = 'life' + (i >= lives ? ' lost' : '');
        livesDisplay.appendChild(life);
      }
    }

    // Score and level
    function addScore(points) {
      score += points;
      updateScore();
    }

    function updateScore() {
      scoreDisplay.textContent = score.toLocaleString();
    }

    function levelUp() {
      level++;
      updateLevel();

      // Show level up notification
      levelUpDisplay.textContent = `${i18n[currentLang].levelUp} ${level}`;
      levelUpDisplay.classList.remove('hidden');
      setTimeout(() => levelUpDisplay.classList.add('hidden'), 1500);
    }

    function updateLevel() {
      levelDisplay.textContent = level;
    }

    function updateCategoryDisplay() {
      const categoryNames = {
        hiragana: i18n[currentLang].hiragana,
        katakana: i18n[currentLang].katakana,
        kanji: i18n[currentLang].kanji
      };
      categoryNameDisplay.textContent = categoryNames[currentCategory];
      categoryNameDisplay.className = `category-name ${currentCategory}`;
    }

    function updateCombo() {
      if (combo >= 2) {
        comboDisplay.classList.remove('hidden');
        comboCount.textContent = combo + 'x';
      } else {
        comboDisplay.classList.add('hidden');
      }
    }

    // Start
    init();
  </script>
</body>
</html>
